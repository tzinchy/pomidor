2025-02-11 12:06:49,942 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-11 12:06:49,942 - INFO - Params: None
2025-02-11 12:06:49,944 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-11 12:06:49,944 - INFO - Params: None
2025-02-11 12:06:57,862 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 12:06:57,862 - INFO - РќР°С‡Р°Р»Рѕ Р·Р°РіСЂСѓР·РєРё С„Р°Р№Р»Р°
2025-02-11 12:06:57,862 - INFO - Р¤Р°Р№Р» РґР»СЏ Р·Р°РіСЂСѓР·РєРё: ./uploads/container_46.xlsx
2025-02-11 12:06:57,862 - INFO - Р¤Р°Р№Р» РїРѕРґРіРѕС‚РѕРІР»РµРЅ: {'file': ('container_46.xlsx', <_io.BufferedReader name='./uploads/container_46.xlsx'>, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')}
2025-02-11 12:06:57,880 - ERROR - РџСЂРѕРёР·РѕС€Р»Р° РѕС€РёР±РєР°: HTTPConnectionPool(host='webspd.mlc.gov', port=80): Max retries exceeded with url: /SpdRemote/spdremotemvc/MassStart/Parse (Caused by NameResolutionError("<urllib3.connection.HTTPConnection object at 0x787bb6026b60>: Failed to resolve 'webspd.mlc.gov' ([Errno -5] No address associated with hostname)"))
2025-02-11 14:10:50,051 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:11:14,343 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:11:33,113 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:11:46,398 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:13:15,916 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:14:59,871 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:15:26,384 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:17:07,660 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:21:04,342 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:22:06,282 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:23:46,092 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:24:10,693 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
2025-02-11 14:27:00,721 - INFO - Excel С„Р°Р№Р» './uploads/container_46.xlsx' СЃРѕР·РґР°РЅ.
<<<<<<< HEAD
2025-02-11 15:02:12,986 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 15:02:12,987 - INFO - Params: {}
2025-02-11 15:02:16,128 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-11 15:02:16,129 - INFO - Params: None
2025-02-11 15:02:16,131 - INFO - Executing query: WITH needs_with_row AS (
=======
2025-02-12 19:09:13,935 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-12 19:09:13,935 - INFO - Params: {}
2025-02-12 19:09:14,326 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedTableError'>: отношение "old_apart" не существует
[SQL: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 19:09:50,907 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-12 19:09:50,907 - INFO - Params: {}
2025-02-12 19:09:59,722 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 19:09:59,722 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-12 19:10:05,789 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 19:10:05,789 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-12 19:10:16,511 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND room_count IN (:room_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 19:10:16,512 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1}
2025-02-12 19:10:16,534 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN ($1) AND room_count IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Гражданская 3-я ул., д.21', 1)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 19:14:09,386 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND room_count IN (:room_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 19:14:09,386 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1}
2025-02-12 19:14:09,420 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedTableError'>: отношение "family_structure" не существует
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN ($1) AND room_count IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Гражданская 3-я ул., д.21', 1)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:31:49,618 - INFO - Executing query: WITH needs_with_row AS (
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-11 15:02:16,132 - INFO - Params: None
2025-02-11 15:07:32,849 - INFO - Excel файл './uploads\container_46.xlsx' создан.
2025-02-11 15:10:22,707 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 15:10:22,708 - INFO - Params: {}
2025-02-11 15:10:25,318 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 15:10:25,318 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-11 15:10:25,726 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 15:10:25,726 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-11 15:10:25,728 - INFO - Executing query: 
=======
=======
>>>>>>> f30caea (big query changes)
2025-02-12 20:31:49,618 - INFO - Params: None
2025-02-12 20:31:50,063 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:34:14,430 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-12 20:34:14,430 - INFO - Params: {}
2025-02-12 20:34:15,433 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-12 20:34:15,433 - INFO - Params: {}
2025-02-12 20:35:21,645 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 20:35:21,646 - INFO - Params: None
2025-02-12 20:35:21,666 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:35:21,995 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-12 20:35:21,995 - INFO - Params: {}
2025-02-12 20:35:22,729 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 20:35:22,729 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-12 20:35:23,306 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 20:35:23,306 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-12 20:35:23,384 - INFO - Executing query: 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
<<<<<<< HEAD
<<<<<<< HEAD
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
=======
=======
>>>>>>> f30caea (big query changes)
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-11 15:10:25,728 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-11 15:46:47,720 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 15:46:47,721 - INFO - Params: {}
2025-02-11 15:46:54,834 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 15:46:54,834 - INFO - Params: {}
2025-02-11 15:46:56,697 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 15:46:56,698 - INFO - Params: {}
2025-02-11 15:46:59,918 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 15:46:59,918 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 15:47:00,406 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 15:47:00,406 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 15:47:00,408 - INFO - Executing query: 
=======
2025-02-12 20:35:23,384 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-12 20:35:23,732 - INFO - Executing query: 
>>>>>>> demo-dev
=======
2025-02-12 20:35:23,384 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-12 20:35:23,732 - INFO - Executing query: 
>>>>>>> f30caea (big query changes)
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
<<<<<<< HEAD
<<<<<<< HEAD
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 15:47:00,408 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 15:47:06,665 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-11 15:47:13,770 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-11 15:59:42,431 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 15:59:42,432 - INFO - Params: {}
2025-02-11 15:59:43,230 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 15:59:43,230 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 15:59:43,630 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 15:59:43,630 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 15:59:43,635 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 15:59:43,636 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:00:41,163 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:00:41,163 - INFO - Params: {}
2025-02-11 16:00:42,686 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:00:42,686 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 16:00:43,702 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:00:43,702 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:00:43,704 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:00:43,704 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:00:59,263 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:00:59,263 - INFO - Params: {}
2025-02-11 16:01:03,088 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:01:03,088 - INFO - Params: {}
2025-02-11 16:01:04,462 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:01:04,462 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 16:01:05,182 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:01:05,182 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:01:05,183 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:01:05,183 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:01:22,797 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:01:22,797 - INFO - Params: {}
2025-02-11 16:01:25,022 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:01:25,022 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 16:01:25,389 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:01:25,390 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:01:25,391 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:01:25,391 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:01:35,649 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:01:35,650 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-11 16:01:36,325 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:01:36,325 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-11 16:01:36,326 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:01:36,326 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-11 16:03:22,143 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:03:22,143 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:03:22,144 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:03:22,144 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:03:26,199 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:03:26,199 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-11 16:03:26,201 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:03:26,201 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-11 16:03:29,327 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:03:29,327 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:03:29,328 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:03:29,328 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:03:51,994 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:03:51,994 - INFO - Params: {}
2025-02-11 16:04:02,029 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:04:02,029 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 16:04:02,601 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:04:02,601 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:04:02,602 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:04:02,602 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:11:55,959 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:11:55,959 - INFO - Params: {}
2025-02-11 16:11:55,960 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0, :municipal_1) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:11:55,961 - INFO - Params: {'municipal_0': 'Восточное Измайлово', 'municipal_1': 'Алтуфьевский'}
2025-02-11 16:12:17,695 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:12:17,695 - INFO - Params: {}
2025-02-11 16:16:16,906 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:16:16,906 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-11 16:16:17,363 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:16:17,363 - INFO - Params: {'municipal_districts_0': 'Аэропорт'}
2025-02-11 16:16:17,365 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:16:17,365 - INFO - Params: {'municipal_0': 'Аэропорт'}
2025-02-11 16:16:19,451 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:16:19,451 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 16:16:19,971 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:16:19,971 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:16:19,972 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:16:19,972 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:18:32,185 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:18:32,186 - INFO - Params: {}
2025-02-11 16:18:33,202 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:18:33,203 - INFO - Params: {}
2025-02-11 16:18:36,268 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:18:36,268 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 16:18:36,843 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:18:36,843 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:18:36,844 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:18:36,845 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:18:40,032 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864997
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:18:40,032 - INFO - Params: {'apart_id': 864997}
2025-02-11 16:18:44,885 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864997
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:18:44,885 - INFO - Params: {'apart_id': 864997}
2025-02-11 16:30:54,434 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864918
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:30:54,435 - INFO - Params: {'apart_id': 864918}
2025-02-11 16:32:04,924 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:32:04,925 - INFO - Params: {}
2025-02-11 16:32:07,225 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:32:07,225 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-11 16:32:08,072 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:32:08,072 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 16:32:08,584 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:32:08,585 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:32:08,586 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:32:08,586 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:32:50,675 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:32:50,675 - INFO - Params: {}
2025-02-11 16:32:53,849 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:32:53,849 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 16:32:54,273 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:32:54,273 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:32:54,274 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:32:54,274 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:34:52,987 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:34:52,988 - INFO - Params: {}
2025-02-11 16:34:55,162 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:34:55,162 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 16:34:56,017 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:34:56,018 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:34:56,019 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:34:56,019 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:39:36,400 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:39:36,400 - INFO - Params: {}
2025-02-11 16:39:38,563 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:39:38,563 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 16:39:39,042 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:39:39,042 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:39:39,043 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:39:39,043 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:40:18,181 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:40:18,181 - INFO - Params: {}
2025-02-11 16:40:19,540 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:40:19,540 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-11 16:40:19,971 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:40:19,971 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-11 16:40:19,972 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:40:19,972 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-11 16:40:52,846 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:40:52,846 - INFO - Params: {}
2025-02-11 16:40:53,275 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:40:53,276 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-11 16:40:53,659 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:40:53,659 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-11 16:40:53,661 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:40:53,661 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-11 16:41:25,208 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:41:25,208 - INFO - Params: {}
2025-02-11 16:41:25,612 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:41:25,612 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-11 16:41:26,035 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:41:26,035 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-11 16:41:26,037 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:41:26,037 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-11 16:42:16,177 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:42:16,177 - INFO - Params: {}
2025-02-11 16:42:16,893 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:42:16,893 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-11 16:42:17,283 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:42:17,283 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-11 16:42:17,285 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:42:17,285 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-11 16:42:49,483 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:42:49,483 - INFO - Params: {}
2025-02-11 16:42:49,910 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:42:49,910 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-11 16:42:50,316 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:42:50,316 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-11 16:42:50,317 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:42:50,318 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-11 16:42:50,772 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
=======
=======
>>>>>>> f30caea (big query changes)
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-11 16:42:50,772 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-11 16:44:43,100 - INFO - Executing query: 
=======
2025-02-12 20:35:23,732 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-12 20:35:25,316 - INFO - Executing query: 
>>>>>>> demo-dev
=======
2025-02-12 20:35:23,732 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-12 20:35:25,316 - INFO - Executing query: 
>>>>>>> f30caea (big query changes)
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
<<<<<<< HEAD
<<<<<<< HEAD
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:44:43,100 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-11 16:44:43,101 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:44:43,102 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-11 16:44:45,268 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:44:45,268 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 16:44:45,829 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:44:45,829 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:44:45,830 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:44:45,830 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:50:31,058 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:50:31,058 - INFO - Params: {}
2025-02-11 16:50:34,447 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:50:34,447 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-11 16:50:35,479 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:50:35,479 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-11 16:50:35,480 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:50:35,480 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-11 16:50:36,582 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:50:36,583 - INFO - Params: {'apart_id': 720420}
2025-02-11 16:50:40,230 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:50:40,230 - INFO - Params: {'apart_id': 720420}
2025-02-11 16:50:42,551 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 768980
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:50:42,551 - INFO - Params: {'apart_id': 768980}
2025-02-11 16:50:45,063 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:50:45,063 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-11 16:50:45,073 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:50:45,073 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-11 16:50:47,598 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:50:47,598 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 16:50:48,142 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:50:48,142 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:50:48,143 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:50:48,143 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:51:03,581 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-11 16:51:03,582 - INFO - Params: {}
2025-02-11 16:51:51,264 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-11 16:51:51,264 - INFO - Params: {'district_0': 'СВАО'}
2025-02-11 16:51:51,815 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-11 16:51:51,815 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-11 16:51:51,831 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-11 16:51:51,831 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-11 16:51:54,326 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:51:54,326 - INFO - Params: {'apart_id': 864587}
2025-02-11 16:52:34,001 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:52:34,001 - INFO - Params: {'apart_id': 864973}
2025-02-11 16:52:36,623 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864918
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:52:36,624 - INFO - Params: {'apart_id': 864918}
2025-02-11 16:53:23,084 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864915
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:53:23,084 - INFO - Params: {'apart_id': 864915}
2025-02-11 16:53:33,135 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864997
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:53:33,135 - INFO - Params: {'apart_id': 864997}
2025-02-11 16:53:34,624 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:53:34,624 - INFO - Params: {'apart_id': 865013}
2025-02-11 16:53:35,951 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:53:35,951 - INFO - Params: {'apart_id': 864958}
2025-02-11 16:53:37,448 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:53:37,448 - INFO - Params: {'apart_id': 864877}
2025-02-11 16:53:39,271 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:53:39,271 - INFO - Params: {'apart_id': 864919}
2025-02-11 16:53:42,319 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-11 16:53:42,319 - INFO - Params: {'apart_id': 864877}
2025-02-12 08:04:13,969 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 08:04:13,971 - INFO - Params: {}
2025-02-12 08:04:18,128 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 08:04:18,129 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 08:04:18,729 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 08:04:18,729 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 08:04:18,731 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 08:04:18,731 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 08:04:22,440 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:04:22,441 - INFO - Params: {'apart_id': 864587}
2025-02-12 08:06:17,394 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 08:06:17,394 - INFO - Params: {}
2025-02-12 08:06:19,095 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 08:06:19,095 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 08:06:19,559 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 08:06:19,559 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 08:06:19,560 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 08:06:19,560 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 08:07:55,994 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 08:07:55,995 - INFO - Params: {}
2025-02-12 08:07:59,741 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 08:07:59,741 - INFO - Params: {}
2025-02-12 08:08:01,775 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 08:08:01,776 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 08:08:02,263 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 08:08:02,263 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 08:08:02,264 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 08:08:02,264 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 08:08:03,734 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:03,734 - INFO - Params: {'apart_id': 864587}
2025-02-12 08:08:09,429 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:09,429 - INFO - Params: {'apart_id': 864919}
2025-02-12 08:08:10,519 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:10,519 - INFO - Params: {'apart_id': 864973}
2025-02-12 08:08:12,326 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:12,326 - INFO - Params: {'apart_id': 864973}
2025-02-12 08:08:13,694 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:13,694 - INFO - Params: {'apart_id': 864973}
2025-02-12 08:08:14,961 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-12 08:08:14,961 - INFO - Params: {}
2025-02-12 08:08:15,560 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 08:08:15,560 - INFO - Params: {}
2025-02-12 08:08:16,669 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 08:08:16,669 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 08:08:17,151 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 08:08:17,151 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 08:08:17,152 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 08:08:17,152 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 08:08:18,509 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:18,509 - INFO - Params: {'apart_id': 864587}
2025-02-12 08:08:19,758 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:19,758 - INFO - Params: {'apart_id': 864877}
2025-02-12 08:08:20,606 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 08:08:20,606 - INFO - Params: {'apart_id': 864880}
2025-02-12 09:10:26,502 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:10:26,502 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:10:45,469 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 09:10:45,559 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:10:45,559 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:17:21,341 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:17:21,341 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:17:23,176 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:17:23,176 - INFO - Params: {'apart_id': 864973}
2025-02-12 09:17:23,760 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:17:23,760 - INFO - Params: {'apart_id': 864877}
2025-02-12 09:17:47,824 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:17:47,824 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:18:38,899 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:38,899 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:18:40,970 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:40,971 - INFO - Params: {'apart_id': 864919}
2025-02-12 09:18:45,746 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:45,746 - INFO - Params: {'apart_id': 864877}
2025-02-12 09:18:47,194 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:47,194 - INFO - Params: {'apart_id': 864880}
2025-02-12 09:18:47,746 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:47,746 - INFO - Params: {'apart_id': 865013}
2025-02-12 09:18:48,194 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864933
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:48,195 - INFO - Params: {'apart_id': 864933}
2025-02-12 09:18:49,258 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:49,258 - INFO - Params: {'apart_id': 864954}
2025-02-12 09:18:50,834 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:50,834 - INFO - Params: {'apart_id': 864954}
2025-02-12 09:18:52,755 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864901
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:52,755 - INFO - Params: {'apart_id': 864901}
2025-02-12 09:18:55,707 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:55,707 - INFO - Params: {'apart_id': 864877}
2025-02-12 09:18:59,115 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864933
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:18:59,115 - INFO - Params: {'apart_id': 864933}
2025-02-12 09:19:34,132 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:34,133 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:19:43,333 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:43,334 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:19:44,421 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:44,421 - INFO - Params: {'apart_id': 864919}
2025-02-12 09:19:45,245 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:45,245 - INFO - Params: {'apart_id': 864973}
2025-02-12 09:19:46,013 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:46,014 - INFO - Params: {'apart_id': 864877}
2025-02-12 09:19:49,837 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:49,837 - INFO - Params: {'apart_id': 864954}
2025-02-12 09:19:53,198 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864930
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:53,198 - INFO - Params: {'apart_id': 864930}
2025-02-12 09:19:55,478 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864970
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:55,478 - INFO - Params: {'apart_id': 864970}
2025-02-12 09:19:56,757 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864972
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:56,757 - INFO - Params: {'apart_id': 864972}
2025-02-12 09:19:57,805 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864862
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:57,805 - INFO - Params: {'apart_id': 864862}
2025-02-12 09:19:58,869 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865011
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:58,870 - INFO - Params: {'apart_id': 865011}
2025-02-12 09:19:59,998 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864998
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:19:59,999 - INFO - Params: {'apart_id': 864998}
2025-02-12 09:20:04,326 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865748
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:20:04,326 - INFO - Params: {'apart_id': 865748}
2025-02-12 09:20:05,277 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865453
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:20:05,277 - INFO - Params: {'apart_id': 865453}
2025-02-12 09:20:06,270 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865428
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:20:06,270 - INFO - Params: {'apart_id': 865428}
2025-02-12 09:21:14,944 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:21:14,945 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:21:18,110 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 09:21:18,110 - INFO - Params: {}
2025-02-12 09:21:19,585 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 09:21:19,585 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 09:21:19,928 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 09:21:19,928 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 09:21:19,930 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 09:21:19,930 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 09:23:05,408 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864994
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:23:05,409 - INFO - Params: {'apart_id': 864994}
2025-02-12 09:23:06,339 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864994
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:23:06,339 - INFO - Params: {'apart_id': 864994}
2025-02-12 09:23:41,629 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864838
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:23:41,629 - INFO - Params: {'apart_id': 864838}
2025-02-12 09:24:26,620 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:24:26,621 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:24:50,707 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864933
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:24:50,707 - INFO - Params: {'apart_id': 864933}
2025-02-12 09:26:57,164 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:26:57,165 - INFO - Params: {'apart_id': 864919}
2025-02-12 09:26:58,028 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:26:58,029 - INFO - Params: {'apart_id': 864958}
2025-02-12 09:26:58,996 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:26:58,996 - INFO - Params: {'apart_id': 864954}
2025-02-12 09:26:59,636 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:26:59,636 - INFO - Params: {'apart_id': 865013}
2025-02-12 09:27:53,343 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864916
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:27:53,343 - INFO - Params: {'apart_id': 864916}
2025-02-12 09:27:55,485 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:27:55,485 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:34:37,071 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:37,071 - INFO - Params: {'apart_id': 864587}
2025-02-12 09:34:39,141 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:39,141 - INFO - Params: {'apart_id': 864877}
2025-02-12 09:34:39,932 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:39,933 - INFO - Params: {'apart_id': 865013}
2025-02-12 09:34:40,604 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:40,604 - INFO - Params: {'apart_id': 864958}
2025-02-12 09:34:42,260 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:42,260 - INFO - Params: {'apart_id': 864958}
2025-02-12 09:34:46,804 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:46,804 - INFO - Params: {'apart_id': 864958}
2025-02-12 09:34:48,588 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:48,588 - INFO - Params: {'apart_id': 864958}
2025-02-12 09:34:54,957 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:54,957 - INFO - Params: {'apart_id': 865013}
2025-02-12 09:34:56,876 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:34:56,876 - INFO - Params: {'apart_id': 865013}
2025-02-12 09:35:13,958 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:35:13,958 - INFO - Params: {'apart_id': 865013}
2025-02-12 09:35:15,580 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864893
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:35:15,580 - INFO - Params: {'apart_id': 864893}
2025-02-12 09:35:17,180 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864893
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:35:17,181 - INFO - Params: {'apart_id': 864893}
2025-02-12 09:35:18,492 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864997
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:35:18,492 - INFO - Params: {'apart_id': 864997}
2025-02-12 09:35:21,452 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864949
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:35:21,453 - INFO - Params: {'apart_id': 864949}
2025-02-12 09:35:23,492 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865012
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:35:23,492 - INFO - Params: {'apart_id': 865012}
2025-02-12 09:35:35,876 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864996
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 09:35:35,876 - INFO - Params: {'apart_id': 864996}
2025-02-12 10:02:02,255 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:02:02,255 - INFO - Params: {'apart_id': 864587}
2025-02-12 10:02:21,213 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 10:06:00,451 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864894
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:06:00,452 - INFO - Params: {'apart_id': 864894}
2025-02-12 10:06:01,793 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865029
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:06:01,793 - INFO - Params: {'apart_id': 865029}
2025-02-12 10:06:04,296 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864840
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:06:04,296 - INFO - Params: {'apart_id': 864840}
2025-02-12 10:06:19,961 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865671
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:06:19,961 - INFO - Params: {'apart_id': 865671}
2025-02-12 10:06:21,464 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865671
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:06:21,464 - INFO - Params: {'apart_id': 865671}
2025-02-12 10:06:22,096 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864608
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:06:22,096 - INFO - Params: {'apart_id': 864608}
2025-02-12 10:06:22,648 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864769
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:06:22,648 - INFO - Params: {'apart_id': 864769}
2025-02-12 10:36:59,055 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:36:59,055 - INFO - Params: {'apart_id': 864587}
2025-02-12 10:37:05,632 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:37:05,632 - INFO - Params: {'apart_id': 864919}
2025-02-12 10:37:18,008 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 10:37:18,387 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:37:18,387 - INFO - Params: {'apart_id': 864587}
2025-02-12 10:37:24,570 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 10:37:26,407 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:37:26,407 - INFO - Params: {'apart_id': 864919}
2025-02-12 10:44:39,438 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:44:39,439 - INFO - Params: {'apart_id': 864919}
2025-02-12 10:46:24,677 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:46:24,677 - INFO - Params: {'apart_id': 864587}
2025-02-12 10:53:07,369 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:53:07,370 - INFO - Params: {'apart_id': 864919}
2025-02-12 10:53:37,036 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:53:37,037 - INFO - Params: {'apart_id': 864973}
2025-02-12 10:54:02,086 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:54:02,086 - INFO - Params: {'apart_id': 864877}
2025-02-12 10:54:33,381 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 10:54:33,381 - INFO - Params: {'apart_id': 864919}
2025-02-12 11:12:09,958 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864918
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:09,958 - INFO - Params: {'apart_id': 864918}
2025-02-12 11:12:09,959 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.InterfaceError) <class 'asyncpg.exceptions._base.InterfaceError'>: connection is closed
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864918
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/rvf5)
2025-02-12 11:12:11,178 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864970
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:11,178 - INFO - Params: {'apart_id': 864970}
2025-02-12 11:12:12,675 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864837
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:12,675 - INFO - Params: {'apart_id': 864837}
2025-02-12 11:12:14,018 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864837
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:14,019 - INFO - Params: {'apart_id': 864837}
2025-02-12 11:12:14,611 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864856
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:14,611 - INFO - Params: {'apart_id': 864856}
2025-02-12 11:12:15,266 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864861
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:15,266 - INFO - Params: {'apart_id': 864861}
2025-02-12 11:12:15,714 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864870
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:15,714 - INFO - Params: {'apart_id': 864870}
2025-02-12 11:12:17,018 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864979
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:17,018 - INFO - Params: {'apart_id': 864979}
2025-02-12 11:12:17,577 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865020
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:17,577 - INFO - Params: {'apart_id': 865020}
2025-02-12 11:12:18,066 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864840
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:18,066 - INFO - Params: {'apart_id': 864840}
2025-02-12 11:12:18,586 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864955
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:18,587 - INFO - Params: {'apart_id': 864955}
2025-02-12 11:12:19,298 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864981
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:19,299 - INFO - Params: {'apart_id': 864981}
2025-02-12 11:12:20,395 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864981
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:20,395 - INFO - Params: {'apart_id': 864981}
2025-02-12 11:12:21,274 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865026
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:21,275 - INFO - Params: {'apart_id': 865026}
2025-02-12 11:12:22,714 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864983
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:22,714 - INFO - Params: {'apart_id': 864983}
2025-02-12 11:12:25,810 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864908
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:25,810 - INFO - Params: {'apart_id': 864908}
2025-02-12 11:12:30,466 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865388
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:12:30,466 - INFO - Params: {'apart_id': 865388}
2025-02-12 11:24:56,144 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:24:56,145 - INFO - Params: {'apart_id': 864587}
2025-02-12 11:27:08,062 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 11:27:08,063 - INFO - Params: {}
2025-02-12 11:27:09,061 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 11:27:09,061 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 11:27:09,436 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 11:27:09,436 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 11:27:09,438 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 11:27:09,438 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 11:27:12,803 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:27:12,804 - INFO - Params: {'apart_id': 864587}
2025-02-12 11:32:43,866 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:32:43,866 - INFO - Params: {'apart_id': 864587}
2025-02-12 11:32:57,979 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:32:57,979 - INFO - Params: {'apart_id': 864919}
2025-02-12 11:54:03,231 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:54:03,232 - INFO - Params: {'apart_id': 864919}
2025-02-12 11:54:22,168 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 11:56:18,120 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:56:18,121 - INFO - Params: {'apart_id': 864877}
2025-02-12 11:56:18,383 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:56:18,383 - INFO - Params: {'apart_id': 865013}
2025-02-12 11:56:18,633 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864933
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:56:18,633 - INFO - Params: {'apart_id': 864933}
2025-02-12 11:56:19,441 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:56:19,442 - INFO - Params: {'apart_id': 864587}
2025-02-12 11:57:09,729 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:57:09,729 - INFO - Params: {'apart_id': 864919}
2025-02-12 11:57:43,980 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 11:57:43,980 - INFO - Params: {}
2025-02-12 11:57:44,855 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 11:57:44,855 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-12 11:57:45,472 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 11:57:45,472 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-12 11:57:45,486 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 11:57:45,486 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-12 11:57:46,103 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
=======
=======
>>>>>>> f30caea (big query changes)
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-12 11:57:46,103 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.6', 'municipal_0': 'NaN'}
2025-02-12 11:57:47,111 - INFO - Executing query: 
=======
2025-02-12 20:35:25,316 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-12 20:35:25,630 - INFO - Executing query: 
>>>>>>> demo-dev
=======
2025-02-12 20:35:25,316 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-12 20:35:25,630 - INFO - Executing query: 
>>>>>>> f30caea (big query changes)
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
<<<<<<< HEAD
<<<<<<< HEAD
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
=======
=======
>>>>>>> f30caea (big query changes)
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-12 11:57:47,111 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.6', 'municipal_0': 'NaN'}
2025-02-12 11:57:48,223 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 11:57:48,223 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-12 11:57:48,225 - INFO - Executing query: 
=======
2025-02-12 20:35:25,631 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.2', 'municipal_0': 'Богородское'}
2025-02-12 20:35:26,027 - INFO - Executing query: 
>>>>>>> demo-dev
=======
2025-02-12 20:35:25,631 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.2', 'municipal_0': 'Богородское'}
2025-02-12 20:35:26,027 - INFO - Executing query: 
>>>>>>> f30caea (big query changes)
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
<<<<<<< HEAD
<<<<<<< HEAD
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
=======
=======
>>>>>>> f30caea (big query changes)
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:26,027 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-12 20:35:34,880 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:34,880 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.3', 'municipal_0': 'Богородское'}
2025-02-12 20:35:35,519 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:35,519 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.2', 'municipal_0': 'Богородское'}
2025-02-12 20:35:35,964 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:35,964 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-12 20:35:36,367 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 20:35:36,367 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-12 20:35:36,417 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-12 11:57:48,225 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-12 11:57:49,623 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 11:57:49,623 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 11:57:50,792 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 11:57:50,792 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 11:57:50,793 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 11:57:50,794 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 11:57:51,647 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:57:51,647 - INFO - Params: {'apart_id': 864880}
2025-02-12 11:58:21,360 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:58:21,360 - INFO - Params: {'apart_id': 865013}
2025-02-12 11:59:12,764 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:59:12,764 - INFO - Params: {'apart_id': 865013}
2025-02-12 11:59:27,936 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:59:27,936 - INFO - Params: {'apart_id': 864954}
2025-02-12 11:59:29,308 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 11:59:29,309 - INFO - Params: {'apart_id': 864954}
2025-02-12 12:00:04,933 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:04,933 - INFO - Params: {'apart_id': 864958}
2025-02-12 12:00:06,181 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:06,182 - INFO - Params: {'apart_id': 864958}
2025-02-12 12:00:07,917 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:07,917 - INFO - Params: {'apart_id': 864958}
2025-02-12 12:00:21,987 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864933
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:21,987 - INFO - Params: {'apart_id': 864933}
2025-02-12 12:00:22,445 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:22,446 - INFO - Params: {'apart_id': 864954}
2025-02-12 12:00:23,830 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:23,830 - INFO - Params: {'apart_id': 864954}
2025-02-12 12:00:35,423 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:35,423 - INFO - Params: {'apart_id': 865013}
2025-02-12 12:00:36,238 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:36,238 - INFO - Params: {'apart_id': 864880}
2025-02-12 12:00:37,534 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:37,534 - INFO - Params: {'apart_id': 865013}
2025-02-12 12:00:38,358 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:38,358 - INFO - Params: {'apart_id': 864880}
2025-02-12 12:00:39,574 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:39,574 - INFO - Params: {'apart_id': 864880}
2025-02-12 12:00:41,366 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:41,367 - INFO - Params: {'apart_id': 864880}
2025-02-12 12:00:42,742 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:42,742 - INFO - Params: {'apart_id': 864880}
2025-02-12 12:00:43,926 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:00:43,926 - INFO - Params: {'apart_id': 864880}
2025-02-12 12:01:07,225 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:01:07,225 - INFO - Params: {'apart_id': 864973}
2025-02-12 12:59:52,023 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 12:59:52,024 - INFO - Params: {'apart_id': 864973}
2025-02-12 13:00:10,997 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 13:00:11,051 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:00:11,051 - INFO - Params: {'apart_id': 864973}
2025-02-12 13:00:26,497 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:00:26,498 - INFO - Params: {}
2025-02-12 13:00:39,943 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:00:39,943 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 13:00:40,694 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:00:40,694 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 13:00:40,712 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:00:40,712 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 13:00:52,919 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:00:52,919 - INFO - Params: {'apart_id': 864880}
2025-02-12 13:00:54,694 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:00:54,694 - INFO - Params: {'apart_id': 864880}
2025-02-12 13:08:57,420 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:08:57,420 - INFO - Params: {'apart_id': 864880}
2025-02-12 13:09:14,156 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:09:14,156 - INFO - Params: {'apart_id': 865013}
2025-02-12 13:09:59,119 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:09:59,119 - INFO - Params: {'apart_id': 864954}
2025-02-12 13:09:59,923 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:09:59,924 - INFO - Params: {'apart_id': 865013}
2025-02-12 13:10:01,187 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:10:01,187 - INFO - Params: {'apart_id': 864954}
2025-02-12 13:10:03,484 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:10:03,484 - INFO - Params: {'apart_id': 864954}
2025-02-12 13:10:04,683 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:10:04,683 - INFO - Params: {'apart_id': 864954}
2025-02-12 13:10:05,907 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:10:05,907 - INFO - Params: {'apart_id': 864954}
2025-02-12 13:10:39,250 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:10:39,250 - INFO - Params: {'apart_id': 865013}
2025-02-12 13:10:40,596 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:10:40,596 - INFO - Params: {'apart_id': 865013}
2025-02-12 13:13:54,633 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:13:54,633 - INFO - Params: {}
2025-02-12 13:13:55,867 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:13:55,867 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 13:13:56,259 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:13:56,259 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 13:13:56,260 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:13:56,260 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 13:13:57,074 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:13:57,075 - INFO - Params: {'apart_id': 864973}
2025-02-12 13:14:37,963 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:14:37,963 - INFO - Params: {'apart_id': 864973}
2025-02-12 13:14:48,331 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:14:48,331 - INFO - Params: {'apart_id': 864973}
2025-02-12 13:33:29,367 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865029
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:29,368 - INFO - Params: {'apart_id': 865029}
2025-02-12 13:33:29,935 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864855
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:29,935 - INFO - Params: {'apart_id': 864855}
2025-02-12 13:33:30,615 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864931
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:30,616 - INFO - Params: {'apart_id': 864931}
2025-02-12 13:33:31,743 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865012
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:31,743 - INFO - Params: {'apart_id': 865012}
2025-02-12 13:33:33,295 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:33,296 - INFO - Params: {'apart_id': 864880}
2025-02-12 13:33:37,255 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:37,256 - INFO - Params: {'apart_id': 864973}
2025-02-12 13:33:38,511 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:38,512 - INFO - Params: {'apart_id': 865013}
2025-02-12 13:33:39,983 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:39,983 - INFO - Params: {'apart_id': 864954}
2025-02-12 13:33:43,815 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:33:43,816 - INFO - Params: {'apart_id': 865013}
2025-02-12 13:34:27,919 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:34:27,920 - INFO - Params: {'apart_id': 864973}
2025-02-12 13:34:29,551 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:34:29,551 - INFO - Params: {'apart_id': 864954}
2025-02-12 13:34:33,463 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864894
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:34:33,463 - INFO - Params: {'apart_id': 864894}
2025-02-12 13:34:34,039 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864996
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:34:34,039 - INFO - Params: {'apart_id': 864996}
2025-02-12 13:34:34,455 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864930
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:34:34,455 - INFO - Params: {'apart_id': 864930}
2025-02-12 13:35:15,197 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864996
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:15,198 - INFO - Params: {'apart_id': 864996}
2025-02-12 13:35:16,152 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864930
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:16,152 - INFO - Params: {'apart_id': 864930}
2025-02-12 13:35:16,992 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864996
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:16,992 - INFO - Params: {'apart_id': 864996}
2025-02-12 13:35:17,591 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864930
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:17,591 - INFO - Params: {'apart_id': 864930}
2025-02-12 13:35:25,432 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864996
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:25,432 - INFO - Params: {'apart_id': 864996}
2025-02-12 13:35:27,119 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864879
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:27,119 - INFO - Params: {'apart_id': 864879}
2025-02-12 13:35:27,887 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864894
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:27,887 - INFO - Params: {'apart_id': 864894}
2025-02-12 13:35:29,774 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:35:29,774 - INFO - Params: {}
2025-02-12 13:35:32,000 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:35:32,000 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 13:35:32,456 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:35:32,456 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 13:35:32,470 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:35:32,471 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 13:35:35,871 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:35:35,871 - INFO - Params: {'apart_id': 864587}
2025-02-12 13:35:58,295 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:35:58,296 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 13:35:58,312 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:35:58,313 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 13:36:01,808 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:36:01,808 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 13:36:01,809 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:36:01,809 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 13:36:08,165 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:36:08,165 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-12 13:36:08,808 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:36:08,808 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-12 13:36:08,809 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:36:08,809 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-12 13:36:12,959 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:36:12,959 - INFO - Params: {'apart_id': 720420}
2025-02-12 13:36:14,655 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720451
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:36:14,655 - INFO - Params: {'apart_id': 720451}
2025-02-12 13:36:15,102 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:36:15,103 - INFO - Params: {'apart_id': 766514}
2025-02-12 13:36:18,959 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:36:18,960 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 13:36:18,972 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 13:36:18,973 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 13:36:20,671 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 13:36:20,671 - INFO - Params: {'apart_id': 864587}
2025-02-12 13:36:25,818 - INFO - Executing query: 
=======
=======
>>>>>>> f30caea (big query changes)
2025-02-12 20:35:36,417 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-12 20:35:36,849 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 20:35:36,849 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-12 20:35:36,850 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:36,850 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-12 20:35:38,280 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 20:35:38,280 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-12 20:35:38,281 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 20:35:38,282 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-12 20:35:39,442 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 20:35:39,442 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-12 20:36:09,903 - INFO - Executing query: 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-12 13:36:25,818 - INFO - Params: {}
2025-02-12 13:36:27,355 - INFO - Executing query: 
=======
2025-02-12 20:36:09,903 - INFO - Params: {}
2025-02-12 20:36:10,058 - INFO - Executing query: 
>>>>>>> demo-dev
=======
2025-02-12 20:36:09,903 - INFO - Params: {}
2025-02-12 20:36:10,058 - INFO - Executing query: 
>>>>>>> f30caea (big query changes)
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-12 13:36:27,356 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 13:36:28,200 - INFO - Executing query: 
=======
=======
>>>>>>> f30caea (big query changes)
2025-02-12 20:36:10,058 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-12 20:36:10,420 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 20:36:10,420 - INFO - Params: {'district_0': 'Новомосковский АО'}
2025-02-12 20:36:11,024 - INFO - Executing query: 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-12 13:36:28,200 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 13:36:28,226 - INFO - Executing query: 
=======
2025-02-12 20:36:11,024 - INFO - Params: {'municipal_districts_0': 'Внуковское сельское поселение'}
2025-02-12 20:36:11,026 - INFO - Executing query: 
>>>>>>> demo-dev
=======
2025-02-12 20:36:11,024 - INFO - Params: {'municipal_districts_0': 'Внуковское сельское поселение'}
2025-02-12 20:36:11,026 - INFO - Executing query: 
>>>>>>> f30caea (big query changes)
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-12 13:36:28,226 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 13:36:31,959 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 53922
                ORDER BY 
                    na.new_apart_id;
            
2025-02-12 13:36:31,960 - INFO - Params: {'apart_id': 53922}
2025-02-12 13:37:44,206 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 54020
                ORDER BY 
                    na.new_apart_id;
            
2025-02-12 13:37:44,206 - INFO - Params: {'apart_id': 54020}
2025-02-12 13:37:45,367 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 54157
                ORDER BY 
                    na.new_apart_id;
            
2025-02-12 13:37:45,367 - INFO - Params: {'apart_id': 54157}
2025-02-12 13:37:46,447 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 53964
                ORDER BY 
                    na.new_apart_id;
            
2025-02-12 13:37:46,448 - INFO - Params: {'apart_id': 53964}
2025-02-12 13:37:47,231 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 53922
                ORDER BY 
                    na.new_apart_id;
            
2025-02-12 13:37:47,231 - INFO - Params: {'apart_id': 53922}
2025-02-12 13:41:51,408 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:41:51,408 - INFO - Params: {}
2025-02-12 13:41:53,183 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-12 13:41:53,183 - INFO - Params: {}
2025-02-12 13:41:59,676 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:41:59,677 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-12 13:42:00,501 - INFO - Executing query: 
=======
2025-02-12 20:36:11,026 - INFO - Params: {'municipal_0': 'Внуковское сельское поселение'}
2025-02-12 20:36:11,281 - INFO - Executing query: 
>>>>>>> demo-dev
=======
2025-02-12 20:36:11,026 - INFO - Params: {'municipal_0': 'Внуковское сельское поселение'}
2025-02-12 20:36:11,281 - INFO - Executing query: 
>>>>>>> f30caea (big query changes)
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-12 13:42:00,501 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-12 13:42:00,513 - INFO - Executing query: 
=======
=======
>>>>>>> f30caea (big query changes)
2025-02-12 20:36:11,281 - INFO - Params: {'municipal_districts_0': 'Внуковское сельское поселение'}
2025-02-12 20:36:11,386 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN ($1) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Внуковское сельское поселение',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:36:11,429 - INFO - Executing query: 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-12 13:42:00,513 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-12 13:43:02,064 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:43:02,064 - INFO - Params: {}
2025-02-12 13:43:03,062 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-12 13:43:03,062 - INFO - Params: {}
2025-02-12 13:43:04,263 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:43:04,263 - INFO - Params: {}
2025-02-12 13:43:05,294 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-12 13:43:05,294 - INFO - Params: {}
2025-02-12 13:43:06,589 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:43:06,589 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-12 13:43:06,854 - INFO - Executing query: 
=======
=======
>>>>>>> f30caea (big query changes)
2025-02-12 20:36:11,429 - INFO - Params: {'municipal_0': 'Внуковское сельское поселение'}
2025-02-12 20:36:11,503 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN ($1) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Внуковское сельское поселение',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:36:11,696 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 20:36:11,696 - INFO - Params: {'municipal_districts_0': 'Воскресенское сельское поселение'}
2025-02-12 20:36:11,770 - INFO - Executing query: 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-12 13:43:06,854 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-12 13:43:06,855 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 13:43:06,855 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-12 13:43:08,676 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 9051407
                ORDER BY 
                    na.new_apart_id;
            
2025-02-12 13:43:08,676 - INFO - Params: {'apart_id': 9051407}
2025-02-12 13:43:11,205 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 9051407
                ORDER BY 
                    na.new_apart_id;
            
2025-02-12 13:43:11,205 - INFO - Params: {'apart_id': 9051407}
2025-02-12 13:43:16,842 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:43:16,842 - INFO - Params: {}
2025-02-12 13:43:19,244 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 13:43:19,244 - INFO - Params: {'district_0': 'Центральный АО'}
2025-02-12 13:44:46,296 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 13:44:46,296 - INFO - Params: None
2025-02-12 13:44:46,299 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 13:44:46,299 - INFO - Params: None
2025-02-12 13:44:47,137 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:44:47,138 - INFO - Params: {}
2025-02-12 13:47:43,663 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 13:47:43,663 - INFO - Params: {}
2025-02-12 14:02:28,495 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:02:28,496 - INFO - Params: {}
2025-02-12 14:03:54,161 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 14:03:54,162 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-12 14:06:57,860 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 14:06:57,860 - INFO - Params: {'municipal_districts_0': 'Новогиреево'}
2025-02-12 14:06:57,861 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
=======
=======
>>>>>>> f30caea (big query changes)
2025-02-12 20:36:11,770 - INFO - Params: {'municipal_0': 'Воскресенское сельское поселение'}
2025-02-12 20:36:12,001 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
<<<<<<< HEAD
<<<<<<< HEAD
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 14:06:57,861 - INFO - Params: {'municipal_0': 'Новогиреево'}
2025-02-12 14:06:58,348 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
=======
=======
>>>>>>> f30caea (big query changes)
                WHERE municipal_district IN ($1) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Воскресенское сельское поселение',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:36:12,667 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-12 14:06:58,348 - INFO - Params: {'house_address_0': 'Братская ул., д.23 кор.2', 'municipal_0': 'Новогиреево'}
2025-02-12 14:08:24,621 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:08:24,622 - INFO - Params: {}
2025-02-12 14:08:46,286 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:08:46,286 - INFO - Params: {}
2025-02-12 14:08:50,180 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:08:50,180 - INFO - Params: {}
2025-02-12 14:11:02,005 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 14:11:02,006 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 14:11:02,388 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 14:11:02,388 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 14:11:02,389 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
=======
=======
>>>>>>> f30caea (big query changes)
2025-02-12 20:36:12,667 - INFO - Params: {'house_address_0': 'Чечерский пр. (п.Воскресенское), д.122 кор.1', 'municipal_0': 'Воскресенское сельское поселение'}
2025-02-12 20:36:12,710 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
<<<<<<< HEAD
<<<<<<< HEAD
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 14:11:02,389 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 14:32:29,525 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:32:29,525 - INFO - Params: {}
2025-02-12 14:32:36,725 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:32:36,726 - INFO - Params: {}
2025-02-12 14:32:38,858 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:32:38,858 - INFO - Params: {}
2025-02-12 14:32:41,429 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 14:32:41,429 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 14:32:42,269 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 14:32:42,269 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 14:32:42,270 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 14:32:42,270 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 14:32:48,476 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 14:32:55,678 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 14:34:42,474 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:34:42,474 - INFO - Params: {}
2025-02-12 14:34:43,343 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 14:34:43,343 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-12 14:35:10,647 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 14:35:10,647 - INFO - Params: {'municipal_districts_0': 'Ивановское'}
2025-02-12 14:35:10,790 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 14:35:10,790 - INFO - Params: {'municipal_0': 'Ивановское'}
2025-02-12 14:35:33,056 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 14:35:33,057 - INFO - Params: {}
2025-02-12 14:41:58,089 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 14:41:58,089 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 14:41:58,502 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 14:41:58,503 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 14:41:58,504 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 14:41:58,504 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 14:42:00,327 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 14:42:00,327 - INFO - Params: {'apart_id': 864880}
2025-02-12 15:42:42,535 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 15:42:42,535 - INFO - Params: {}
2025-02-12 15:42:45,830 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-12 15:42:45,830 - INFO - Params: {}
2025-02-12 15:42:53,224 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 15:42:53,224 - INFO - Params: {}
2025-02-12 15:42:53,861 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 15:42:53,861 - INFO - Params: {}
2025-02-12 15:42:54,787 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 15:42:54,788 - INFO - Params: {}
2025-02-12 15:42:58,926 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 15:42:58,926 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 15:42:59,334 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 15:42:59,334 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 15:42:59,335 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 15:42:59,336 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 15:43:01,471 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 15:43:04,793 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 15:43:12,167 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 15:43:12,824 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 15:44:03,717 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 15:44:03,717 - INFO - Params: {}
2025-02-12 15:44:05,542 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 15:44:05,542 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 15:44:06,063 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 15:44:06,063 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 15:44:06,067 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 15:44:06,067 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 16:10:24,179 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 16:10:24,179 - INFO - Params: {}
2025-02-12 16:10:26,107 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 16:10:26,107 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-12 16:10:39,170 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 16:10:39,171 - INFO - Params: {}
2025-02-12 16:10:40,456 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 16:10:40,456 - INFO - Params: {}
2025-02-12 16:10:43,146 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 16:10:43,146 - INFO - Params: {}
2025-02-12 16:10:43,588 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 16:10:43,588 - INFO - Params: {}
2025-02-12 16:10:45,046 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN ($1)
            ORDER BY municipal_district
        ]
[parameters: ('Восточный АО',)]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 16:10:45,106 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 16:10:45,107 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 16:10:45,642 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 16:10:45,642 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 16:10:45,755 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 16:10:45,755 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 16:10:47,154 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864997
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:10:47,155 - INFO - Params: {'apart_id': 864997}
2025-02-12 16:10:57,747 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:10:57,747 - INFO - Params: {'apart_id': 864954}
2025-02-12 16:10:58,109 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 16:10:59,399 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 16:11:02,093 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-12 16:11:08,882 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 16:11:08,882 - INFO - Params: None
2025-02-12 16:11:08,886 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 16:11:08,886 - INFO - Params: None
2025-02-12 16:11:36,504 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-12 16:11:36,505 - INFO - Params: {}
2025-02-12 16:11:37,979 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-12 16:11:37,979 - INFO - Params: {'district_0': 'СВАО'}
2025-02-12 16:11:38,459 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-12 16:11:38,459 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-12 16:11:38,567 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-12 16:11:38,567 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-12 16:26:19,595 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864918
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:26:19,596 - INFO - Params: {'apart_id': 864918}
2025-02-12 16:27:25,937 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:27:25,937 - INFO - Params: {'apart_id': 864587}
2025-02-12 16:31:15,083 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:31:15,083 - INFO - Params: {'apart_id': 864880}
2025-02-12 16:31:16,163 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:31:16,163 - INFO - Params: {'apart_id': 864954}
2025-02-12 16:31:19,618 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:31:19,618 - INFO - Params: {'apart_id': 864587}
2025-02-12 16:31:21,178 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864997
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:31:21,178 - INFO - Params: {'apart_id': 864997}
2025-02-12 16:31:21,746 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864918
                ORDER BY 
                    fs.affair_id;
            
2025-02-12 16:31:21,746 - INFO - Params: {'apart_id': 864918}
2025-02-12 16:34:04,165 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 16:34:04,165 - INFO - Params: None
2025-02-12 16:34:04,167 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-12 16:34:04,167 - INFO - Params: None
2025-02-13 08:13:18,166 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 08:13:18,166 - INFO - Params: {}
2025-02-13 08:13:20,073 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:13:20,073 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 08:13:20,657 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:13:20,657 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 08:13:20,659 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:13:20,659 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 08:13:32,170 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720438
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:13:32,170 - INFO - Params: {'apart_id': 720438}
2025-02-13 08:13:35,835 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720477
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:13:35,835 - INFO - Params: {'apart_id': 720477}
2025-02-13 08:13:41,605 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:13:41,605 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:13:43,692 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:13:43,692 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:13:53,034 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:13:53,034 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:13:54,717 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:13:54,717 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:13:56,567 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:13:56,567 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:17:24,836 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:17:24,836 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:17:33,029 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:17:33,029 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:17:50,682 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 768979
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:17:50,682 - INFO - Params: {'apart_id': 768979}
2025-02-13 08:17:55,727 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766335
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:17:55,727 - INFO - Params: {'apart_id': 766335}
2025-02-13 08:18:05,865 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:18:05,865 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:18:15,330 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:18:15,330 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 08:18:15,858 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:18:15,858 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 08:18:15,931 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:18:15,931 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 08:18:17,956 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:18:17,956 - INFO - Params: {'apart_id': 864587}
2025-02-13 08:18:30,347 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:18:30,347 - INFO - Params: {'apart_id': 864954}
2025-02-13 08:18:32,227 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864958
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:18:32,227 - INFO - Params: {'apart_id': 864958}
2025-02-13 08:18:33,413 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864893
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:18:33,413 - INFO - Params: {'apart_id': 864893}
2025-02-13 08:35:13,968 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
=======
=======
>>>>>>> f30caea (big query changes)
                WHERE house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Чечерский пр. (п.Воскресенское), д.122 кор.1', 'Воскресенское сельское поселение')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:36:13,826 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-13 08:35:13,968 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 08:35:16,582 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:35:16,582 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 08:35:16,583 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
=======
=======
>>>>>>> f30caea (big query changes)
2025-02-12 20:36:13,826 - INFO - Params: {'house_address_0': 'Чечерский пр. (п.Воскресенское), д.122 кор.1', 'municipal_0': 'Воскресенское сельское поселение'}
2025-02-12 20:36:13,880 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
<<<<<<< HEAD
<<<<<<< HEAD
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:35:16,583 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 08:35:27,800 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:35:27,800 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:36:44,234 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720478
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:36:44,234 - INFO - Params: {'apart_id': 720478}
2025-02-13 08:37:02,192 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:37:02,192 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:37:17,106 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720477
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:37:17,106 - INFO - Params: {'apart_id': 720477}
2025-02-13 08:38:15,436 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:38:15,436 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:38:36,151 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:38:36,151 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:40:06,429 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 08:40:06,429 - INFO - Params: {}
2025-02-13 08:40:07,145 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:40:07,145 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 08:40:07,551 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:40:07,552 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 08:40:07,552 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:40:07,553 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 08:40:56,549 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 08:40:56,549 - INFO - Params: {}
2025-02-13 08:40:57,242 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:40:57,242 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 08:40:58,090 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:40:58,090 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 08:40:58,648 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:40:58,648 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 08:40:58,649 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:40:58,649 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 08:41:51,753 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766051
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:41:51,753 - INFO - Params: {'apart_id': 766051}
2025-02-13 08:41:53,745 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766051
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:41:53,745 - INFO - Params: {'apart_id': 766051}
2025-02-13 08:41:55,567 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766091
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:41:55,567 - INFO - Params: {'apart_id': 766091}
2025-02-13 08:41:58,271 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 08:41:58,271 - INFO - Params: {}
2025-02-13 08:41:59,192 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:41:59,192 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 08:41:59,520 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:41:59,520 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 08:41:59,521 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:41:59,521 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 08:42:01,300 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720478
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:01,300 - INFO - Params: {'apart_id': 720478}
2025-02-13 08:42:02,917 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:02,917 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:42:04,565 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:04,565 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:42:05,835 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:05,835 - INFO - Params: {'apart_id': 720420}
2025-02-13 08:42:08,221 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720478
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:08,221 - INFO - Params: {'apart_id': 720478}
2025-02-13 08:42:10,843 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:10,843 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:42:12,323 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:12,323 - INFO - Params: {'apart_id': 766514}
2025-02-13 08:42:13,479 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766506
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:13,479 - INFO - Params: {'apart_id': 766506}
2025-02-13 08:42:28,850 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720478
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:28,850 - INFO - Params: {'apart_id': 720478}
2025-02-13 08:42:31,035 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720478
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:31,035 - INFO - Params: {'apart_id': 720478}
2025-02-13 08:42:39,204 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766506
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:39,204 - INFO - Params: {'apart_id': 766506}
2025-02-13 08:42:41,715 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766335
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:41,715 - INFO - Params: {'apart_id': 766335}
2025-02-13 08:42:43,516 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766335
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:42:43,516 - INFO - Params: {'apart_id': 766335}
2025-02-13 08:54:45,403 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 08:54:45,403 - INFO - Params: {}
2025-02-13 08:55:38,676 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:55:38,676 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 08:55:39,123 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:55:39,124 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 08:55:39,132 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:55:39,132 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 08:56:23,647 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 08:56:23,647 - INFO - Params: {}
2025-02-13 08:56:26,068 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:56:26,068 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 08:56:26,835 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:56:26,836 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 08:56:26,845 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:56:26,845 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 08:56:53,866 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 08:56:53,866 - INFO - Params: {}
2025-02-13 08:56:54,628 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:56:54,628 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 08:56:54,964 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:56:54,964 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 08:56:54,976 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:56:54,976 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 08:56:55,303 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
=======
=======
>>>>>>> f30caea (big query changes)
                WHERE house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Чечерский пр. (п.Воскресенское), д.122 кор.1', 'Воскресенское сельское поселение')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 20:36:14,077 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-13 08:56:55,303 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 08:58:20,909 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 08:58:20,909 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 08:58:21,604 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:58:21,604 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 08:58:21,605 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:58:21,605 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 08:58:45,899 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 08:58:45,899 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 08:58:45,899 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 08:58:45,899 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 08:59:06,535 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 08:59:06,535 - INFO - Params: {'apart_id': 864954}
2025-02-13 09:00:44,419 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 09:00:44,419 - INFO - Params: {}
2025-02-13 09:01:30,054 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 09:01:30,054 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 09:01:30,758 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:01:30,758 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 09:01:30,762 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:01:30,762 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 09:05:18,929 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864954
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 09:05:18,929 - INFO - Params: {'apart_id': 864954}
2025-02-13 09:05:46,642 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 09:05:46,642 - INFO - Params: {'apart_id': 864587}
2025-02-13 09:32:11,045 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 09:32:11,045 - INFO - Params: {}
2025-02-13 09:32:11,045 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.InterfaceError) <class 'asyncpg.exceptions._base.InterfaceError'>: connection is closed
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/rvf5)
2025-02-13 09:32:55,522 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 09:32:55,522 - INFO - Params: {}
2025-02-13 09:32:56,095 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 09:32:56,095 - INFO - Params: {}
2025-02-13 09:32:56,652 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 09:32:56,652 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 09:32:57,469 - INFO - Executing query: 
=======
=======
>>>>>>> f30caea (big query changes)
2025-02-12 20:36:14,077 - INFO - Params: {'house_address_0': 'Чечерский пр. (п.Воскресенское), д.122 кор.1', 'municipal_0': 'Воскресенское сельское поселение'}
2025-02-12 20:36:14,103 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Чечерский пр. (п.Воскресенское), д.122 кор.1', 'Воскресенское сельское поселение')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-12 21:20:15,082 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-12 21:20:15,082 - INFO - Params: {}
2025-02-12 21:20:15,083 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.InterfaceError) <class 'asyncpg.exceptions._base.InterfaceError'>: connection is closed
[SQL: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/rvf5)
2025-02-12 21:21:16,165 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-12 21:21:16,165 - INFO - Params: {}
2025-02-12 21:22:16,173 - ERROR - Error executing query: 
2025-02-13 10:05:58,425 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 10:05:58,426 - INFO - Params: None
2025-02-13 10:05:58,906 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:05:59,659 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 10:05:59,659 - INFO - Params: {}
2025-02-13 10:06:02,934 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 10:06:02,934 - INFO - Params: None
2025-02-13 10:06:02,955 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:03,572 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 10:06:03,572 - INFO - Params: {}
2025-02-13 10:06:05,363 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:06:05,363 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 10:06:05,924 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:06:05,924 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 10:06:05,925 - INFO - Executing query: 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
<<<<<<< HEAD
<<<<<<< HEAD
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
=======
=======
>>>>>>> f30caea (big query changes)
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-13 09:32:57,469 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 09:32:57,470 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:32:57,470 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 09:35:29,869 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 09:35:29,869 - INFO - Params: {}
2025-02-13 09:42:03,213 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 09:42:03,213 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 09:42:03,656 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:42:03,656 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 09:42:03,657 - INFO - Executing query: 
=======
2025-02-13 10:06:05,925 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 10:06:06,369 - INFO - Executing query: 
>>>>>>> demo-dev
=======
2025-02-13 10:06:05,925 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 10:06:06,369 - INFO - Executing query: 
>>>>>>> f30caea (big query changes)
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
<<<<<<< HEAD
<<<<<<< HEAD
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:42:03,658 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 09:42:06,996 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:42:06,996 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 09:42:06,996 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:42:06,996 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 09:42:08,555 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 09:42:08,555 - INFO - Params: {}
2025-02-13 09:42:55,695 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 09:42:55,695 - INFO - Params: {}
2025-02-13 09:43:16,979 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 09:43:16,979 - INFO - Params: {}
2025-02-13 09:43:17,754 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 09:43:17,754 - INFO - Params: {}
2025-02-13 09:43:18,418 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 09:43:18,418 - INFO - Params: {}
2025-02-13 09:43:18,849 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 09:43:18,849 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 09:43:19,257 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:43:19,257 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 09:43:19,260 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:43:19,260 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 09:43:21,103 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 09:43:21,103 - INFO - Params: {}
2025-02-13 09:43:22,065 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 09:43:22,065 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 09:43:22,522 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:43:22,522 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 09:43:22,523 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:43:22,523 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 09:43:26,777 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:43:26,778 - INFO - Params: {'municipal_0': 'Гольяново'}
2025-02-13 09:43:26,778 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 09:43:26,779 - INFO - Params: {'municipal_districts_0': 'Гольяново'}
2025-02-13 09:43:27,329 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
=======
=======
>>>>>>> f30caea (big query changes)
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-13 09:43:27,329 - INFO - Params: {'house_address_0': 'Амурская ул., д.1/21', 'municipal_0': 'Гольяново'}
2025-02-13 09:43:30,537 - INFO - Executing query: 
=======
=======
>>>>>>> f30caea (big query changes)
2025-02-13 10:06:06,369 - INFO - Params: {'house_address_0': 'Измайловский бульв., д.71/25 кор.1', 'municipal_0': 'Восточное Измайлово'}
2025-02-13 10:06:07,413 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 10:06:07,413 - INFO - Params: {}
2025-02-13 10:06:08,114 - INFO - Executing query: 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-13 09:43:30,537 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 09:43:31,233 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 09:43:31,233 - INFO - Params: {'municipal_0': 'Крюково'}
2025-02-13 09:43:31,234 - INFO - Executing query: 
=======
2025-02-13 10:06:08,114 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 10:06:08,770 - INFO - Executing query: 
>>>>>>> demo-dev
=======
2025-02-13 10:06:08,114 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 10:06:08,770 - INFO - Executing query: 
>>>>>>> f30caea (big query changes)
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-13 09:43:31,234 - INFO - Params: {'municipal_districts_0': 'Крюково'}
2025-02-13 10:06:24,064 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:06:24,064 - INFO - Params: {}
2025-02-13 10:06:43,003 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 10:07:04,405 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:07:04,405 - INFO - Params: {}
2025-02-13 10:07:07,408 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:07:07,408 - INFO - Params: {}
2025-02-13 10:07:10,653 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:07:10,653 - INFO - Params: {}
2025-02-13 10:07:11,740 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:07:11,740 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 10:07:12,236 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:07:12,236 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 10:07:12,239 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:07:12,239 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 10:07:34,631 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:07:34,631 - INFO - Params: {}
2025-02-13 10:07:46,705 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:07:46,705 - INFO - Params: {}
2025-02-13 10:07:50,773 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:07:50,773 - INFO - Params: {}
2025-02-13 10:25:56,058 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:25:56,059 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 10:25:57,438 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:25:57,438 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 10:25:57,440 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:25:57,440 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 10:25:58,460 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 749909
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 10:25:58,460 - INFO - Params: {'apart_id': 749909}
2025-02-13 10:26:06,722 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 749909
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 10:26:06,722 - INFO - Params: {'apart_id': 749909}
2025-02-13 10:28:35,693 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:28:35,693 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 10:28:35,698 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:28:35,698 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 10:28:35,837 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:28:35,837 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 10:28:35,851 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:28:35,851 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 10:28:39,564 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720478
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 10:28:39,564 - INFO - Params: {'apart_id': 720478}
2025-02-13 10:46:38,742 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:46:38,742 - INFO - Params: {}
2025-02-13 10:46:39,408 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:46:39,409 - INFO - Params: {}
2025-02-13 10:46:44,410 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:46:44,410 - INFO - Params: {}
2025-02-13 10:47:29,418 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:47:29,418 - INFO - Params: {}
2025-02-13 10:47:39,787 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:47:39,788 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 10:47:40,818 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:47:40,818 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 10:47:40,820 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:47:40,820 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 10:47:42,369 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 10:47:42,369 - INFO - Params: {'apart_id': 864587}
2025-02-13 10:47:43,521 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:47:43,521 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:47:44,800 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:47:44,800 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 20, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:47:46,353 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:47:46,353 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 10:47:46,366 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:47:46,366 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 10:47:46,842 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:47:46,842 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 10:47:46,843 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:47:46,843 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 10:47:47,577 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 10:47:47,577 - INFO - Params: {'apart_id': 864587}
2025-02-13 10:47:48,705 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:47:48,705 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 10:47:50,473 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:47:50,473 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 10:47:50,475 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:47:50,475 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 10:47:51,594 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 749909
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 10:47:51,594 - INFO - Params: {'apart_id': 749909}
2025-02-13 10:48:45,732 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:48:45,732 - INFO - Params: {}
2025-02-13 10:48:46,641 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:48:46,642 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 10:48:47,241 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:48:47,241 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 10:48:47,242 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:48:47,242 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 10:48:49,397 - INFO - Executing query: 
=======
=======
>>>>>>> f30caea (big query changes)
2025-02-13 10:06:08,770 - INFO - Params: {'municipal_districts_0': 'Крылатское'}
2025-02-13 10:06:08,771 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:06:08,771 - INFO - Params: {'municipal_0': 'Крылатское'}
2025-02-13 10:06:09,117 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:06:09,117 - INFO - Params: {'house_address_0': 'Рублевское шоссе, д.70 кор.2', 'municipal_0': 'Крылатское'}
2025-02-13 10:06:10,384 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:06:10,384 - INFO - Params: {'house_address_0': 'Рублевское шоссе, д.70 кор.7', 'municipal_0': 'Крылатское'}
2025-02-13 10:06:18,441 - INFO - Executing query: 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-13 10:48:49,397 - INFO - Params: {}
2025-02-13 10:49:03,297 - INFO - Executing query: 
=======
2025-02-13 10:06:18,441 - INFO - Params: {}
2025-02-13 10:06:18,712 - INFO - Executing query: 
>>>>>>> demo-dev
=======
2025-02-13 10:06:18,441 - INFO - Params: {}
2025-02-13 10:06:18,712 - INFO - Executing query: 
>>>>>>> f30caea (big query changes)
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-13 10:49:03,297 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 10:49:03,882 - INFO - Executing query: 
=======
=======
>>>>>>> f30caea (big query changes)
2025-02-13 10:06:18,712 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 10:06:19,224 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:06:19,224 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 10:06:20,056 - INFO - Executing query: 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-13 10:49:03,882 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 10:49:03,884 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:49:03,884 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 10:49:04,437 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:49:04,437 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:49:05,506 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:49:05,507 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 10:49:05,507 - INFO - Executing query: 
=======
=======
>>>>>>> f30caea (big query changes)
2025-02-13 10:06:20,056 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 10:06:20,057 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:06:20,057 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 10:06:20,436 - INFO - Executing query: 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
<<<<<<< HEAD
<<<<<<< HEAD
2025-02-13 10:49:05,507 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 10:49:06,002 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:49:06,002 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 10:49:06,004 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:49:06,004 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 10:49:06,906 - INFO - Executing query: 
=======
=======
>>>>>>> f30caea (big query changes)
2025-02-13 10:06:20,436 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 10:06:20,502 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:06:20,502 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 10:06:21,292 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:06:21,292 - INFO - Params: {'house_address_0': 'Парковая 13-я ул., д.16А', 'municipal_0': 'Восточное Измайлово'}
2025-02-13 10:06:21,801 - INFO - Executing query: 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
<<<<<<< HEAD
<<<<<<< HEAD
                    na.new_apart_id = 53922
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:49:06,906 - INFO - Params: {'apart_id': 53922}
2025-02-13 10:49:07,922 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:49:07,922 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:49:09,737 - INFO - Executing query: 
=======
=======
>>>>>>> f30caea (big query changes)
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:21,802 - INFO - Params: {'apart_id': 8876948}
2025-02-13 10:06:21,874 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
<<<<<<< HEAD
>>>>>>> demo-dev
=======
>>>>>>> f30caea (big query changes)
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
<<<<<<< HEAD
<<<<<<< HEAD
                    na.new_apart_id = 54503
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:49:09,737 - INFO - Params: {'apart_id': 54503}
2025-02-13 10:50:07,658 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:50:07,659 - INFO - Params: {}
2025-02-13 10:50:12,956 - INFO - Executing query: WITH needs_with_row AS (
=======
=======
>>>>>>> f30caea (big query changes)
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:22,516 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:22,516 - INFO - Params: {'apart_id': 8876948}
2025-02-13 10:06:22,580 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:22,865 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876888
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:22,865 - INFO - Params: {'apart_id': 8876888}
2025-02-13 10:06:22,936 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876888
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:23,453 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:23,453 - INFO - Params: {'apart_id': 8876948}
2025-02-13 10:06:23,524 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:23,716 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876888
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:23,717 - INFO - Params: {'apart_id': 8876888}
2025-02-13 10:06:23,783 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876888
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:23,927 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:23,927 - INFO - Params: {'apart_id': 8876948}
2025-02-13 10:06:23,992 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876948
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:24,267 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8877026
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:24,267 - INFO - Params: {'apart_id': 8877026}
2025-02-13 10:06:24,340 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8877026
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:06:24,756 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876888
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:06:24,756 - INFO - Params: {'apart_id': 8876888}
2025-02-13 10:06:24,824 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876888
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:09:14,493 - INFO - Executing query: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876957
                ORDER BY 
                    na.new_apart_id;
            
2025-02-13 10:09:14,493 - INFO - Params: {'apart_id': 8876957}
2025-02-13 10:09:14,571 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: в таблице справа нет столбца "new_apart_id", указанного в предложении USING
[SQL: 
                WITH old_apartment_list AS (
                    SELECT 
                        na.new_apart_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', fs.house_address,
                                'apart_number', fs.apart_number,
                                'district', fs.district,
                                'municipal_district', fs.municipal_district,
                                'full_living_area', fs.full_living_area,
                                'total_living_area', fs.total_living_area,
                                'living_area', fs.living_area,
                                'room_count', fs.room_count,
                                'type_of_settlement', fs.type_of_settlement,
                                'notes', o.notes,
                                'status', s.status,
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE fs.house_address IS NOT NULL OR fs.apart_number IS NOT NULL OR fs.district IS NOT NULL OR fs.municipal_district IS NOT NULL 
                        OR fs.full_living_area IS NOT NULL OR fs.total_living_area IS NOT NULL OR fs.living_area IS NOT NULL 
                        OR fs.room_count IS NOT NULL OR fs.type_of_settlement IS NOT NULL OR o.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS old_apartments
                    FROM 
                        new_apart na
                    LEFT JOIN 
                        offer o USING (new_apart_id)
                    LEFT JOIN 
                        family_apartment_needs fan USING (family_apartment_needs_id)
                    LEFT JOIN 
                        family_structure fs USING (affair_id)
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        na.new_apart_id
                )
                SELECT 
                    na.new_apart_id,
                    na.house_address,
                    na.apart_number ,
                    na.district ,
                    na.municipal_district ,
                    na.full_living_area  ,
                    na.total_living_area ,
                    na.living_area ,
                    na.room_count ,
                    na.type_of_settlement,
                    na.notes ,
                    oal.old_apartments
                FROM 
                    new_apart na
                LEFT JOIN 
                    old_apartment_list oal ON na.new_apart_id = oal.new_apart_id
                WHERE
                    na.new_apart_id = 8876957
                ORDER BY 
                    na.new_apart_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:09:50,036 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:09:50,036 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 10:09:50,560 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:09:50,561 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 10:09:50,629 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:09:50,629 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 10:09:51,101 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:09:51,101 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:09:52,338 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:09:52,338 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:09:53,932 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:09:53,932 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:09:55,271 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:09:55,271 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:09:58,755 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 10:09:58,755 - INFO - Params: None
2025-02-13 10:09:58,773 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 10:13:13,466 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 10:13:13,466 - INFO - Params: {}
2025-02-13 10:13:13,738 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 10:13:13,738 - INFO - Params: {}
2025-02-13 10:13:14,829 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:13:14,830 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 10:13:16,044 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:13:16,044 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 10:13:16,437 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:13:16,437 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 10:13:16,438 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:16,438 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:17,911 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:17,911 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:18,828 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:18,829 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:19,108 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:19,108 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:20,035 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:20,035 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:21,743 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:21,743 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:49,322 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:49,322 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:58,719 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:58,719 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:13:59,038 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 10:13:59,038 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:14:01,206 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 10:14:01,206 - INFO - Params: {}
2025-02-13 10:14:02,688 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:14:02,688 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 10:14:03,168 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 10:14:03,168 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 10:14:03,598 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 10:14:03,598 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 10:14:03,765 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:14:03,766 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 10:14:04,085 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:14:04,085 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:14:05,902 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:14:05,902 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:14:08,220 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:14:08,220 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 34, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 10:14:10,199 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 10:14:10,199 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:43:48,620 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 14:43:48,620 - INFO - Params: None
2025-02-13 14:43:49,076 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 14:43:49,976 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 14:43:49,976 - INFO - Params: {}
2025-02-13 14:43:51,117 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:43:51,118 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 14:43:51,461 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:43:51,462 - INFO - Params: {'municipal_districts_0': '#6101'}
2025-02-13 14:43:51,525 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:43:51,526 - INFO - Params: {'municipal_0': '#6101'}
2025-02-13 14:43:52,260 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:43:52,260 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-13 14:43:52,261 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:43:52,261 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-13 14:43:52,778 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:43:52,778 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.6', 'municipal_0': 'NaN'}
2025-02-13 14:44:04,605 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 14:44:04,605 - INFO - Params: {}
2025-02-13 14:44:04,814 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:44:04,814 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 14:44:05,354 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:44:05,354 - INFO - Params: {'municipal_districts_0': 'Кунцево'}
2025-02-13 14:44:05,355 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:05,355 - INFO - Params: {'municipal_0': 'Кунцево'}
2025-02-13 14:44:05,843 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:05,843 - INFO - Params: {'house_address_0': 'Бобруйская ул., д.15/1', 'municipal_0': 'Кунцево'}
2025-02-13 14:44:07,122 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:07,122 - INFO - Params: {'house_address_0': 'Ельнинская ул., д.14 кор.2', 'municipal_0': 'Кунцево'}
2025-02-13 14:44:11,248 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:44:11,248 - INFO - Params: {'municipal_districts_0': 'Кунцево'}
2025-02-13 14:44:11,295 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:11,296 - INFO - Params: {'municipal_0': 'Кунцево'}
2025-02-13 14:44:12,906 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:44:12,906 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:44:13,201 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:44:13,201 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:44:15,124 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:44:15,124 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:44:15,124 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:15,125 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:16,173 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:16,173 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:17,890 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:17,890 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:19,285 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:19,285 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:22,809 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:44:22,810 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:44:22,859 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:22,859 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:23,242 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:44:23,242 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:44:23,323 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:23,323 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:24,320 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:24,320 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:24,741 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:24,741 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:25,456 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:25,456 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:44:26,555 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:44:26,555 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:44:26,556 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:44:26,557 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:47:11,865 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 14:47:11,865 - INFO - Params: None
2025-02-13 14:47:11,892 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 14:47:22,398 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 14:47:22,399 - INFO - Params: {}
2025-02-13 14:47:23,929 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 14:47:23,930 - INFO - Params: {}
2025-02-13 14:47:24,035 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 14:47:24,035 - INFO - Params: {}
2025-02-13 14:47:24,761 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:47:24,761 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:47:25,494 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:47:25,494 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:47:25,496 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:47:25,496 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:47:26,052 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:47:26,052 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:47:27,439 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:47:27,439 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:47:28,335 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:47:28,335 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:47:29,505 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:47:29,505 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:47:30,569 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:47:30,570 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:01,540 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 14:48:01,540 - INFO - Params: {}
2025-02-13 14:48:02,629 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:48:02,629 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:48:03,367 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:48:03,367 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:48:03,368 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:48:03,368 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:04,568 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:48:04,569 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:04,811 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:48:04,811 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:06,951 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 14:48:06,951 - INFO - Params: {}
2025-02-13 14:48:07,691 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:48:07,692 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:48:08,058 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:48:08,058 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 14:48:08,480 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:48:08,481 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:48:08,523 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:48:08,523 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:08,846 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 14:48:08,846 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:16,451 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 14:48:16,452 - INFO - Params: {}
2025-02-13 14:48:17,452 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:48:17,452 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:48:17,918 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:48:17,918 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:48:17,980 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:48:17,980 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:19,173 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:48:19,173 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 14:48:50,134 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 14:48:50,134 - INFO - Params: None
2025-02-13 14:48:50,136 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 14:48:50,136 - INFO - Params: {}
2025-02-13 14:48:50,956 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 14:50:53,405 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 14:50:53,405 - INFO - Params: None
2025-02-13 14:50:53,432 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 14:57:55,507 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 14:57:55,508 - INFO - Params: None
2025-02-13 14:57:55,535 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 15:02:35,485 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 15:02:35,486 - INFO - Params: None
2025-02-13 15:02:35,506 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 15:02:39,010 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 15:02:39,010 - INFO - Params: {}
2025-02-13 15:02:40,720 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 15:02:40,720 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 15:02:41,247 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 15:02:41,247 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 15:02:41,834 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 15:02:41,834 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 15:02:41,925 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:02:41,926 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 15:02:43,211 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:02:43,211 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 15:02:50,573 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 15:02:50,573 - INFO - Params: None
2025-02-13 15:02:50,596 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 15:02:51,196 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 15:02:51,196 - INFO - Params: {}
2025-02-13 15:02:51,590 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 15:02:51,590 - INFO - Params: {}
2025-02-13 15:02:52,886 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 15:02:52,886 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 15:02:53,446 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 15:02:53,446 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 15:02:53,520 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 15:02:53,520 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 15:02:53,965 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 15:02:53,965 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 15:14:36,834 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 15:14:36,834 - INFO - Params: None
2025-02-13 15:14:36,870 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 15:14:46,078 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 15:14:46,078 - INFO - Params: None
2025-02-13 15:14:46,101 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 15:50:00,734 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 15:50:00,734 - INFO - Params: {}
2025-02-13 15:50:01,081 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 15:50:01,082 - INFO - Params: None
2025-02-13 15:50:01,102 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 15:50:30,864 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 15:50:30,864 - INFO - Params: None
2025-02-13 15:50:30,897 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:06:43,383 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:06:43,384 - INFO - Params: {}
2025-02-13 16:07:35,221 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:07:35,221 - INFO - Params: {}
2025-02-13 16:07:35,735 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:07:35,736 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:07:38,534 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:07:38,534 - INFO - Params: {}
2025-02-13 16:07:38,948 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:07:38,948 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:07:39,416 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:07:39,416 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 16:07:39,417 - INFO - Executing query: 
2025-02-13 16:07:39,418 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 16:07:39,753 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:07:54,859 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:07:54,859 - INFO - Params: {}
2025-02-13 16:07:55,787 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:07:55,787 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:07:56,294 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:07:56,295 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:07:56,296 - INFO - Executing query: 
2025-02-13 16:07:56,296 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 16:07:56,323 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:07:56,766 - INFO - Executing query: 
2025-02-13 16:07:56,766 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 16:07:56,786 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:07:58,223 - INFO - Executing query: 
2025-02-13 16:07:58,223 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 16:07:58,262 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:08:25,946 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:08:25,946 - INFO - Params: {'municipal_districts_0': 'Восточный'}
2025-02-13 16:08:26,020 - INFO - Executing query: 
2025-02-13 16:08:26,020 - INFO - Params: {'municipal_0': 'Восточный'}
2025-02-13 16:08:26,045 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:08:26,677 - INFO - Executing query: 
2025-02-13 16:08:26,677 - INFO - Params: {'house_address_0': 'Акулово пос., д.14', 'municipal_0': 'Восточный'}
2025-02-13 16:08:26,690 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:08:27,675 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:08:27,675 - INFO - Params: {}
2025-02-13 16:08:27,945 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:08:27,945 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 16:08:28,544 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:08:28,544 - INFO - Params: {'municipal_districts_0': 'Старое Крюково'}
2025-02-13 16:08:28,546 - INFO - Executing query: 
2025-02-13 16:08:28,546 - INFO - Params: {'municipal_0': 'Старое Крюково'}
2025-02-13 16:08:28,597 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:08:29,064 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:08:29,064 - INFO - Params: {'municipal_districts_0': 'Старое Крюково'}
2025-02-13 16:08:29,107 - INFO - Executing query: 
2025-02-13 16:08:29,107 - INFO - Params: {'municipal_0': 'Старое Крюково'}
2025-02-13 16:08:29,128 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:08:29,604 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:08:29,604 - INFO - Params: {'municipal_districts_0': 'Старое Крюково'}
2025-02-13 16:08:29,648 - INFO - Executing query: 
2025-02-13 16:08:29,649 - INFO - Params: {'municipal_0': 'Старое Крюково'}
2025-02-13 16:08:29,661 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:08:29,929 - INFO - Executing query: 
2025-02-13 16:08:29,929 - INFO - Params: {'house_address_0': 'Солнечная аллея кор.934', 'municipal_0': 'Старое Крюково'}
2025-02-13 16:08:29,941 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:14:53,606 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:14:53,607 - INFO - Params: {}
2025-02-13 16:15:01,685 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:15:01,685 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:15:07,257 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:15:07,257 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:15:18,419 - INFO - Executing query: 
2025-02-13 16:15:18,419 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 16:15:18,440 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:19:52,249 - INFO - Executing query: 
2025-02-13 16:19:52,249 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 16:19:52,660 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:20:47,619 - INFO - Executing query: 
2025-02-13 16:20:47,619 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 16:20:48,029 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:20:48,029 - ERROR - 
2025-02-13 16:21:57,695 - INFO - Executing query: 
2025-02-13 16:21:57,695 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 16:21:58,368 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:21:58,368 - ERROR - 
2025-02-13 16:23:29,337 - INFO - Executing query: 
2025-02-13 16:23:29,337 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 16:23:29,741 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:23:29,741 - ERROR - 
2025-02-13 16:30:14,471 - INFO - Executing query: 
2025-02-13 16:30:14,471 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 16:30:14,899 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 16:30:14,900 - ERROR - 
2025-02-13 16:42:07,303 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:42:07,304 - INFO - Params: {}
2025-02-13 16:42:08,965 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:42:08,965 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:42:09,474 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:42:09,474 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:42:09,475 - INFO - Executing query: where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:42:09,475 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 16:42:09,750 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: where municipal_district IN ($1) AND rn = 1]
[parameters: ('Богородское',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:42:09,751 - ERROR - where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:42:09,962 - INFO - Executing query: where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:42:09,962 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 16:42:09,982 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Кузнецовская ул., д.7', 'Богородское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:42:09,982 - ERROR - where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:42:11,377 - INFO - Executing query: where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:42:11,377 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 16:42:11,408 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Кузнецовская ул., д.7', 'Богородское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:42:11,408 - ERROR - where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:42:11,642 - INFO - Executing query: where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:42:11,643 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 16:42:11,669 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Кузнецовская ул., д.7', 'Богородское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:42:11,669 - ERROR - where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:05,339 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:43:05,339 - INFO - Params: {}
2025-02-13 16:43:06,614 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:43:06,614 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:43:07,261 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:43:07,261 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 16:43:07,263 - INFO - Executing query: where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:07,263 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 16:43:07,508 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: where municipal_district IN ($1) AND rn = 1]
[parameters: ('Восточное Измайлово',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:43:07,508 - ERROR - where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:07,767 - INFO - Executing query: where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:07,767 - INFO - Params: {'house_address_0': 'Измайловский бульв., д.71/25 кор.1', 'municipal_0': 'Восточное Измайлово'}
2025-02-13 16:43:07,786 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Измайловский бульв., д.71/25 кор.1', 'Восточное Измайлово')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:43:07,786 - ERROR - where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:09,044 - INFO - Executing query: where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:09,044 - INFO - Params: {'house_address_0': 'Измайловский бульв., д.71/25 кор.1', 'municipal_0': 'Восточное Измайлово'}
2025-02-13 16:43:09,062 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Измайловский бульв., д.71/25 кор.1', 'Восточное Измайлово')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:43:09,062 - ERROR - where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:40,379 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:40,380 - INFO - Params: {'house_address_0': 'Измайловский бульв., д.71/25 кор.2', 'municipal_0': 'Восточное Измайлово'}
2025-02-13 16:43:40,494 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:43:40,494 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 16:43:40,795 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:40,795 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 16:43:40,938 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Измайловский бульв., д.71/25 кор.2', 'Восточное Измайлово')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:43:40,938 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:41,055 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Восточное Измайлово',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:43:41,055 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:41,155 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:41,155 - INFO - Params: {'municipal_0': 'Гольяново'}
2025-02-13 16:43:41,227 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Гольяново',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:43:41,227 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:41,447 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:43:41,447 - INFO - Params: {'municipal_districts_0': 'Гольяново'}
2025-02-13 16:43:42,171 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:43:42,171 - INFO - Params: {'house_address_0': 'Амурская ул., д.26', 'municipal_0': 'Гольяново'}
2025-02-13 16:43:42,190 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Амурская ул., д.26', 'Гольяново')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:43:42,190 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:49,491 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:49,491 - INFO - Params: {'house_address_0': 'Амурская ул., д.32', 'municipal_0': 'Гольяново'}
2025-02-13 16:47:49,921 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Амурская ул., д.32', 'Гольяново')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:47:49,921 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:50,000 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:47:50,000 - INFO - Params: {}
2025-02-13 16:47:50,746 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:47:50,746 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:47:51,594 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:47:51,594 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:47:51,664 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:51,664 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 16:47:51,683 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Богородское',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:47:51,683 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:51,941 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:51,942 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.2', 'municipal_0': 'Богородское'}
2025-02-13 16:47:51,962 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Миллионная ул., д.8 кор.2', 'Богородское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:47:51,962 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:53,064 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:47:53,064 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.2', 'municipal_0': 'Богородское'}
2025-02-13 16:47:53,086 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Миллионная ул., д.8 кор.2', 'Богородское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:47:53,086 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:48:09,134 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:48:09,134 - INFO - Params: {'municipal_districts_0': 'Ивановское'}
2025-02-13 16:48:09,208 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:48:09,208 - INFO - Params: {'municipal_0': 'Ивановское'}
2025-02-13 16:48:09,236 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Ивановское',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:48:09,236 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:48:09,449 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:48:09,449 - INFO - Params: {'house_address_0': 'Зеленый просп., д.101', 'municipal_0': 'Ивановское'}
2025-02-13 16:48:09,469 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Зеленый просп., д.101', 'Ивановское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:48:09,469 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:03,132 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:54:03,132 - INFO - Params: {'municipal_districts_0': 'Ивановское'}
2025-02-13 16:54:03,135 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:03,136 - INFO - Params: {'municipal_0': 'Ивановское'}
2025-02-13 16:54:03,392 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:54:03,392 - INFO - Params: {'municipal_districts_0': 'Косино-Ухтомский'}
2025-02-13 16:54:03,492 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:03,492 - INFO - Params: {'municipal_0': 'Косино-Ухтомский'}
2025-02-13 16:54:03,905 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Ивановское',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:54:03,905 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:04,091 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Косино-Ухтомский',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:54:04,091 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:04,471 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:04,471 - INFO - Params: {'house_address_0': 'Камова ул., д.3', 'municipal_0': 'Косино-Ухтомский'}
2025-02-13 16:54:04,490 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Камова ул., д.3', 'Косино-Ухтомский')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:54:04,490 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:06,428 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:54:06,428 - INFO - Params: {}
2025-02-13 16:54:07,371 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:54:07,371 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:54:07,820 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:54:07,820 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:54:07,822 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:07,822 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 16:54:07,861 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Богородское',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:54:07,861 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:08,346 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:08,346 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.2', 'municipal_0': 'Богородское'}
2025-02-13 16:54:08,363 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Миллионная ул., д.8 кор.2', 'Богородское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:54:08,364 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:45,984 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:54:45,984 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.3', 'municipal_0': 'Богородское'}
2025-02-13 16:54:46,345 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Миллионная ул., д.8 кор.3', 'Богородское')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:54:46,345 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:55:13,702 - INFO - Executing query:  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:55:13,702 - INFO - Params: {'municipal_0': 'Восточный'}
2025-02-13 16:55:13,705 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:55:13,705 - INFO - Params: {'municipal_districts_0': 'Восточный'}
2025-02-13 16:55:14,059 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where municipal_district IN ($1) AND rn = 1]
[parameters: ('Восточный',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:55:14,060 - ERROR -  where municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:55:14,880 - INFO - Executing query:  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:55:14,880 - INFO - Params: {'house_address_0': 'Акулово пос., д.13', 'municipal_0': 'Восточный'}
2025-02-13 16:55:14,912 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL:  where house_address IN ($1) AND municipal_district IN ($2) AND rn = 1]
[parameters: ('Акулово пос., д.13', 'Восточный')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 16:55:14,912 - ERROR -  where house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
2025-02-13 16:57:44,265 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:57:44,265 - INFO - Params: {'house_address_0': 'Акулово пос., д.14', 'municipal_0': 'Восточный'}
2025-02-13 16:57:45,019 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:57:45,019 - INFO - Params: {}
2025-02-13 16:57:48,385 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:57:48,385 - INFO - Params: {}
2025-02-13 16:57:48,936 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:57:48,936 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:57:49,423 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:57:49,423 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:57:49,424 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:57:49,424 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 16:57:49,840 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:57:49,840 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 16:57:51,462 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:57:51,462 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 16:57:52,072 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:57:52,073 - INFO - Params: {}
2025-02-13 16:57:52,972 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:57:52,973 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:57:53,350 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:57:53,350 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 16:57:53,351 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:57:53,351 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:57:53,842 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:57:53,842 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'municipal_0': 'Богородское'}
2025-02-13 16:57:58,167 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 16:57:58,167 - INFO - Params: {}
2025-02-13 16:57:58,737 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:57:58,737 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 16:57:59,675 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:57:59,675 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-13 16:57:59,735 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:57:59,735 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-13 16:58:00,055 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:00,056 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.6', 'municipal_0': 'NaN'}
2025-02-13 16:58:00,894 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:00,894 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.6', 'municipal_0': 'NaN'}
2025-02-13 16:58:07,804 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:07,804 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.7', 'municipal_0': 'NaN'}
2025-02-13 16:58:14,302 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:14,304 - INFO - Params: {'house_address_0': 'поселение Рязановское, посёлок Остафьево, д.7', 'municipal_0': 'NaN'}
2025-02-13 16:58:14,578 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:14,578 - INFO - Params: {'house_address_0': 'поселение Рязановское, посёлок Остафьево, д.7', 'municipal_0': 'NaN'}
2025-02-13 16:58:24,010 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:58:24,010 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-13 16:58:24,079 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:24,079 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-13 16:58:24,868 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:58:24,868 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 16:58:25,294 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:58:25,294 - INFO - Params: {'municipal_districts_0': 'Внуково'}
2025-02-13 16:58:25,295 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:25,295 - INFO - Params: {'municipal_0': 'Внуково'}
2025-02-13 16:58:25,827 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:58:25,827 - INFO - Params: {'house_address_0': 'Осипенко ул. (пос.Толстопальцево), д.8 стр. 3', 'municipal_0': 'Внуково'}
2025-02-13 16:58:33,467 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:58:33,467 - INFO - Params: {}
2025-02-13 16:58:33,756 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:58:33,756 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 16:58:34,272 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:58:34,272 - INFO - Params: {'municipal_districts_0': 'Старое Крюково'}
2025-02-13 16:58:34,273 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:58:34,273 - INFO - Params: {'municipal_0': 'Старое Крюково'}
2025-02-13 16:58:35,121 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:58:35,121 - INFO - Params: {'house_address_0': 'Зеленоград г. кор.848', 'municipal_0': 'Старое Крюково'}
2025-02-13 16:58:36,937 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:58:36,937 - INFO - Params: {'house_address_0': 'Солнечная аллея кор.934', 'municipal_0': 'Старое Крюково'}
2025-02-13 16:58:41,036 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:58:41,036 - INFO - Params: {'house_address_0': 'Зеленоград г. кор.848', 'municipal_0': 'Старое Крюково'}
2025-02-13 16:58:50,570 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:58:50,570 - INFO - Params: {'house_address_0': 'Солнечная аллея кор.934', 'municipal_0': 'Старое Крюково'}
2025-02-13 16:58:51,530 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:58:51,530 - INFO - Params: {'municipal_districts_0': 'Старое Крюково'}
2025-02-13 16:58:51,531 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 16:58:51,531 - INFO - Params: {'municipal_0': 'Старое Крюково'}
2025-02-13 17:00:24,179 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:00:24,179 - INFO - Params: None
2025-02-13 17:00:24,203 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:00:27,136 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:00:27,136 - INFO - Params: None
2025-02-13 17:00:27,154 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:00:27,371 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:00:27,371 - INFO - Params: {}
2025-02-13 17:00:29,796 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:00:29,796 - INFO - Params: {}
2025-02-13 17:00:30,224 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:00:30,224 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 17:00:30,709 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:00:30,709 - INFO - Params: {'municipal_districts_0': 'Восточное Измайлово'}
2025-02-13 17:00:30,709 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:00:30,710 - INFO - Params: {'municipal_0': 'Восточное Измайлово'}
2025-02-13 17:00:31,885 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:00:31,885 - INFO - Params: {'house_address_0': 'Парковая 13-я ул., д.16А', 'municipal_0': 'Восточное Измайлово'}
2025-02-13 17:00:32,205 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:00:32,205 - INFO - Params: {'house_address_0': 'Парковая 13-я ул., д.16А', 'municipal_0': 'Восточное Измайлово'}
2025-02-13 17:00:40,320 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:00:40,320 - INFO - Params: {}
2025-02-13 17:01:34,542 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:01:34,542 - INFO - Params: {}
2025-02-13 17:01:35,197 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:01:35,197 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 17:01:35,844 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:01:35,844 - INFO - Params: {'municipal_districts_0': '#6101'}
2025-02-13 17:01:35,900 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:01:35,900 - INFO - Params: {'municipal_0': '#6101'}
2025-02-13 17:01:36,278 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:01:36,278 - INFO - Params: {'house_address_0': 'Лермонтовский просп., д.161', 'municipal_0': '#6101'}
2025-02-13 17:01:55,452 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:01:55,452 - INFO - Params: {}
2025-02-13 17:01:56,058 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:01:56,058 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 17:01:57,029 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:01:57,029 - INFO - Params: {'municipal_districts_0': 'Крюково'}
2025-02-13 17:01:57,077 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:01:57,077 - INFO - Params: {'municipal_0': 'Крюково'}
2025-02-13 17:01:57,410 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:01:57,410 - INFO - Params: {'house_address_0': 'Георгиевский пр-т кор.1934', 'municipal_0': 'Крюково'}
2025-02-13 17:01:58,798 - INFO - Executing query: 
2025-02-13 17:01:58,798 - INFO - Params: {'apart_id': 8867006}
2025-02-13 17:01:58,821 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 17:01:59,735 - INFO - Executing query: 
2025-02-13 17:01:59,735 - INFO - Params: {'apart_id': 8867006}
2025-02-13 17:01:59,765 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 17:02:25,954 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND room_count IN (:room_0, :room_1, :room_2) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:02:25,954 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 17:02:42,384 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:02:42,384 - INFO - Params: {}
2025-02-13 17:02:42,909 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:02:42,910 - INFO - Params: {}
2025-02-13 17:02:50,749 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:02:50,750 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 17:02:55,051 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:02:55,051 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 17:02:56,751 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:02:56,751 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 17:03:03,597 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND room_count IN (:room_0, :room_1, :room_2) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:03:03,597 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'room_0': 1, 'room_1': 2, 'room_2': 3}
2025-02-13 17:03:08,223 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND room_count IN (:room_0, :room_1) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:03:08,223 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'room_0': 1, 'room_1': 2}
2025-02-13 17:04:19,863 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND room_count IN (:room_0, :room_1) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:04:19,863 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'room_0': 1, 'room_1': 2}
2025-02-13 17:05:04,989 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:05:04,990 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7'}
2025-02-13 17:05:09,493 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND room_count IN (:room_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:05:09,493 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'room_0': 1}
2025-02-13 17:05:12,508 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND room_count IN (:room_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:05:12,508 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'room_0': 1}
2025-02-13 17:05:32,519 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND room_count IN (:room_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:05:32,519 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'room_0': 1}
2025-02-13 17:05:50,381 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:05:50,382 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7'}
2025-02-13 17:06:09,968 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and room_count IN (:room_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:06:09,969 - INFO - Params: {'room_0': 1}
2025-02-13 17:07:07,940 - INFO - Executing query: 
2025-02-13 17:07:07,940 - INFO - Params: {'apart_id': 8866992}
2025-02-13 17:07:08,351 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 17:07:08,564 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:07:08,565 - INFO - Params: {}
2025-02-13 17:07:09,384 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:07:09,384 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 17:07:09,809 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:07:09,809 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 17:07:09,874 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:07:09,874 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 17:07:10,282 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:07:10,283 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 17:07:13,307 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:07:13,308 - INFO - Params: {'house_address_0': 'Миллионная ул., д.8 кор.3', 'municipal_0': 'Богородское'}
2025-02-13 17:07:14,441 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:07:14,441 - INFO - Params: {'municipal_districts_0': 'Измайлово'}
2025-02-13 17:07:14,446 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:07:14,446 - INFO - Params: {'municipal_0': 'Измайлово'}
2025-02-13 17:07:14,908 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:07:14,909 - INFO - Params: {'house_address_0': 'Измайловский бульв., д.15', 'municipal_0': 'Измайлово'}
2025-02-13 17:10:03,831 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:10:03,831 - INFO - Params: {}
2025-02-13 17:10:04,991 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:10:04,991 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:10:05,572 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:10:05,572 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:10:05,577 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:10:05,577 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:06,021 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:10:06,021 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:09,068 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:10:09,068 - INFO - Params: None
2025-02-13 17:10:09,102 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:10:13,441 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:10:13,441 - INFO - Params: {}
2025-02-13 17:10:14,116 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:10:14,116 - INFO - Params: {}
2025-02-13 17:10:15,488 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:10:15,488 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:10:16,229 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:10:16,229 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:10:16,233 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:10:16,234 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:17,758 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:10:17,758 - INFO - Params: {'house_address_0': 'Стандартная ул., д.21 кор.1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:19,404 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:10:19,404 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:46,077 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:10:46,077 - INFO - Params: None
2025-02-13 17:10:46,104 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:10:51,030 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:10:51,030 - INFO - Params: {}
2025-02-13 17:10:51,927 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:10:51,927 - INFO - Params: {}
2025-02-13 17:10:52,902 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:10:52,903 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:10:53,306 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:10:53,306 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 17:10:53,786 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:10:53,786 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:10:53,833 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:10:53,833 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:54,225 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:10:54,225 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:56,607 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:10:56,607 - INFO - Params: {}
2025-02-13 17:10:57,510 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:10:57,510 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:10:58,208 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:10:58,208 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:10:58,212 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:10:58,212 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:10:58,559 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:10:58,559 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:11:04,333 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:11:04,333 - INFO - Params: None
2025-02-13 17:11:04,366 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:11:47,202 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:11:47,202 - INFO - Params: {}
2025-02-13 17:11:47,848 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:11:47,849 - INFO - Params: {}
2025-02-13 17:11:48,300 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:11:48,300 - INFO - Params: {}
2025-02-13 17:11:49,054 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:11:49,054 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 17:11:49,458 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:11:49,458 - INFO - Params: {'municipal_districts_0': '#6101'}
2025-02-13 17:11:49,463 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:49,463 - INFO - Params: {'municipal_0': '#6101'}
2025-02-13 17:11:49,973 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:49,973 - INFO - Params: {'house_address_0': 'Лермонтовский просп., д.161', 'municipal_0': '#6101'}
2025-02-13 17:11:51,861 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:11:51,861 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 17:11:52,257 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:11:52,257 - INFO - Params: {'municipal_districts_0': 'Внуково'}
2025-02-13 17:11:52,262 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:52,262 - INFO - Params: {'municipal_0': 'Внуково'}
2025-02-13 17:11:52,729 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:52,729 - INFO - Params: {'house_address_0': 'Осипенко ул. (пос.Толстопальцево), д.8 стр. 3', 'municipal_0': 'Внуково'}
2025-02-13 17:11:53,364 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:53,364 - INFO - Params: {'house_address_0': 'Осипенко ул. (пос.Толстопальцево), д.8 стр. 3', 'municipal_0': 'Внуково'}
2025-02-13 17:11:54,206 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:11:54,206 - INFO - Params: {}
2025-02-13 17:11:54,672 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:11:54,672 - INFO - Params: {}
2025-02-13 17:11:55,356 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:11:55,356 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:11:56,722 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:11:56,722 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:11:56,727 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:56,727 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:11:58,224 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:58,225 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:11:58,425 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:58,425 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:11:59,853 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:11:59,853 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:11:59,857 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:11:59,857 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:12:01,774 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:12:01,774 - INFO - Params: {}
2025-02-13 17:12:02,424 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:12:02,424 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 17:12:02,757 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:12:02,757 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 17:12:02,762 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:12:02,762 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 17:12:03,393 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:12:03,393 - INFO - Params: {'house_address_0': 'Гражданская 3-я ул., д.21', 'municipal_0': 'Богородское'}
2025-02-13 17:12:49,081 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:12:49,081 - INFO - Params: {}
2025-02-13 17:12:49,083 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:12:49,083 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 17:12:50,413 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:12:50,413 - INFO - Params: {'municipal_districts_0': 'Кунцево'}
2025-02-13 17:12:50,417 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:12:50,417 - INFO - Params: {'municipal_0': 'Кунцево'}
2025-02-13 17:12:50,911 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:12:50,912 - INFO - Params: {'house_address_0': 'Екатерины Будановой ул., д.22', 'municipal_0': 'Кунцево'}
2025-02-13 17:12:53,288 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:12:53,288 - INFO - Params: {'house_address_0': 'Екатерины Будановой ул., д.22', 'municipal_0': 'Кунцево'}
2025-02-13 17:12:53,877 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:12:53,877 - INFO - Params: {'house_address_0': 'Ивана Франко ул., д.18 кор.1', 'municipal_0': 'Кунцево'}
2025-02-13 17:13:06,903 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:13:06,903 - INFO - Params: {'house_address_0': 'Ивана Франко ул., д.22 кор.4', 'municipal_0': 'Кунцево'}
2025-02-13 17:13:07,624 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:13:07,624 - INFO - Params: {'municipal_districts_0': 'Раменки'}
2025-02-13 17:13:07,628 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:13:07,629 - INFO - Params: {'municipal_0': 'Раменки'}
2025-02-13 17:14:31,561 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:14:31,561 - INFO - Params: {'house_address_0': 'Коцюбинского ул., д.8 кор.1', 'municipal_0': 'Кунцево'}
2025-02-13 17:14:31,965 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "house_address")
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Коцюбинского ул., д.8 кор.1', 'Кунцево')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:14:33,046 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:14:33,046 - INFO - Params: {}
2025-02-13 17:14:33,992 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:14:33,992 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 17:14:34,405 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:14:34,406 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-13 17:14:34,481 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:14:34,481 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-13 17:14:34,513 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "municipal_district")
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 municipal_district IN ($1) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('NaN',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:14:34,877 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:14:34,877 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.6', 'municipal_0': 'NaN'}
2025-02-13 17:14:34,900 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "house_address")
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('1-я Железнодорожная улица, д.6', 'NaN')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:14:36,432 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:14:36,432 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:14:36,577 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:14:36,577 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 17:14:39,152 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:14:39,152 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:14:39,157 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:14:39,157 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:14:39,496 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "municipal_district")
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 municipal_district IN ($1) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Алтуфьевский',)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:14:39,592 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:14:39,592 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:14:39,620 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "house_address")
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Инженерная ул., дом 10, корп. 1', 'Алтуфьевский')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:14:40,803 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:14:40,803 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:14:40,832 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "house_address")
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Инженерная ул., дом 10, корп. 1', 'Алтуфьевский')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:14:41,289 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:14:41,289 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:14:41,309 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "house_address")
[SQL: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 house_address IN ($1) AND municipal_district IN ($2) AND rn = 1
                ORDER BY full_living_area
            ]
[parameters: ('Инженерная ул., дом 10, корп. 1', 'Алтуфьевский')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:16:34,660 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:16:34,660 - INFO - Params: {}
2025-02-13 17:16:34,665 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:34,665 - INFO - Params: {'house_address_0': 'поселение Рязановское, посёлок Остафьево, д.7', 'municipal_0': 'NaN'}
2025-02-13 17:16:35,502 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:16:35,502 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 17:16:35,918 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:16:35,918 - INFO - Params: {'municipal_districts_0': '#6101'}
2025-02-13 17:16:36,032 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:36,032 - INFO - Params: {'municipal_0': '#6101'}
2025-02-13 17:16:36,468 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:36,468 - INFO - Params: {'house_address_0': 'Лермонтовский просп., д.161', 'municipal_0': '#6101'}
2025-02-13 17:16:37,939 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:16:37,939 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:16:38,269 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:16:38,269 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:16:38,274 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:38,274 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:16:38,692 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:38,692 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:16:49,221 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:49,221 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:16:50,070 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:50,070 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 20, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:16:50,922 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:16:50,922 - INFO - Params: {'district_0': 'Московская область'}
2025-02-13 17:16:51,370 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:16:51,370 - INFO - Params: {'municipal_districts_0': 'Одинцовский'}
2025-02-13 17:16:51,375 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:51,375 - INFO - Params: {'municipal_0': 'Одинцовский'}
2025-02-13 17:16:51,801 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:51,801 - INFO - Params: {'house_address_0': 'Железнодорожная ул .с.Жаворонки Одинцовский р-н, д.10', 'municipal_0': 'Одинцовский'}
2025-02-13 17:16:53,581 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:16:53,581 - INFO - Params: {'house_address_0': 'Железнодорожная ул .с.Жаворонки Одинцовский р-н, д.10', 'municipal_0': 'Одинцовский'}
2025-02-13 17:17:25,751 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:17:25,751 - INFO - Params: {'house_address_0': 'Железнодорожная ул .с.Жаворонки Одинцовский р-н, д.10', 'municipal_0': 'Одинцовский'}
2025-02-13 17:17:25,757 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:17:25,757 - INFO - Params: {'municipal_0': 'Одинцовский'}
2025-02-13 17:17:25,759 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:17:25,759 - INFO - Params: {'municipal_districts_0': 'Одинцовский'}
2025-02-13 17:17:25,761 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:17:25,761 - INFO - Params: {'district_0': 'Новомосковский АО'}
2025-02-13 17:17:26,502 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:17:26,502 - INFO - Params: {'municipal_0': 'Одинцовский'}
2025-02-13 17:17:26,621 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:17:26,621 - INFO - Params: {'municipal_districts_0': 'Одинцовский'}
2025-02-13 17:18:10,385 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:18:10,386 - INFO - Params: {'house_address_0': 'Железнодорожная ул .с.Жаворонки Одинцовский р-н, д.10', 'municipal_0': 'Одинцовский'}
2025-02-13 17:18:10,774 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:18:10,774 - INFO - Params: {'municipal_districts_0': 'Одинцовский'}
2025-02-13 17:18:10,779 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:18:10,779 - INFO - Params: {'municipal_0': 'Одинцовский'}
2025-02-13 17:18:12,143 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:18:12,143 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 17:18:13,470 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:18:13,470 - INFO - Params: {'municipal_districts_0': 'Крюково'}
2025-02-13 17:18:13,475 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:18:13,475 - INFO - Params: {'municipal_0': 'Крюково'}
2025-02-13 17:18:13,944 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY o.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:18:13,944 - INFO - Params: {'house_address_0': 'Зеленоград, Заводская ул. (Крюково), д.10', 'municipal_0': 'Крюково'}
2025-02-13 17:20:54,022 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:20:54,022 - INFO - Params: {'house_address_0': 'Зеленоград, Заводская ул. (Крюково), д.12Б', 'municipal_0': 'Крюково'}
2025-02-13 17:22:14,158 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:22:14,158 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:22:14,992 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:22:14,992 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:22:14,997 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:22:14,997 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:22:15,360 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:22:15,360 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:22:17,620 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:22:17,620 - INFO - Params: None
2025-02-13 17:22:17,786 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:22:22,073 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:22:22,073 - INFO - Params: {}
2025-02-13 17:22:22,978 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:22:22,978 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:22:23,344 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:22:23,344 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:22:23,348 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:22:23,349 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:22:23,745 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:22:23,745 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:22:43,320 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:22:43,320 - INFO - Params: None
2025-02-13 17:22:43,339 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:25:00,794 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:25:00,794 - INFO - Params: None
2025-02-13 17:25:00,819 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:30:55,074 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:30:55,074 - INFO - Params: None
2025-02-13 17:30:55,106 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:31:02,986 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:31:02,986 - INFO - Params: {}
2025-02-13 17:31:04,227 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:31:04,227 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:31:05,055 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:31:05,055 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:31:05,118 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:05,119 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:05,439 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:05,439 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:07,588 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:07,588 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:08,650 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:08,650 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:08,942 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:08,942 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:09,386 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:09,386 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:09,762 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:09,762 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:10,174 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:10,174 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:10,521 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:10,521 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:10,932 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:10,932 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:11,306 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:11,306 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:20,806 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:20,806 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:21,519 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:21,520 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 20, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:40,739 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:31:40,740 - INFO - Params: {}
2025-02-13 17:31:41,556 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:31:41,557 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:31:41,869 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:31:41,869 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 17:31:42,367 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:31:42,367 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:31:42,371 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:31:42,371 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:42,752 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:31:42,753 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:44,158 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:31:44,159 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:45,415 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:31:45,415 - INFO - Params: {}
2025-02-13 17:31:46,203 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:31:46,203 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:31:46,922 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:31:46,922 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:31:46,927 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:46,927 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:47,193 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:31:47,193 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:31:48,868 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:31:48,868 - INFO - Params: None
2025-02-13 17:31:48,896 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:31:51,412 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:31:51,412 - INFO - Params: None
2025-02-13 17:31:51,430 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:31:52,753 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:31:52,753 - INFO - Params: None
2025-02-13 17:31:52,772 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:31:55,080 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:31:55,080 - INFO - Params: None
2025-02-13 17:31:55,107 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:32:07,856 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:32:07,856 - INFO - Params: {}
2025-02-13 17:32:09,178 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:32:09,178 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:32:09,569 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:32:09,569 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 17:32:10,083 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:32:10,083 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:32:10,150 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:32:10,150 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:32:10,662 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC NULLS LAST, o.answer_date DESC NULLS LAST) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:32:10,662 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:33:24,982 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:33:24,983 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:33:24,999 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:24,999 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:33:27,107 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:33:27,107 - INFO - Params: {}
2025-02-13 17:33:27,967 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:33:27,967 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:33:28,803 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:33:28,803 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:33:28,808 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:28,809 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:33:29,222 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:29,222 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:33:30,191 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:30,191 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:33:30,896 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:33:30,896 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 17:33:32,069 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:33:32,069 - INFO - Params: {'municipal_districts_0': 'Внуково'}
2025-02-13 17:33:32,074 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:32,074 - INFO - Params: {'municipal_0': 'Внуково'}
2025-02-13 17:33:32,379 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:32,379 - INFO - Params: {'house_address_0': 'Осипенко ул. (пос.Толстопальцево), д.8 стр. 3', 'municipal_0': 'Внуково'}
2025-02-13 17:33:36,315 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:36,315 - INFO - Params: {'house_address_0': 'Осипенко ул. (пос.Толстопальцево), д.8 стр. 3', 'municipal_0': 'Внуково'}
2025-02-13 17:33:36,744 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:36,744 - INFO - Params: {'house_address_0': 'Осипенко ул. (пос.Толстопальцево), д.8 стр. 3', 'municipal_0': 'Внуково'}
2025-02-13 17:33:38,291 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:33:38,291 - INFO - Params: {'municipal_districts_0': 'Внуково'}
2025-02-13 17:33:38,296 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:38,296 - INFO - Params: {'municipal_0': 'Внуково'}
2025-02-13 17:33:38,718 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:33:38,719 - INFO - Params: {'municipal_districts_0': 'Внуково'}
2025-02-13 17:33:38,724 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:38,724 - INFO - Params: {'municipal_0': 'Внуково'}
2025-02-13 17:33:51,782 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:51,782 - INFO - Params: {'house_address_0': 'Рейсовая 1-я ул., д.7', 'municipal_0': 'Внуково'}
2025-02-13 17:33:58,599 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:58,600 - INFO - Params: {'house_address_0': 'Рейсовая 2-я ул., д.12', 'municipal_0': 'Внуково'}
2025-02-13 17:33:59,141 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:33:59,142 - INFO - Params: {'house_address_0': 'Рейсовая 2-я ул., д.12', 'municipal_0': 'Внуково'}
2025-02-13 17:34:30,777 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:30,777 - INFO - Params: {'house_address_0': 'Рейсовая 2-я ул., д.14', 'municipal_0': 'Внуково'}
2025-02-13 17:34:32,167 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:32,167 - INFO - Params: {'house_address_0': 'Аэрофлотская ул., д.3', 'municipal_0': 'Внуково'}
2025-02-13 17:34:32,997 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:34:32,998 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 17:34:34,046 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:34:34,046 - INFO - Params: {'municipal_districts_0': '#6101'}
2025-02-13 17:34:34,050 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:34,050 - INFO - Params: {'municipal_0': '#6101'}
2025-02-13 17:34:34,640 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:34,641 - INFO - Params: {'house_address_0': 'Лермонтовский просп., д.161', 'municipal_0': '#6101'}
2025-02-13 17:34:35,474 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:35,475 - INFO - Params: {'house_address_0': 'Лермонтовский просп., д.161', 'municipal_0': '#6101'}
2025-02-13 17:34:35,747 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:35,748 - INFO - Params: {'house_address_0': 'Лермонтовский просп., д.161', 'municipal_0': '#6101'}
2025-02-13 17:34:36,153 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:34:36,153 - INFO - Params: {}
2025-02-13 17:34:36,534 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:34:36,534 - INFO - Params: {}
2025-02-13 17:34:37,308 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:34:37,308 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 17:34:37,981 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:34:37,981 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 17:34:37,985 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:37,985 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 17:34:38,361 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:38,361 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 17:34:43,387 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:43,387 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 17:34:43,660 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN ('Зеленоград, Заводская ул. (Крюково), д.10') AND municipal_district IN ('Крюково') 
                ORDER BY full_living_area
            
2025-02-13 17:34:43,660 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 17:36:03,919 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:36:03,920 - INFO - Params: {}
2025-02-13 17:36:06,426 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:36:06,426 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:36:06,927 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:36:06,927 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:36:06,932 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:06,932 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:36:07,332 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:07,332 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:36:10,886 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:36:10,886 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 17:36:11,738 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:36:11,738 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-13 17:36:11,742 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:11,743 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-13 17:36:12,497 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:12,497 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.6', 'municipal_0': 'NaN'}
2025-02-13 17:36:13,736 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:13,736 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.7', 'municipal_0': 'NaN'}
2025-02-13 17:36:14,323 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:14,323 - INFO - Params: {'house_address_0': '1-я Железнодорожная улица, д.8', 'municipal_0': 'NaN'}
2025-02-13 17:36:15,224 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:36:15,224 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-13 17:36:15,228 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:15,228 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-13 17:36:16,730 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:36:16,730 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:36:16,734 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:36:16,734 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:36:18,225 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:36:18,225 - INFO - Params: {}
2025-02-13 17:36:18,975 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:36:18,975 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 17:36:19,486 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:36:19,487 - INFO - Params: {'municipal_districts_0': 'Крылатское'}
2025-02-13 17:36:19,492 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:36:19,492 - INFO - Params: {'municipal_0': 'Крылатское'}
2025-02-13 17:36:19,879 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:36:19,879 - INFO - Params: {'house_address_0': 'Рублевское шоссе, д.70 кор.2', 'municipal_0': 'Крылатское'}
2025-02-13 17:36:21,811 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-13 17:36:21,811 - INFO - Params: None
2025-02-13 17:36:21,845 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "new_apart_id" не существует
HINT:  Возможно, предполагалась ссылка на столбец "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:36:59,842 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:36:59,842 - INFO - Params: {}
2025-02-13 17:37:00,360 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:37:00,360 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 17:37:00,781 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:37:00,782 - INFO - Params: {'municipal_districts_0': 'Внуково'}
2025-02-13 17:37:00,787 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:37:00,787 - INFO - Params: {'municipal_0': 'Внуково'}
2025-02-13 17:37:01,247 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:37:01,247 - INFO - Params: {'house_address_0': 'Аэрофлотская ул., д.3', 'municipal_0': 'Внуково'}
2025-02-13 17:37:04,818 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:37:04,818 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 17:37:05,253 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:37:05,253 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 17:37:05,257 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:37:05,257 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 17:37:06,571 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:37:06,571 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 17:37:48,205 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:37:48,205 - INFO - Params: {}
2025-02-13 17:37:49,929 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:37:49,929 - INFO - Params: {'district_0': 'Московская область'}
2025-02-13 17:37:50,408 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:37:50,408 - INFO - Params: {'district_0': 'Новомосковский АО'}
2025-02-13 17:37:50,683 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:37:50,683 - INFO - Params: {'municipal_districts_0': 'Одинцовский'}
2025-02-13 17:37:50,686 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:37:50,686 - INFO - Params: {'municipal_0': 'Одинцовский'}
2025-02-13 17:37:51,192 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:37:51,193 - INFO - Params: {'house_address_0': 'Железнодорожная ул .с.Жаворонки Одинцовский р-н, д.10', 'municipal_0': 'Одинцовский'}
2025-02-13 17:43:00,205 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:43:00,205 - INFO - Params: {}
2025-02-13 17:43:01,294 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:43:01,294 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 17:43:01,619 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:43:01,619 - INFO - Params: {'municipal_districts_0': 'Внуково'}
2025-02-13 17:43:01,623 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:43:01,623 - INFO - Params: {'municipal_0': 'Внуково'}
2025-02-13 17:43:02,134 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:43:02,134 - INFO - Params: {'house_address_0': 'Аэрофлотская ул., д.3', 'municipal_0': 'Внуково'}
2025-02-13 17:43:16,152 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 17:43:16,152 - INFO - Params: {}
2025-02-13 17:43:18,466 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:43:18,466 - INFO - Params: {'district_0': 'Московская область'}
2025-02-13 17:43:18,879 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:43:18,879 - INFO - Params: {'municipal_districts_0': 'Одинцовский'}
2025-02-13 17:43:18,885 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:43:18,885 - INFO - Params: {'municipal_0': 'Одинцовский'}
2025-02-13 17:43:19,367 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 17:43:19,367 - INFO - Params: {'house_address_0': 'Железнодорожная ул .с.Жаворонки Одинцовский р-н, д.10', 'municipal_0': 'Одинцовский'}
2025-02-13 17:43:49,669 - INFO - Executing query: WITH new_apartment_list AS (
    SELECT 
        o.family_apartment_needs_id,
        JSON_AGG(
            JSON_BUILD_OBJECT(
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', COALESCE(s.status, '?'),
                'sentence_date', o.sentence_date :: DATE,
                'answer_date', o.answer_date :: DATE
            )
        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
    FROM 
        offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    GROUP BY 
        o.family_apartment_needs_id
)
SELECT 
    fan.family_apartment_needs_id,
    fs.house_address,
    fs.apart_number,
    fs.district,
    fs.municipal_district,
    fs.full_living_area,
    fs.total_living_area,
    fs.living_area,
    fs.room_count,
    fs.type_of_settlement,
    nal.new_apartments
FROM 
    family_apartment_needs fan
LEFT JOIN 
    family_structure fs ON fan.affair_id = fs.affair_id
LEFT JOIN 
    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
WHERE
    fan.family_apartment_needs_id = {apartment_id}
ORDER BY 
    fs.affair_id;

2025-02-13 17:43:49,669 - INFO - Params: {'apart_id': 848354}
2025-02-13 17:43:49,735 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "{")
[SQL: WITH new_apartment_list AS (
    SELECT 
        o.family_apartment_needs_id,
        JSON_AGG(
            JSON_BUILD_OBJECT(
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', COALESCE(s.status, '?'),
                'sentence_date', o.sentence_date :: DATE,
                'answer_date', o.answer_date :: DATE
            )
        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
    FROM 
        offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    GROUP BY 
        o.family_apartment_needs_id
)
SELECT 
    fan.family_apartment_needs_id,
    fs.house_address,
    fs.apart_number,
    fs.district,
    fs.municipal_district,
    fs.full_living_area,
    fs.total_living_area,
    fs.living_area,
    fs.room_count,
    fs.type_of_settlement,
    nal.new_apartments
FROM 
    family_apartment_needs fan
LEFT JOIN 
    family_structure fs ON fan.affair_id = fs.affair_id
LEFT JOIN 
    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
WHERE
    fan.family_apartment_needs_id = {apartment_id}
ORDER BY 
    fs.affair_id;
]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:44:10,822 - INFO - Executing query: WITH new_apartment_list AS (
    SELECT 
        o.family_apartment_needs_id,
        JSON_AGG(
            JSON_BUILD_OBJECT(
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', COALESCE(s.status, '?'),
                'sentence_date', o.sentence_date :: DATE,
                'answer_date', o.answer_date :: DATE
            )
        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
    FROM 
        offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    GROUP BY 
        o.family_apartment_needs_id
)
SELECT 
    fan.family_apartment_needs_id,
    fs.house_address,
    fs.apart_number,
    fs.district,
    fs.municipal_district,
    fs.full_living_area,
    fs.total_living_area,
    fs.living_area,
    fs.room_count,
    fs.type_of_settlement,
    nal.new_apartments
FROM 
    family_apartment_needs fan
LEFT JOIN 
    family_structure fs ON fan.affair_id = fs.affair_id
LEFT JOIN 
    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
WHERE
    fan.family_apartment_needs_id = {apartment_id}
ORDER BY 
    fs.affair_id;

2025-02-13 17:44:10,822 - INFO - Params: {'apart_id': 848356}
2025-02-13 17:44:10,898 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "{")
[SQL: WITH new_apartment_list AS (
    SELECT 
        o.family_apartment_needs_id,
        JSON_AGG(
            JSON_BUILD_OBJECT(
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', COALESCE(s.status, '?'),
                'sentence_date', o.sentence_date :: DATE,
                'answer_date', o.answer_date :: DATE
            )
        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
    FROM 
        offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    GROUP BY 
        o.family_apartment_needs_id
)
SELECT 
    fan.family_apartment_needs_id,
    fs.house_address,
    fs.apart_number,
    fs.district,
    fs.municipal_district,
    fs.full_living_area,
    fs.total_living_area,
    fs.living_area,
    fs.room_count,
    fs.type_of_settlement,
    nal.new_apartments
FROM 
    family_apartment_needs fan
LEFT JOIN 
    family_structure fs ON fan.affair_id = fs.affair_id
LEFT JOIN 
    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
WHERE
    fan.family_apartment_needs_id = {apartment_id}
ORDER BY 
    fs.affair_id;
]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 17:44:16,331 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 17:44:16,331 - INFO - Params: {}
2025-02-13 17:44:17,275 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 17:44:17,275 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 17:44:17,588 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 17:44:17,589 - INFO - Params: {'municipal_districts_0': 'Крылатское'}
2025-02-13 17:44:17,593 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:44:17,593 - INFO - Params: {'municipal_0': 'Крылатское'}
2025-02-13 17:44:18,021 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 17:44:18,021 - INFO - Params: {'house_address_0': 'Рублевское шоссе, д.70 кор.2', 'municipal_0': 'Крылатское'}
2025-02-13 17:44:18,756 - INFO - Executing query: 
2025-02-13 17:44:18,756 - INFO - Params: {'apart_id': 8776712}
2025-02-13 17:44:18,781 - ERROR - Error executing query: expected string or bytes-like object, got 'NoneType'
2025-02-13 19:31:30,815 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 19:31:30,815 - INFO - Params: {}
2025-02-13 19:31:31,656 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 19:31:31,656 - INFO - Params: {'district_0': 'Зеленоградский АО'}
2025-02-13 19:31:32,965 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 19:31:32,965 - INFO - Params: {'municipal_districts_0': 'Крюково'}
2025-02-13 19:31:32,968 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:31:32,969 - INFO - Params: {'municipal_0': 'Крюково'}
2025-02-13 19:31:33,434 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:31:33,435 - INFO - Params: {'house_address_0': 'Зеленоград, Заводская ул. (Крюково), д.10', 'municipal_0': 'Крюково'}
2025-02-13 19:31:34,867 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where :affair_id = 948533
            ORDER BY 
                new_apartments;
2025-02-13 19:31:34,867 - INFO - Params: {'apart_id': 948533}
2025-02-13 19:31:34,868 - ERROR - Error executing query: (sqlalchemy.exc.InvalidRequestError) A value is required for bind parameter 'affair_id'
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where $1 = 948533
            ORDER BY 
                new_apartments;]
[parameters: [{'apart_id': 948533}]]
(Background on this error at: https://sqlalche.me/e/20/cd3x)
2025-02-13 19:31:37,589 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where :affair_id = 948550
            ORDER BY 
                new_apartments;
2025-02-13 19:31:37,589 - INFO - Params: {'apart_id': 948550}
2025-02-13 19:31:37,590 - ERROR - Error executing query: (sqlalchemy.exc.InvalidRequestError) A value is required for bind parameter 'affair_id'
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where $1 = 948550
            ORDER BY 
                new_apartments;]
[parameters: [{'apart_id': 948550}]]
(Background on this error at: https://sqlalche.me/e/20/cd3x)
2025-02-13 19:31:38,165 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where :affair_id = 948537
            ORDER BY 
                new_apartments;
2025-02-13 19:31:38,165 - INFO - Params: {'apart_id': 948537}
2025-02-13 19:31:38,166 - ERROR - Error executing query: (sqlalchemy.exc.InvalidRequestError) A value is required for bind parameter 'affair_id'
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where $1 = 948537
            ORDER BY 
                new_apartments;]
[parameters: [{'apart_id': 948537}]]
(Background on this error at: https://sqlalche.me/e/20/cd3x)
2025-02-13 19:33:59,078 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where affair_id = 948521
            ORDER BY 
                new_apartments;
2025-02-13 19:33:59,078 - INFO - Params: {'apart_id': 948521}
2025-02-13 19:33:59,378 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where affair_id = 948550
            ORDER BY 
                new_apartments;
2025-02-13 19:33:59,378 - INFO - Params: {'apart_id': 948550}
2025-02-13 19:33:59,708 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where affair_id = 948521
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:33:59,912 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: ошибка синтаксиса (примерное положение: "where")
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
                where affair_id = 948550
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:34:37,716 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 948524
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:34:37,716 - INFO - Params: {'apart_id': 948524}
2025-02-13 19:34:38,023 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 948550
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:34:38,023 - INFO - Params: {'apart_id': 948550}
2025-02-13 19:34:38,332 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.AmbiguousColumnError'>: неоднозначная ссылка на столбец "affair_id"
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 948524
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:34:38,565 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.AmbiguousColumnError'>: неоднозначная ссылка на столбец "affair_id"
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 948550
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:34:38,724 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 948533
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:34:38,724 - INFO - Params: {'apart_id': 948533}
2025-02-13 19:34:38,800 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.AmbiguousColumnError'>: неоднозначная ссылка на столбец "affair_id"
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 948533
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:34:40,215 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 19:34:40,215 - INFO - Params: {}
2025-02-13 19:34:42,512 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 19:34:42,512 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 19:34:43,037 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 19:34:43,037 - INFO - Params: {'municipal_districts_0': '#6101'}
2025-02-13 19:34:43,126 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:34:43,126 - INFO - Params: {'municipal_0': '#6101'}
2025-02-13 19:34:43,451 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:34:43,451 - INFO - Params: {'house_address_0': 'Лермонтовский просп., д.161', 'municipal_0': '#6101'}
2025-02-13 19:34:44,057 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 960267
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:34:44,057 - INFO - Params: {'apart_id': 960267}
2025-02-13 19:34:44,117 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.AmbiguousColumnError'>: неоднозначная ссылка на столбец "affair_id"
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 960267
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:34:49,302 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 960267
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:34:49,302 - INFO - Params: {'apart_id': 960267}
2025-02-13 19:34:49,402 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.AmbiguousColumnError'>: неоднозначная ссылка на столбец "affair_id"
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 960267
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:34:52,848 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 19:34:52,849 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 19:34:53,295 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 19:34:53,295 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 19:34:53,303 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:34:53,303 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 19:34:53,743 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:34:53,743 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 19:34:55,355 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:34:55,355 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 19:34:56,424 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 85624691
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:34:56,424 - INFO - Params: {'apart_id': 85624691}
2025-02-13 19:34:56,492 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.AmbiguousColumnError'>: неоднозначная ссылка на столбец "affair_id"
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 85624691
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:34:57,578 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 85624698
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:34:57,578 - INFO - Params: {'apart_id': 85624698}
2025-02-13 19:34:57,660 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.AmbiguousColumnError'>: неоднозначная ссылка на столбец "affair_id"
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where affair_id = 85624698
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 19:35:17,213 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624670
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:35:17,214 - INFO - Params: {'apart_id': 85624670}
2025-02-13 19:35:18,315 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 19:35:18,315 - INFO - Params: {}
2025-02-13 19:35:20,384 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 19:35:20,384 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 19:35:20,821 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 19:35:20,821 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 19:35:20,826 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:35:20,826 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 19:35:21,230 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 19:35:21,230 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 19:35:22,012 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                ) FILTER (WHERE lft.house_address IS NOT NULL) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 900727
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 19:35:22,012 - INFO - Params: {'apart_id': 900727}
2025-02-13 21:59:45,573 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 21:59:45,573 - INFO - Params: {}
2025-02-13 21:59:45,845 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 21:59:45,845 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 21:59:47,476 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 21:59:47,476 - INFO - Params: {'district_0': 'Западный АО'}
2025-02-13 21:59:47,952 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 21:59:47,952 - INFO - Params: {'municipal_districts_0': 'Крылатское'}
2025-02-13 21:59:47,957 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 21:59:47,957 - INFO - Params: {'municipal_0': 'Крылатское'}
2025-02-13 21:59:48,439 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 21:59:48,439 - INFO - Params: {'house_address_0': 'Рублевское шоссе, д.70 кор.2', 'municipal_0': 'Крылатское'}
2025-02-13 21:59:49,371 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 8776722
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 21:59:49,371 - INFO - Params: {'apart_id': 8776722}
2025-02-13 21:59:50,956 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 8776712
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 21:59:50,956 - INFO - Params: {'apart_id': 8776712}
2025-02-13 21:59:51,594 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 8776722
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 21:59:51,594 - INFO - Params: {'apart_id': 8776722}
2025-02-13 21:59:54,941 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 21:59:54,941 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 21:59:55,379 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 21:59:55,379 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 21:59:55,385 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 21:59:55,385 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 21:59:55,844 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 21:59:55,844 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 21:59:55,923 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 21:59:55,923 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 21:59:57,012 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 21:59:57,012 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 21:59:57,016 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 21:59:57,016 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 21:59:57,344 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 21:59:57,345 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 21:59:57,426 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 21:59:57,427 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 21:59:58,066 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 21:59:58,066 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 22:00:00,388 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 22:00:00,388 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 22:00:00,393 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 22:00:00,393 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 22:00:01,058 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 22:00:01,058 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:00:03,487 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 22:00:03,487 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:00:04,344 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54545
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:00:04,344 - INFO - Params: {'apart_id': 54545}
2025-02-13 22:00:06,534 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54650
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:00:06,534 - INFO - Params: {'apart_id': 54650}
2025-02-13 22:00:07,292 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55106
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:00:07,293 - INFO - Params: {'apart_id': 55106}
2025-02-13 22:00:08,403 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54601
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:00:08,403 - INFO - Params: {'apart_id': 54601}
2025-02-13 22:00:23,866 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 22:00:23,866 - INFO - Params: {}
2025-02-13 22:00:25,563 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 22:00:25,563 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 22:00:26,025 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 22:00:26,025 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 22:00:26,030 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:00:26,030 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 22:00:27,573 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:00:27,573 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:00:33,935 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, anser_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624682
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 22:00:33,935 - INFO - Params: {'apart_id': 85624682}
2025-02-13 22:00:34,027 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "anser_date" не существует
HINT:  Возможно, предполагалась ссылка на столбец "lft.answer_date".
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, anser_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624682
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 22:00:46,095 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, anser_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624691
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 22:00:46,095 - INFO - Params: {'apart_id': 85624691}
2025-02-13 22:00:46,160 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "anser_date" не существует
HINT:  Возможно, предполагалась ссылка на столбец "lft.answer_date".
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, anser_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624691
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 22:00:47,076 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, anser_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624670
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 22:00:47,076 - INFO - Params: {'apart_id': 85624670}
2025-02-13 22:00:47,146 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: столбец "anser_date" не существует
HINT:  Возможно, предполагалась ссылка на столбец "lft.answer_date".
[SQL: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, anser_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624670
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-13 22:01:34,604 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624707
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 22:01:34,604 - INFO - Params: {'apart_id': 85624707}
2025-02-13 22:01:35,079 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624678
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 22:01:35,079 - INFO - Params: {'apart_id': 85624678}
2025-02-13 22:01:35,788 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:01:35,788 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 2', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:01:36,484 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:01:36,484 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:01:38,528 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 22:01:38,528 - INFO - Params: {}
2025-02-13 22:01:39,234 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 22:01:39,234 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 22:01:39,744 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 22:01:39,744 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 22:01:39,749 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 22:01:39,749 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 22:01:40,320 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 22:01:40,320 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:01:41,890 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54503
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:01:41,890 - INFO - Params: {'apart_id': 54503}
2025-02-13 22:02:32,162 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54650
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:02:32,163 - INFO - Params: {'apart_id': 54650}
2025-02-13 22:03:11,531 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54594
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:11,531 - INFO - Params: {'apart_id': 54594}
2025-02-13 22:03:11,899 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54587
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:11,899 - INFO - Params: {'apart_id': 54587}
2025-02-13 22:03:12,535 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55064
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:12,535 - INFO - Params: {'apart_id': 55064}
2025-02-13 22:03:13,226 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55029
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:13,226 - INFO - Params: {'apart_id': 55029}
2025-02-13 22:03:14,640 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54781
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:14,641 - INFO - Params: {'apart_id': 54781}
2025-02-13 22:03:15,652 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54980
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:15,653 - INFO - Params: {'apart_id': 54980}
2025-02-13 22:03:16,275 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55085
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:16,275 - INFO - Params: {'apart_id': 55085}
2025-02-13 22:03:17,430 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54538
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:03:17,430 - INFO - Params: {'apart_id': 54538}
2025-02-13 22:04:43,894 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54793
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:04:43,894 - INFO - Params: {'apart_id': 54793}
2025-02-13 22:04:46,249 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54994
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:04:46,249 - INFO - Params: {'apart_id': 54994}
2025-02-13 22:04:47,088 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55099
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:04:47,089 - INFO - Params: {'apart_id': 55099}
2025-02-13 22:04:47,650 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54538
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:04:47,650 - INFO - Params: {'apart_id': 54538}
2025-02-13 22:04:49,830 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 22:04:49,830 - INFO - Params: {}
2025-02-13 22:04:51,026 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 22:04:51,026 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 22:04:51,788 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 22:04:51,788 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 22:04:51,792 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:04:51,792 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 22:04:52,627 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:04:52,627 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:04:54,067 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85624722
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 22:04:54,067 - INFO - Params: {'apart_id': 85624722}
2025-02-13 22:04:56,912 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 85625054
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-13 22:04:56,912 - INFO - Params: {'apart_id': 85625054}
2025-02-13 22:04:58,987 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 22:04:58,987 - INFO - Params: {}
2025-02-13 22:05:00,420 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 22:05:00,420 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 22:05:01,441 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 22:05:01,441 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 22:05:01,523 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 22:05:01,523 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 22:05:01,916 - INFO - Executing query: 
            WITH ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
                    offer o ON na.new_apart_id = (o.new_aparts::jsonb ->> 'new_apart_id')::int
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and rn = 1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1  -- Выбираем только первую запись для каждого new_apart_id
            ORDER BY full_living_area;
            
2025-02-13 22:05:01,916 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:05:04,078 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54503
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:04,078 - INFO - Params: {'apart_id': 54503}
2025-02-13 22:05:05,465 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54615
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:05,465 - INFO - Params: {'apart_id': 54615}
2025-02-13 22:05:06,125 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54601
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:06,125 - INFO - Params: {'apart_id': 54601}
2025-02-13 22:05:06,552 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54573
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:06,552 - INFO - Params: {'apart_id': 54573}
2025-02-13 22:05:07,266 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54608
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:07,266 - INFO - Params: {'apart_id': 54608}
2025-02-13 22:05:08,003 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55001
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:08,004 - INFO - Params: {'apart_id': 55001}
2025-02-13 22:05:08,676 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55022
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:08,676 - INFO - Params: {'apart_id': 55022}
2025-02-13 22:05:09,350 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54973
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:09,350 - INFO - Params: {'apart_id': 54973}
2025-02-13 22:05:10,041 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54829
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:10,041 - INFO - Params: {'apart_id': 54829}
2025-02-13 22:05:10,689 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54769
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:10,690 - INFO - Params: {'apart_id': 54769}
2025-02-13 22:05:11,377 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54841
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:11,377 - INFO - Params: {'apart_id': 54841}
2025-02-13 22:05:12,175 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54804
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:12,175 - INFO - Params: {'apart_id': 54804}
2025-02-13 22:05:12,841 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54507
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:12,841 - INFO - Params: {'apart_id': 54507}
2025-02-13 22:05:13,522 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54647
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:13,522 - INFO - Params: {'apart_id': 54647}
2025-02-13 22:05:14,110 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54556
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:14,110 - INFO - Params: {'apart_id': 54556}
2025-02-13 22:05:14,676 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55027
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:14,676 - INFO - Params: {'apart_id': 55027}
2025-02-13 22:05:15,222 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55069
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:15,222 - INFO - Params: {'apart_id': 55069}
2025-02-13 22:05:15,785 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 55013
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:15,785 - INFO - Params: {'apart_id': 55013}
2025-02-13 22:05:16,325 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54803
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:16,325 - INFO - Params: {'apart_id': 54803}
2025-02-13 22:05:16,901 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54809
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:16,901 - INFO - Params: {'apart_id': 54809}
2025-02-13 22:05:35,767 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    o.new_apart_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    old_apart oa
                    LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
            )
            SELECT 
                na.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                jsonb_build_object(
                    'old_apartments', 
                    jsonb_agg(
                        jsonb_build_object(
                            'house_address', oa.house_address,
                            'apart_number', oa.apart_number,
                            'district', oa.district,
                            'municipal_district', oa.municipal_district,
                            'full_living_area', oa.full_living_area,
                            'total_living_area', oa.total_living_area,
                            'living_area', oa.living_area,
                            'room_count', oa.room_count,
                            'type_of_settlement', oa.type_of_settlement,
                            'sentence_date', oa.sentence_date,
                            'answer_date', oa.answer_date
                        ) ORDER BY 
                            oa.sentence_date DESC NULLS LAST, 
                            oa.answer_date DESC NULLS LAST
                    )
                ) AS result
            FROM 
                lft na
                LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                WHERE new_apart_id = 54845
            GROUP BY 
                                    na.new_apart_id,
                                        na.house_address,
                                        na.apart_number,
                                        na.district,
                                        na.municipal_district,
                                        na.full_living_area,
                                        na.total_living_area,
                                        na.living_area,
                                        na.room_count
                ORDER BY 
                na.new_apart_id;
2025-02-13 22:05:35,767 - INFO - Params: {'apart_id': 54845}
2025-02-13 22:07:16,659 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 54809 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-13 22:07:16,659 - INFO - Params: {'apart_id': 54809}
2025-02-13 22:07:18,212 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 54761 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-13 22:07:18,213 - INFO - Params: {'apart_id': 54761}
2025-02-13 22:07:25,442 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 54809 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-13 22:07:25,442 - INFO - Params: {'apart_id': 54809}
2025-02-13 22:17:48,862 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 54845 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-13 22:17:48,862 - INFO - Params: {'apart_id': 54845}
2025-02-13 22:17:50,643 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-13 22:17:50,643 - INFO - Params: {}
2025-02-13 22:17:52,372 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 22:17:52,372 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 22:17:52,850 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 22:17:52,850 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 22:17:53,429 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 22:17:53,429 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 22:17:53,434 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:17:53,434 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 22:17:53,977 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 22:17:53,977 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 22:17:56,246 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 22:17:56,246 - INFO - Params: {}
2025-02-13 22:18:00,371 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 22:18:00,371 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 22:18:01,131 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 22:18:01,131 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 22:18:01,205 - INFO - Executing query: 

				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-13 22:18:01,206 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 22:18:01,568 - INFO - Executing query: 

				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-13 22:18:01,569 - INFO - Params: {'house_address_0': 'Алтуфьевское шоссе, д. 53, корп. 1', 'municipal_0': 'Алтуфьевский'}
<<<<<<< HEAD
2025-02-15 15:31:45,235 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-15 15:31:45,237 - INFO - Params: {}
2025-02-15 15:31:46,467 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-15 15:31:46,467 - INFO - Params: {}
2025-02-15 15:31:47,026 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-15 15:31:47,027 - INFO - Params: {}
2025-02-15 15:32:06,484 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 15:32:06,484 - INFO - Params: {'district_0': 'Р’РѕСЃС‚РѕС‡РЅС‹Р№ РђРћ'}
2025-02-15 15:32:06,988 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-15 15:32:06,988 - INFO - Params: {'municipal_districts_0': 'Р’РѕСЃС‚РѕС‡РЅРѕРµ РР·РјР°Р№Р»РѕРІРѕ'}
2025-02-15 15:32:06,990 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:32:06,990 - INFO - Params: {'municipal_0': 'Р’РѕСЃС‚РѕС‡РЅРѕРµ РР·РјР°Р№Р»РѕРІРѕ'}
2025-02-15 15:32:07,375 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:32:07,375 - INFO - Params: {'house_address_0': 'РР·РјР°Р№Р»РѕРІСЃРєРёР№ Р±СѓР»СЊРІ., Рґ.71/25 РєРѕСЂ.1', 'municipal_0': 'Р’РѕСЃС‚РѕС‡РЅРѕРµ РР·РјР°Р№Р»РѕРІРѕ'}
2025-02-15 15:32:08,771 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 906587
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:32:08,771 - INFO - Params: {'apart_id': 906587}
2025-02-15 15:33:36,161 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-15 15:33:36,161 - INFO - Params: {}
2025-02-15 15:33:37,264 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 15:33:37,264 - INFO - Params: {'district_0': 'Р”Р–Рџ Рё Р–Р¤ (Р“Р°Р·РµС‚РЅС‹Р№ РїРµСЂ.,1/12)'}
2025-02-15 15:33:38,636 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-15 15:33:38,636 - INFO - Params: {'municipal_districts_0': '#6101'}
2025-02-15 15:33:38,638 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:33:38,638 - INFO - Params: {'municipal_0': '#6101'}
2025-02-15 15:33:39,207 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:33:39,207 - INFO - Params: {'house_address_0': 'Р›РµСЂРјРѕРЅС‚РѕРІСЃРєРёР№ РїСЂРѕСЃРї., Рґ.161', 'municipal_0': '#6101'}
2025-02-15 15:33:39,869 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 960267
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:33:39,869 - INFO - Params: {'apart_id': 960267}
2025-02-15 15:34:03,253 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-15 15:34:03,254 - INFO - Params: {}
2025-02-15 15:34:05,495 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 15:34:05,495 - INFO - Params: {'district_0': 'Р—РµР»РµРЅРѕРіСЂР°РґСЃРєРёР№ РђРћ'}
2025-02-15 15:34:05,969 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-15 15:34:05,969 - INFO - Params: {'municipal_districts_0': 'РљСЂСЋРєРѕРІРѕ'}
2025-02-15 15:34:05,970 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:34:05,971 - INFO - Params: {'municipal_0': 'РљСЂСЋРєРѕРІРѕ'}
2025-02-15 15:34:06,896 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:34:06,896 - INFO - Params: {'house_address_0': 'Р—РµР»РµРЅРѕРіСЂР°Рґ, Р—Р°РІРѕРґСЃРєР°СЏ СѓР». (РљСЂСЋРєРѕРІРѕ), Рґ.10', 'municipal_0': 'РљСЂСЋРєРѕРІРѕ'}
2025-02-15 15:34:09,557 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:34:09,557 - INFO - Params: {'house_address_0': 'Р—РµР»РµРЅРѕРіСЂР°Рґ, Р—Р°РІРѕРґСЃРєР°СЏ СѓР». (РљСЂСЋРєРѕРІРѕ), Рґ.12Рђ', 'municipal_0': 'РљСЂСЋРєРѕРІРѕ'}
2025-02-15 15:34:15,784 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 919010
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:34:15,785 - INFO - Params: {'apart_id': 919010}
2025-02-15 15:41:04,020 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-15 15:41:04,021 - INFO - Params: {}
2025-02-15 15:41:08,849 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 15:41:08,849 - INFO - Params: {'district_0': 'Р”Р–Рџ Рё Р–Р¤ (Р“Р°Р·РµС‚РЅС‹Р№ РїРµСЂ.,1/12)'}
2025-02-15 15:41:09,619 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 15:41:09,619 - INFO - Params: {'district_0': 'Р—Р°РїР°РґРЅС‹Р№ РђРћ'}
2025-02-15 15:41:10,201 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-15 15:41:10,202 - INFO - Params: {'municipal_districts_0': 'Р’РЅСѓРєРѕРІРѕ'}
2025-02-15 15:41:10,204 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:41:10,204 - INFO - Params: {'municipal_0': 'Р’РЅСѓРєРѕРІРѕ'}
2025-02-15 15:41:10,742 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:41:10,743 - INFO - Params: {'house_address_0': 'РђСЌСЂРѕС„Р»РѕС‚СЃРєР°СЏ СѓР»., Рґ.3', 'municipal_0': 'Р’РЅСѓРєРѕРІРѕ'}
2025-02-15 15:41:11,790 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:41:11,790 - INFO - Params: {'house_address_0': 'РћСЃРёРїРµРЅРєРѕ СѓР». (РїРѕСЃ.РўРѕР»СЃС‚РѕРїР°Р»СЊС†РµРІРѕ), Рґ.8 СЃС‚СЂ. 3', 'municipal_0': 'Р’РЅСѓРєРѕРІРѕ'}
2025-02-15 15:41:16,681 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 978854
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:41:16,681 - INFO - Params: {'apart_id': 978854}
2025-02-15 15:42:06,231 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 978855
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:42:06,231 - INFO - Params: {'apart_id': 978855}
2025-02-15 15:42:07,438 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 15:42:07,438 - INFO - Params: {'district_0': 'Р’РѕСЃС‚РѕС‡РЅС‹Р№ РђРћ'}
2025-02-15 15:42:07,942 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-15 15:42:07,942 - INFO - Params: {'municipal_districts_0': 'Р’РѕСЃС‚РѕС‡РЅРѕРµ РР·РјР°Р№Р»РѕРІРѕ'}
2025-02-15 15:42:07,944 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:42:07,944 - INFO - Params: {'municipal_0': 'Р’РѕСЃС‚РѕС‡РЅРѕРµ РР·РјР°Р№Р»РѕРІРѕ'}
2025-02-15 15:42:08,337 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:42:08,338 - INFO - Params: {'house_address_0': 'РР·РјР°Р№Р»РѕРІСЃРєРёР№ Р±СѓР»СЊРІ., Рґ.71/25 РєРѕСЂ.1', 'municipal_0': 'Р’РѕСЃС‚РѕС‡РЅРѕРµ РР·РјР°Р№Р»РѕРІРѕ'}
2025-02-15 15:42:09,938 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 905457
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:42:09,938 - INFO - Params: {'apart_id': 905457}
2025-02-15 15:42:10,298 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 905437
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:42:10,298 - INFO - Params: {'apart_id': 905437}
2025-02-15 15:42:12,138 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 905448
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:42:12,138 - INFO - Params: {'apart_id': 905448}
2025-02-15 15:43:23,734 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 905317
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:43:23,734 - INFO - Params: {'apart_id': 905317}
2025-02-15 15:43:24,962 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-15 15:43:24,962 - INFO - Params: {}
2025-02-15 15:43:25,511 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 15:43:25,512 - INFO - Params: {'district_0': 'РќРѕРІРѕРјРѕСЃРєРѕРІСЃРєРёР№ РђРћ'}
2025-02-15 15:43:25,879 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-15 15:43:25,879 - INFO - Params: {'municipal_districts_0': 'Р’РЅСѓРєРѕРІСЃРєРѕРµ СЃРµР»СЊСЃРєРѕРµ РїРѕСЃРµР»РµРЅРёРµ'}
2025-02-15 15:43:25,881 - INFO - Executing query: 

				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-15 15:43:25,881 - INFO - Params: {'municipal_0': 'Р’РЅСѓРєРѕРІСЃРєРѕРµ СЃРµР»СЊСЃРєРѕРµ РїРѕСЃРµР»РµРЅРёРµ'}
2025-02-15 15:43:26,434 - INFO - Executing query: 

				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-15 15:43:26,434 - INFO - Params: {'house_address_0': 'РђРЅРЅС‹ РђС…РјР°С‚РѕРІРѕР№ СѓР». (Рї.Р’РЅСѓРєРѕРІСЃРєРѕРµ), Рґ.10', 'municipal_0': 'Р’РЅСѓРєРѕРІСЃРєРѕРµ СЃРµР»СЊСЃРєРѕРµ РїРѕСЃРµР»РµРЅРёРµ'}
2025-02-15 15:43:27,026 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 8006864 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-15 15:43:27,026 - INFO - Params: {'apart_id': 8006864}
2025-02-15 15:43:28,030 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 8006868 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-15 15:43:28,032 - INFO - Params: {'apart_id': 8006868}
2025-02-15 15:43:28,706 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 8006864 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-15 15:43:28,707 - INFO - Params: {'apart_id': 8006864}
2025-02-15 15:43:29,945 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-15 15:43:29,945 - INFO - Params: {}
2025-02-15 15:43:30,290 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 15:43:30,290 - INFO - Params: {'district_0': 'Р’РѕСЃС‚РѕС‡РЅС‹Р№ РђРћ'}
2025-02-15 15:43:30,666 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-15 15:43:30,667 - INFO - Params: {'municipal_districts_0': 'Р’РѕСЃС‚РѕС‡РЅРѕРµ РР·РјР°Р№Р»РѕРІРѕ'}
2025-02-15 15:43:30,668 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:43:30,668 - INFO - Params: {'municipal_0': 'Р’РѕСЃС‚РѕС‡РЅРѕРµ РР·РјР°Р№Р»РѕРІРѕ'}
2025-02-15 15:43:31,228 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:43:31,228 - INFO - Params: {'house_address_0': 'РР·РјР°Р№Р»РѕРІСЃРєРёР№ Р±СѓР»СЊРІ., Рґ.71/25 РєРѕСЂ.1', 'municipal_0': 'Р’РѕСЃС‚РѕС‡РЅРѕРµ РР·РјР°Р№Р»РѕРІРѕ'}
2025-02-15 15:43:31,684 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 905305
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:43:31,684 - INFO - Params: {'apart_id': 905305}
2025-02-15 15:49:33,586 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 905448
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:49:33,587 - INFO - Params: {'apart_id': 905448}
2025-02-15 15:49:37,591 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-15 15:49:37,591 - INFO - Params: {}
2025-02-15 15:49:38,160 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 15:49:38,160 - INFO - Params: {'district_0': 'Р—Р°РїР°РґРЅС‹Р№ РђРћ'}
2025-02-15 15:49:38,598 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-15 15:49:38,598 - INFO - Params: {'municipal_districts_0': 'РљСѓРЅС†РµРІРѕ'}
2025-02-15 15:49:38,600 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:49:38,600 - INFO - Params: {'municipal_0': 'РљСѓРЅС†РµРІРѕ'}
2025-02-15 15:49:39,190 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:49:39,191 - INFO - Params: {'house_address_0': 'Р•РєР°С‚РµСЂРёРЅС‹ Р‘СѓРґР°РЅРѕРІРѕР№ СѓР»., Рґ.22', 'municipal_0': 'РљСѓРЅС†РµРІРѕ'}
2025-02-15 15:49:40,056 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 909716
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:49:40,056 - INFO - Params: {'apart_id': 909716}
2025-02-15 15:51:19,279 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 909210
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:51:19,280 - INFO - Params: {'apart_id': 909210}
2025-02-15 15:51:20,670 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 909716
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:51:20,671 - INFO - Params: {'apart_id': 909716}
2025-02-15 15:52:56,988 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 909716
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:52:56,989 - INFO - Params: {'apart_id': 909716}
2025-02-15 15:53:14,755 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 909716 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-15 15:53:14,755 - INFO - Params: {'apart_id': 909716}
2025-02-15 15:53:17,836 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id, 
                    (KEY)::int AS new_apart_id, 
                    sentence_date, 
                    answer_date, 
                    (VALUE->'status_id')::int AS status_id 
                FROM 
                    offer, 
                    jsonb_each(new_aparts)
            ),
            lft AS (
                SELECT 
                    o.affair_id,
                    na.house_address,
                    na.apart_number,
                    na.district,
                    na.municipal_district,
                    na.full_living_area,
                    na.total_living_area,
                    na.living_area,
                    na.room_count,
                    na.type_of_settlement,
                    na.notes,
                    s.status,
                    o.sentence_date,
                    o.answer_date
                FROM 
                    unnset_offer o 
                    LEFT JOIN new_apart na USING (new_apart_id)
                    LEFT JOIN status s ON o.status_id = s.status_id
            ),
            old_apart_data AS (
                SELECT 
                    oa.affair_id,
                    oa.house_address,
                    oa.apart_number,
                    oa.district,
                    oa.municipal_district,
                    oa.full_living_area,
                    oa.total_living_area,
                    oa.living_area,
                    oa.room_count,
                    oa.type_of_settlement
                FROM 
                    old_apart oa
            )
            SELECT 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement,
                jsonb_agg(
                    jsonb_build_object(
                        'house_address', lft.house_address,
                        'apart_number', lft.apart_number,
                        'district', lft.district,
                        'municipal_district', lft.municipal_district,
                        'full_living_area', lft.full_living_area,
                        'total_living_area', lft.total_living_area,
                        'living_area', lft.living_area,
                        'room_count', lft.room_count,
                        'type_of_settlement', lft.type_of_settlement,
                        'notes', lft.notes,
                        'status', lft.status,
                        'sentence_date', lft.sentence_date,
                        'answer_date', lft.answer_date
                    )
                    ORDER BY lft.sentence_date DESC, lft.answer_date DESC
                ) AS new_apartments
            FROM 
                old_apart_data oa
                LEFT JOIN lft ON oa.affair_id = lft.affair_id
                where oa.affair_id = 909716
            GROUP BY 
                oa.affair_id,
                oa.house_address,
                oa.apart_number,
                oa.district,
                oa.municipal_district,
                oa.full_living_area,
                oa.total_living_area,
                oa.living_area,
                oa.room_count,
                oa.type_of_settlement
            ORDER BY 
                new_apartments;
2025-02-15 15:53:17,836 - INFO - Params: {'apart_id': 909716}
2025-02-15 15:53:53,100 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 909716         
                    
2025-02-15 15:53:53,100 - INFO - Params: {'apart_id': 909716}
2025-02-15 15:54:03,185 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-15 15:54:03,186 - INFO - Params: {}
2025-02-15 15:54:03,799 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 15:54:03,799 - INFO - Params: {'district_0': 'Р”Р–Рџ Рё Р–Р¤ (Р“Р°Р·РµС‚РЅС‹Р№ РїРµСЂ.,1/12)'}
2025-02-15 15:54:04,195 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 15:54:04,195 - INFO - Params: {'district_0': 'Р—Р°РїР°РґРЅС‹Р№ РђРћ'}
2025-02-15 15:54:05,018 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 15:54:05,018 - INFO - Params: {'district_0': 'Р—РµР»РµРЅРѕРіСЂР°РґСЃРєРёР№ РђРћ'}
2025-02-15 15:54:07,848 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-15 15:54:07,849 - INFO - Params: {}
2025-02-15 15:54:08,285 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-15 15:54:08,285 - INFO - Params: {}
2025-02-15 15:54:08,706 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 15:54:08,707 - INFO - Params: {'district_0': 'Р”Р–Рџ Рё Р–Р¤ (Р“Р°Р·РµС‚РЅС‹Р№ РїРµСЂ.,1/12)'}
2025-02-15 15:54:09,002 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 15:54:09,002 - INFO - Params: {'district_0': 'Р—РµР»РµРЅРѕРіСЂР°РґСЃРєРёР№ РђРћ'}
2025-02-15 15:54:09,458 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-15 15:54:09,458 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-15 15:54:09,459 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:54:09,459 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-15 15:54:10,032 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 15:54:10,032 - INFO - Params: {'house_address_0': '1-СЏ Р–РµР»РµР·РЅРѕРґРѕСЂРѕР¶РЅР°СЏ СѓР»РёС†Р°, Рґ.6', 'municipal_0': 'NaN'}
2025-02-15 15:54:15,317 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 966134         
                    
2025-02-15 15:54:15,317 - INFO - Params: {'apart_id': 966134}
2025-02-15 16:14:05,763 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 966132         
                    
2025-02-15 16:14:05,765 - INFO - Params: {'apart_id': 966132}
2025-02-15 16:14:06,568 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 966134         
                    
2025-02-15 16:14:06,568 - INFO - Params: {'apart_id': 966134}
2025-02-15 16:14:07,184 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 965676         
                    
2025-02-15 16:14:07,184 - INFO - Params: {'apart_id': 965676}
2025-02-15 16:14:07,602 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 965674         
                    
2025-02-15 16:14:07,602 - INFO - Params: {'apart_id': 965674}
2025-02-15 16:14:10,097 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 16:14:10,097 - INFO - Params: {'house_address_0': 'РњРѕСЃС‚РѕРІСЃРєРѕРµ Рґ.(Рї. Р СЏР·Р°РЅРѕРІСЃРєРѕРµ), Рґ.2', 'municipal_0': 'NaN'}
2025-02-15 16:14:10,844 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 962478         
                    
2025-02-15 16:14:10,844 - INFO - Params: {'apart_id': 962478}
2025-02-15 16:14:22,863 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 962479         
                    
2025-02-15 16:14:22,863 - INFO - Params: {'apart_id': 962479}
2025-02-15 16:14:24,428 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 962478         
                    
2025-02-15 16:14:24,428 - INFO - Params: {'apart_id': 962478}
2025-02-15 16:14:25,338 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 962470         
                    
2025-02-15 16:14:25,338 - INFO - Params: {'apart_id': 962470}
2025-02-15 16:14:25,893 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 962478         
                    
2025-02-15 16:14:25,893 - INFO - Params: {'apart_id': 962478}
2025-02-15 16:16:16,633 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 962480         
                    
2025-02-15 16:16:16,633 - INFO - Params: {'apart_id': 962480}
2025-02-15 16:16:19,720 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 16:16:19,722 - INFO - Params: {'district_0': 'РњРѕСЃРєРѕРІСЃРєР°СЏ РѕР±Р»Р°СЃС‚СЊ'}
2025-02-15 16:16:20,708 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-15 16:16:20,708 - INFO - Params: {'municipal_districts_0': 'РћРґРёРЅС†РѕРІСЃРєРёР№'}
2025-02-15 16:16:20,710 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 16:16:20,710 - INFO - Params: {'municipal_0': 'РћРґРёРЅС†РѕРІСЃРєРёР№'}
2025-02-15 16:16:21,150 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 16:16:21,151 - INFO - Params: {'house_address_0': 'Р–РµР»РµР·РЅРѕРґРѕСЂРѕР¶РЅР°СЏ СѓР» .СЃ.Р–Р°РІРѕСЂРѕРЅРєРё РћРґРёРЅС†РѕРІСЃРєРёР№ СЂ-РЅ, Рґ.10', 'municipal_0': 'РћРґРёРЅС†РѕРІСЃРєРёР№'}
2025-02-15 16:16:24,230 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 16:16:24,230 - INFO - Params: {'district_0': 'РЎР’РђРћ'}
2025-02-15 16:16:24,692 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-15 16:16:24,692 - INFO - Params: {'municipal_districts_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-15 16:16:24,693 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 16:16:24,693 - INFO - Params: {'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-15 16:16:25,115 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 16:16:25,115 - INFO - Params: {'house_address_0': 'РРЅР¶РµРЅРµСЂРЅР°СЏ СѓР»., РґРѕРј 10, РєРѕСЂРї. 1', 'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-15 16:16:26,582 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 85624703         
                    
2025-02-15 16:16:26,582 - INFO - Params: {'apart_id': 85624703}
2025-02-15 16:16:28,696 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-15 16:16:28,697 - INFO - Params: {'house_address_0': 'Р–РµР»РµР·РЅРѕРґРѕСЂРѕР¶РЅР°СЏ СѓР» .СЃ.Р–Р°РІРѕСЂРѕРЅРєРё РћРґРёРЅС†РѕРІСЃРєРёР№ СЂ-РЅ, Рґ.10', 'municipal_0': 'РћРґРёРЅС†РѕРІСЃРєРёР№'}
2025-02-15 16:16:29,341 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 848456         
                    
2025-02-15 16:16:29,341 - INFO - Params: {'apart_id': 848456}
2025-02-15 16:17:33,237 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-15 16:17:33,238 - INFO - Params: {}
2025-02-15 16:17:33,662 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-15 16:17:33,662 - INFO - Params: {'district_0': 'Р—РµР»РµРЅРѕРіСЂР°РґСЃРєРёР№ РђРћ'}
2025-02-15 16:17:34,043 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-15 16:17:34,043 - INFO - Params: {'municipal_districts_0': 'РљСЂСЋРєРѕРІРѕ'}
2025-02-15 16:17:34,045 - INFO - Executing query: 

				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-15 16:17:34,046 - INFO - Params: {'municipal_0': 'РљСЂСЋРєРѕРІРѕ'}
2025-02-15 16:17:34,482 - INFO - Executing query: 

				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-15 16:17:34,482 - INFO - Params: {'house_address_0': 'Р“РµРѕСЂРіРёРµРІСЃРєРёР№ РїСЂ-С‚ РєРѕСЂ.1934', 'municipal_0': 'РљСЂСЋРєРѕРІРѕ'}
2025-02-15 16:17:35,413 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 7749444 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-15 16:17:35,413 - INFO - Params: {'apart_id': 7749444}
2025-02-16 12:08:38,670 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 7749562 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-16 12:08:38,671 - INFO - Params: {'apart_id': 7749562}
2025-02-16 12:08:39,105 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 7749491 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-16 12:08:39,105 - INFO - Params: {'apart_id': 7749491}
2025-02-16 12:08:39,522 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 7749444 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-16 12:08:39,522 - INFO - Params: {'apart_id': 7749444}
2025-02-16 12:08:41,093 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-16 12:08:41,093 - INFO - Params: {}
2025-02-16 12:08:41,737 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-16 12:08:41,738 - INFO - Params: {'district_0': 'РЎРµРІРµСЂРѕ-Р’РѕСЃС‚РѕС‡РЅС‹Р№ РђРћ'}
2025-02-16 12:08:42,374 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-16 12:08:42,374 - INFO - Params: {'district_0': 'РЎР’РђРћ'}
2025-02-16 12:08:51,603 - INFO - Executing query: WITH needs_with_row AS (
>>>>>>> demo-dev
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
<<<<<<< HEAD
2025-02-13 10:50:12,957 - INFO - Params: None
2025-02-13 10:50:13,155 - INFO - Executing query: WITH needs_with_row AS (
=======
2025-02-16 12:08:51,603 - INFO - Params: None
2025-02-16 12:08:51,605 - INFO - Executing query: WITH needs_with_row AS (
>>>>>>> demo-dev
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
<<<<<<< HEAD
2025-02-13 10:50:13,155 - INFO - Params: None
2025-02-13 10:50:24,190 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 10:50:24,190 - INFO - Params: {}
2025-02-13 10:50:24,951 - INFO - Executing query: 
=======
2025-02-16 12:08:51,605 - INFO - Params: None
2025-02-16 12:08:52,332 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-16 12:08:52,332 - INFO - Params: {}
2025-02-16 12:08:53,713 - INFO - Executing query: 
>>>>>>> demo-dev
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
<<<<<<< HEAD
2025-02-13 10:50:24,951 - INFO - Params: {}
2025-02-13 11:04:48,479 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 11:04:48,479 - INFO - Params: {}
2025-02-13 11:04:49,769 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 11:04:49,769 - INFO - Params: {'district_0': 'Северный АО'}
2025-02-13 11:04:52,000 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 11:04:52,000 - INFO - Params: {'district_0': 'ДЖП и ЖФ (Газетный пер.,1/12)'}
2025-02-13 11:04:55,072 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 11:04:55,072 - INFO - Params: {'municipal_districts_0': 'Аэропорт'}
2025-02-13 11:04:55,073 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 11:04:55,073 - INFO - Params: {'municipal_0': 'Аэропорт'}
2025-02-13 11:07:01,568 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 11:07:01,568 - INFO - Params: {}
2025-02-13 11:07:02,127 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 11:07:02,127 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 11:16:52,394 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 11:16:52,395 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 11:16:52,396 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 11:16:52,396 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 11:16:52,856 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 11:16:52,857 - INFO - Params: {'house_address_0': 'Кузнецовская ул., д.7', 'municipal_0': 'Богородское'}
2025-02-13 11:16:54,397 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 11:16:54,397 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 11:16:54,399 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 11:16:54,399 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 11:20:48,829 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 11:20:48,829 - INFO - Params: {}
2025-02-13 11:20:49,287 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 11:20:49,287 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 11:20:51,893 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 11:20:51,894 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 11:20:51,895 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 11:20:51,895 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 11:51:58,076 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 11:51:58,076 - INFO - Params: {}
2025-02-13 11:52:04,937 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 11:52:04,937 - INFO - Params: {}
2025-02-13 11:52:06,458 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 11:52:06,458 - INFO - Params: {}
2025-02-13 11:52:17,014 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 11:52:23,875 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 13:11:18,453 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 13:11:18,454 - INFO - Params: {'district_0': 'Новомосковский АО'}
2025-02-13 13:11:18,909 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 13:11:18,910 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 13:11:20,134 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 13:11:20,134 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 13:11:20,249 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 13:11:20,249 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 13:11:20,621 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 13:11:20,622 - INFO - Params: {'district_0': 'Новомосковский АО'}
2025-02-13 13:11:22,182 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 13:11:22,182 - INFO - Params: {'apart_id': 864587}
2025-02-13 13:12:36,401 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 13:12:36,402 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 13:12:39,981 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 13:12:39,981 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 13:12:39,982 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 13:12:39,982 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 13:12:48,295 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 13:12:48,296 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 13:12:48,297 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 13:12:48,297 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 13:12:48,619 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 13:12:48,619 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 13:12:48,623 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 13:12:48,623 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 13:12:49,341 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 13:12:49,341 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 13:12:49,342 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 13:12:49,342 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 13:12:55,630 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864915
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 13:12:55,630 - INFO - Params: {'apart_id': 864915}
2025-02-13 13:34:27,061 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 13:34:27,061 - INFO - Params: {'apart_id': 864877}
2025-02-13 13:34:29,192 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 13:34:29,193 - INFO - Params: {'apart_id': 864587}
2025-02-13 13:34:32,261 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 13:34:32,262 - INFO - Params: {'apart_id': 864973}
2025-02-13 13:34:45,996 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 13:34:48,130 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 13:34:51,227 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864973
                ORDER BY 
                    fs.affair_id;
            ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 13:40:21,062 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 13:40:21,062 - INFO - Params: {'apart_id': 864587}
2025-02-13 14:07:56,115 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864918
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:07:56,116 - INFO - Params: {'apart_id': 864918}
2025-02-13 14:08:23,857 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 14:08:23,857 - INFO - Params: {}
2025-02-13 14:08:26,270 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:08:26,270 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 14:08:35,565 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 14:08:35,565 - INFO - Params: {}
2025-02-13 14:08:36,732 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:08:36,732 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 14:08:37,501 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:08:37,501 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 14:08:37,502 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:08:37,502 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 14:08:45,207 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN ($1)
            ORDER BY municipal_district
        ]
[parameters: ('Восточный АО',)]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 14:08:51,488 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:08:51,488 - INFO - Params: {'apart_id': 720420}
2025-02-13 14:09:09,368 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766506
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:09:09,368 - INFO - Params: {'apart_id': 766506}
2025-02-13 14:09:12,197 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 766514
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:09:12,197 - INFO - Params: {'apart_id': 766514}
2025-02-13 14:09:13,673 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 720420
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:09:13,673 - INFO - Params: {'apart_id': 720420}
2025-02-13 14:09:20,818 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:09:20,818 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 14:09:20,818 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:09:20,818 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 14:09:23,949 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:09:23,949 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:09:24,589 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:09:24,590 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:09:24,591 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:09:24,591 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:09:25,787 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:09:25,787 - INFO - Params: {'apart_id': 864587}
2025-02-13 14:09:38,718 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:09:38,718 - INFO - Params: {'apart_id': 864919}
2025-02-13 14:09:43,055 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:09:43,055 - INFO - Params: {'apart_id': 864587}
2025-02-13 14:11:16,375 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 14:11:16,375 - INFO - Params: {}
2025-02-13 14:11:17,534 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:11:17,534 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:11:18,094 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:11:18,095 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:11:18,097 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:11:18,097 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:11:19,363 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:11:19,363 - INFO - Params: {'apart_id': 864587}
2025-02-13 14:20:14,606 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 14:20:14,606 - INFO - Params: {}
2025-02-13 14:20:16,733 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:20:16,733 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:20:17,605 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:20:17,605 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:20:17,607 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:20:17,607 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:20:28,971 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864879
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:20:28,971 - INFO - Params: {'apart_id': 864879}
2025-02-13 14:20:31,304 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864879
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:20:31,304 - INFO - Params: {'apart_id': 864879}
2025-02-13 14:21:55,324 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:21:55,324 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 14:21:56,233 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:21:56,233 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 14:21:56,233 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:21:56,233 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 14:28:47,223 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 14:28:47,223 - INFO - Params: {}
2025-02-13 14:31:30,725 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:31:30,725 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:31:31,136 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:31:31,136 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:31:31,137 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:31:31,137 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:31:32,792 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864919
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 14:31:32,792 - INFO - Params: {'apart_id': 864919}
2025-02-13 14:32:53,438 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 14:32:53,438 - INFO - Params: {}
2025-02-13 14:32:55,497 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 14:32:55,497 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 14:32:56,417 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:32:56,417 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:32:56,418 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:32:56,418 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:32:57,241 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:32:57,241 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:32:57,242 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:32:57,243 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:32:58,897 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 14:32:58,897 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 14:32:58,898 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 14:32:58,898 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 14:33:46,454 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 14:33:46,454 - INFO - Params: {}
2025-02-13 14:49:46,560 - INFO - Executing query: WITH needs_with_row AS (
=======
2025-02-16 12:08:53,714 - INFO - Params: {}
2025-02-16 12:10:12,903 - INFO - Executing query: WITH needs_with_row AS (
>>>>>>> demo-dev
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
<<<<<<< HEAD
2025-02-13 14:49:46,560 - INFO - Params: None
2025-02-13 14:49:46,560 - INFO - Executing query: WITH needs_with_row AS (
=======
2025-02-16 12:10:12,904 - INFO - Params: None
2025-02-16 12:10:12,905 - INFO - Executing query: WITH needs_with_row AS (
>>>>>>> demo-dev
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
<<<<<<< HEAD
2025-02-13 14:49:46,560 - INFO - Params: None
2025-02-13 15:33:02,220 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 15:33:02,220 - INFO - Params: {}
2025-02-13 15:33:02,498 - INFO - Executing query: 
=======
2025-02-16 12:10:12,906 - INFO - Params: None
2025-02-16 12:10:14,126 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-16 12:10:14,127 - INFO - Params: {}
2025-02-16 12:10:14,908 - INFO - Executing query: 
>>>>>>> demo-dev
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
<<<<<<< HEAD
2025-02-13 15:33:02,499 - INFO - Params: {}
2025-02-13 15:33:21,165 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 15:33:21,220 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 15:33:21,221 - INFO - Params: {}
2025-02-13 15:33:21,639 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 15:35:37,775 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 15:35:37,775 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 15:35:39,236 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 15:35:39,236 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 15:35:39,241 - INFO - Executing query: 
=======
2025-02-16 12:10:14,909 - INFO - Params: {}
2025-02-16 12:10:26,015 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-16 12:10:26,015 - INFO - Params: {}
2025-02-16 12:10:27,802 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-16 12:10:27,802 - INFO - Params: {}
2025-02-16 12:10:39,365 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-16 12:10:39,366 - INFO - Params: {}
2025-02-16 12:10:48,952 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-16 12:10:48,954 - INFO - Params: {}
2025-02-16 12:11:12,905 - ERROR - Error executing query: 
2025-02-16 12:11:12,906 - ERROR - Error executing query: 
2025-02-16 12:11:14,127 - ERROR - Error executing query: 
2025-02-16 12:11:14,910 - ERROR - Error executing query: 
2025-02-16 12:11:18,363 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-16 12:11:18,363 - INFO - Params: {}
2025-02-16 12:11:26,016 - ERROR - Error executing query: 
2025-02-16 12:11:27,804 - ERROR - Error executing query: 
2025-02-16 12:11:39,367 - ERROR - Error executing query: 
2025-02-16 12:12:19,516 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-16 12:12:19,516 - INFO - Params: {}
2025-02-16 12:12:21,799 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-16 12:12:21,800 - INFO - Params: {}
2025-02-16 12:13:19,518 - ERROR - Error executing query: 
2025-02-16 12:13:21,801 - ERROR - Error executing query: 
2025-02-16 12:13:51,677 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-16 12:13:51,678 - INFO - Params: None
2025-02-16 12:13:51,681 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-16 12:13:51,681 - INFO - Params: None
2025-02-16 12:13:52,059 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: СЃС‚РѕР»Р±РµС† "new_apart_id" РЅРµ СЃСѓС‰РµСЃС‚РІСѓРµС‚
HINT:  Р’РѕР·РјРѕР¶РЅРѕ, РїСЂРµРґРїРѕР»Р°РіР°Р»Р°СЃСЊ СЃСЃС‹Р»РєР° РЅР° СЃС‚РѕР»Р±РµС† "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-16 12:13:52,200 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedTableError'>: РѕС‚РЅРѕС€РµРЅРёРµ "family_apartment_needs" РЅРµ СЃСѓС‰РµСЃС‚РІСѓРµС‚
[SQL: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-16 12:13:52,931 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-16 12:13:52,931 - INFO - Params: {}
2025-02-16 12:13:54,151 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-16 12:13:54,151 - INFO - Params: {'district_0': 'Р—РµР»РµРЅРѕРіСЂР°РґСЃРєРёР№ РђРћ'}
2025-02-16 12:13:54,689 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-16 12:13:54,689 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-16 12:13:54,693 - INFO - Executing query: 
>>>>>>> demo-dev
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
<<<<<<< HEAD
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:35:39,242 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 15:36:55,060 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 15:36:55,060 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 15:36:55,436 - INFO - Executing query: 
=======
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-16 12:13:54,693 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-16 12:13:55,630 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-16 12:13:55,631 - INFO - Params: {'municipal_districts_0': 'NaN'}
2025-02-16 12:13:55,632 - INFO - Executing query: 
>>>>>>> demo-dev
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
<<<<<<< HEAD
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:36:55,436 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 15:36:55,437 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 15:36:55,437 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 15:37:05,787 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 15:37:05,787 - INFO - Params: {'apart_id': 864880}
2025-02-13 15:37:10,069 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:37:10,069 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 18, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 15:37:12,194 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:37:12,194 - INFO - Params: {'house_address_0': 'Инженерная ул., дом 10, корп. 1', 'municipal_0': 'Алтуфьевский'}
2025-02-13 15:37:14,020 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 15:37:14,020 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 15:37:14,021 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:37:14,022 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 15:37:15,037 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 15:37:15,037 - INFO - Params: {'apart_id': 864587}
2025-02-13 15:37:21,523 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 15:37:21,523 - INFO - Params: {'district_0': 'Центральный АО'}
2025-02-13 15:37:24,221 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 15:37:24,221 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 15:37:24,222 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:37:24,223 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 15:37:24,613 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 15:37:24,613 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 15:37:24,614 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 15:37:24,614 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 15:37:25,535 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 15:37:25,535 - INFO - Params: {'apart_id': 864587}
2025-02-13 15:37:46,178 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864587
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 15:37:46,179 - INFO - Params: {'apart_id': 864587}
2025-02-13 15:38:03,404 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864877
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 15:38:03,404 - INFO - Params: {'apart_id': 864877}
2025-02-13 16:21:31,937 - INFO - Executing query: 
=======
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-16 12:13:55,632 - INFO - Params: {'municipal_0': 'NaN'}
2025-02-16 12:13:56,224 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-16 12:13:56,224 - INFO - Params: {'municipal_districts_0': 'РљСЂСЋРєРѕРІРѕ'}
2025-02-16 12:13:56,226 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-16 12:13:56,226 - INFO - Params: {'municipal_0': 'РљСЂСЋРєРѕРІРѕ'}
2025-02-16 12:13:56,671 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-16 12:13:56,672 - INFO - Params: {'house_address_0': 'Р—РµР»РµРЅРѕРіСЂР°Рґ, Р—Р°РІРѕРґСЃРєР°СЏ СѓР». (РљСЂСЋРєРѕРІРѕ), Рґ.10', 'municipal_0': 'РљСЂСЋРєРѕРІРѕ'}
2025-02-16 12:13:57,402 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 948537         
                    
2025-02-16 12:13:57,402 - INFO - Params: {'apart_id': 948537}
2025-02-16 12:14:00,409 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-16 12:14:00,409 - INFO - Params: {'district_0': 'РЎР’РђРћ'}
2025-02-16 12:14:01,042 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-16 12:14:01,042 - INFO - Params: {'municipal_districts_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-16 12:14:01,043 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-16 12:14:01,044 - INFO - Params: {'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-16 12:14:01,548 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-16 12:14:01,548 - INFO - Params: {'house_address_0': 'РРЅР¶РµРЅРµСЂРЅР°СЏ СѓР»., РґРѕРј 10, РєРѕСЂРї. 1', 'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-16 12:14:03,105 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 85624698         
                    
2025-02-16 12:14:03,105 - INFO - Params: {'apart_id': 85624698}
2025-02-16 12:14:06,573 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-16 12:14:06,574 - INFO - Params: {}
2025-02-16 12:14:07,672 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-16 12:14:07,672 - INFO - Params: {'district_0': 'РЎР’РђРћ'}
2025-02-16 12:14:08,054 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-16 12:14:08,054 - INFO - Params: {'municipal_districts_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-16 12:14:08,056 - INFO - Executing query: 

				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-16 12:14:08,056 - INFO - Params: {'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-16 12:14:08,600 - INFO - Executing query: 

				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-16 12:14:08,600 - INFO - Params: {'house_address_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРѕРµ С€РѕСЃСЃРµ, Рґ. 53, РєРѕСЂРї. 1', 'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-16 12:14:10,361 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 55070 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-16 12:14:10,361 - INFO - Params: {'apart_id': 55070}
2025-02-16 12:28:52,403 - INFO - Executing query: 
>>>>>>> demo-dev
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
<<<<<<< HEAD
2025-02-13 16:21:31,937 - INFO - Params: {}
2025-02-13 16:21:32,968 - INFO - Executing query: 
=======
2025-02-16 12:28:52,404 - INFO - Params: {}
2025-02-16 12:28:53,962 - INFO - Executing query: 
>>>>>>> demo-dev
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
<<<<<<< HEAD
2025-02-13 16:21:32,969 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:21:36,138 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 16:21:36,138 - INFO - Params: {}
2025-02-13 16:21:36,392 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-13 16:21:36,392 - INFO - Params: {}
2025-02-13 16:21:37,162 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:21:37,162 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:21:37,658 - INFO - Executing query: 
=======
2025-02-16 12:28:53,962 - INFO - Params: {'district_0': 'Р—РµР»РµРЅРѕРіСЂР°РґСЃРєРёР№ РђРћ'}
2025-02-16 12:28:54,482 - INFO - Executing query: 
>>>>>>> demo-dev
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
<<<<<<< HEAD
2025-02-13 16:21:37,658 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:21:37,659 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT 
                        house_address, 
                        apart_number, 
                        district, 
                        municipal_district,
                        floor,
                        full_living_area,
                        total_living_area, 
                        living_area, 
                        room_count, 
                        type_of_settlement, 
                        status.status AS status, 
                        new_apart.notes, 
                        new_apart.new_apart_id,
                        ROW_NUMBER() OVER (PARTITION BY new_apart.new_apart_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM 
                        new_apart
                    LEFT JOIN 
                        offer USING (new_apart_id)
                    LEFT JOIN 
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:21:37,659 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 16:21:49,030 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 16:21:49,030 - INFO - Params: {}
2025-02-13 16:21:50,861 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 16:21:52,104 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN ($1)
            ORDER BY municipal_district
        ]
[parameters: ('Восточный АО',)]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 16:21:55,077 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-02-13 16:21:59,953 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:21:59,953 - INFO - Params: {'district_0': 'СВАО'}
2025-02-13 16:22:00,465 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:22:00,465 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 16:22:00,577 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:22:00,577 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 16:22:01,026 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:22:01,026 - INFO - Params: {'municipal_districts_0': 'Алтуфьевский'}
2025-02-13 16:22:01,030 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:22:01,030 - INFO - Params: {'municipal_0': 'Алтуфьевский'}
2025-02-13 16:22:02,353 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 865013
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 16:22:02,353 - INFO - Params: {'apart_id': 865013}
2025-02-13 16:22:06,681 - INFO - Executing query: 
                WITH new_apartment_list AS (
                    SELECT 
                        o.family_apartment_needs_id,
                        JSON_AGG(
                            JSON_BUILD_OBJECT(
                                'house_address', na.house_address,
                                'apart_number', na.apart_number,
                                'district', na.district,
                                'municipal_district', na.municipal_district,
                                'full_living_area', na.full_living_area,
                                'total_living_area', na.total_living_area,
                                'living_area', na.living_area,
                                'room_count', na.room_count,
                                'type_of_settlement', na.type_of_settlement,
                                'notes', na.notes,
                                'status', COALESCE(s.status, '?'),
                                'sentence_date', o.sentence_date :: DATE,
                                'answer_date', o.answer_date :: DATE
                            )
                        ) FILTER (WHERE na.house_address IS NOT NULL OR na.apart_number IS NOT NULL OR na.district IS NOT NULL OR na.municipal_district IS NOT NULL 
                        OR na.full_living_area IS NOT NULL OR na.total_living_area IS NOT NULL OR na.living_area IS NOT NULL 
                        OR na.room_count IS NOT NULL OR na.type_of_settlement IS NOT NULL OR na.notes IS NOT NULL 
                        OR s.status IS NOT NULL OR o.sentence_date IS NOT NULL OR o.answer_date IS NOT NULL) AS new_apartments
                    FROM 
                        offer o
                    LEFT JOIN 
                        new_apart na ON o.new_apart_id = na.new_apart_id
                    LEFT JOIN 
                        status s ON o.status_id = s.status_id
                    GROUP BY 
                        o.family_apartment_needs_id
                )
                SELECT 
                    fan.family_apartment_needs_id,
                    fs.house_address,
                    fs.apart_number,
                    fs.district,
                    fs.municipal_district,
                    fs.full_living_area,
                    fs.total_living_area,
                    fs.living_area,
                    fs.room_count,
                    fs.type_of_settlement,
                    nal.new_apartments
                FROM 
                    family_apartment_needs fan
                LEFT JOIN 
                    family_structure fs ON fan.affair_id = fs.affair_id
                LEFT JOIN 
                    new_apartment_list nal ON fan.family_apartment_needs_id = nal.family_apartment_needs_id
                WHERE
                    fan.family_apartment_needs_id = 864880
                ORDER BY 
                    fs.affair_id;
            
2025-02-13 16:22:06,681 - INFO - Params: {'apart_id': 864880}
2025-02-13 16:29:58,601 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM family_structure
            ORDER BY district
        
2025-02-13 16:29:58,601 - INFO - Params: {}
2025-02-13 16:29:59,642 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:29:59,642 - INFO - Params: {'district_0': 'Восточный АО'}
2025-02-13 16:30:00,082 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        family_structure.notes,
                        family_apartment_needs_id,
                        ROW_NUMBER() OVER (PARTITION BY family_apartment_needs_id ORDER BY offer.sentence_date DESC, offer.answer_date DESC) AS rn
                    FROM
                        family_structure
                    LEFT JOIN
                        family_apartment_needs USING (affair_id)
                    LEFT JOIN
                        offer USING (family_apartment_needs_id)
                    LEFT JOIN
                        status ON offer.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-13 16:30:00,082 - INFO - Params: {'municipal_0': 'Богородское'}
2025-02-13 16:30:00,083 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM family_structure
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-13 16:30:00,083 - INFO - Params: {'municipal_districts_0': 'Богородское'}
2025-02-13 16:31:43,105 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM family_structure
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-13 16:31:43,105 - INFO - Params: {'district_0': 'Троицкий АО'}
=======
2025-02-16 12:28:54,483 - INFO - Params: {'municipal_districts_0': 'РљСЂСЋРєРѕРІРѕ'}
2025-02-16 12:28:54,484 - INFO - Executing query: 

				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-16 12:28:54,484 - INFO - Params: {'municipal_0': 'РљСЂСЋРєРѕРІРѕ'}
2025-02-16 12:28:55,050 - INFO - Executing query: 

				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-16 12:28:55,050 - INFO - Params: {'house_address_0': 'Р“РµРѕСЂРіРёРµРІСЃРєРёР№ РїСЂ-С‚ РєРѕСЂ.1934', 'municipal_0': 'РљСЂСЋРєРѕРІРѕ'}
2025-02-16 12:28:59,035 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 8866930 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-16 12:28:59,035 - INFO - Params: {'apart_id': 8866930}
2025-02-16 12:28:59,945 - INFO - Executing query: WITH unnset_offer AS (
                    SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)
                ),
                lft AS (
                    SELECT 
                        o.affair_id,
                        o.new_apart_id,
                        na.house_address,
                        na.apart_number,
                        na.district,
                        na.municipal_district,
                        na.full_living_area,
                        na.total_living_area,
                        na.living_area,
                        na.room_count,
                        na.type_of_settlement,
                        na.notes,
                        s.status,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        unnset_offer o 
                        LEFT JOIN new_apart na USING (new_apart_id)
                        LEFT JOIN status s ON o.status_id = s.status_id
                ),
                old_apart_data AS (
                    SELECT 
                        oa.affair_id,
                        oa.house_address,
                        oa.apart_number,
                        oa.district,
                        oa.municipal_district,
                        oa.full_living_area,
                        oa.total_living_area,
                        oa.living_area,
                        oa.room_count,
                        oa.type_of_settlement,
                        o.sentence_date,
                        o.answer_date
                    FROM 
                        old_apart oa
                        LEFT JOIN unnset_offer o ON oa.affair_id = o.affair_id
                )
                SELECT 
                                    na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count,
                        jsonb_agg(
                            jsonb_build_object(
                                'house_address', oa.house_address,
                                'apart_number', oa.apart_number,
                                'district', oa.district,
                                'municipal_district', oa.municipal_district,
                                'full_living_area', oa.full_living_area,
                                'total_living_area', oa.total_living_area,
                                'living_area', oa.living_area,
                                'room_count', oa.room_count,
                                'type_of_settlement', oa.type_of_settlement,
                                'sentence_date', oa.sentence_date,
                                'answer_date', oa.answer_date
                            ) ORDER BY 
                                oa.sentence_date DESC NULLS LAST, 
                                oa.answer_date DESC NULLS LAST
                        )
                    AS old_apartments
                FROM 
                    lft na
                    LEFT JOIN old_apart_data oa ON na.affair_id = oa.affair_id
                    where new_apart_id = 8866931 
                GROUP BY 
                                        na.new_apart_id,
                                            na.house_address,
                                            na.apart_number,
                                            na.district,
                                            na.municipal_district,
                                            na.full_living_area,
                                            na.total_living_area,
                                            na.living_area,
                                            na.room_count
                ORDER BY 
                    na.new_apart_id;
2025-02-16 12:28:59,946 - INFO - Params: {'apart_id': 8866931}
2025-02-16 12:29:33,173 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 8866933
                    
2025-02-16 12:29:33,173 - INFO - Params: {'apart_id': 8866933}
2025-02-16 12:29:34,796 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 8866931
                    
2025-02-16 12:29:34,796 - INFO - Params: {'apart_id': 8866931}
2025-02-16 12:29:35,346 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 8866932
                    
2025-02-16 12:29:35,346 - INFO - Params: {'apart_id': 8866932}
2025-02-16 12:29:35,763 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 8866934
                    
2025-02-16 12:29:35,763 - INFO - Params: {'apart_id': 8866934}
2025-02-16 12:29:36,192 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 8866935
                    
2025-02-16 12:29:36,192 - INFO - Params: {'apart_id': 8866935}
2025-02-16 12:29:37,368 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-16 12:29:37,368 - INFO - Params: {'district_0': 'РЎР’РђРћ'}
2025-02-16 12:29:37,721 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-16 12:29:37,722 - INFO - Params: {'municipal_districts_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-16 12:29:37,724 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-16 12:29:37,724 - INFO - Params: {'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-16 12:29:38,077 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-16 12:29:38,077 - INFO - Params: {'municipal_districts_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-16 12:29:38,756 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-16 12:29:38,756 - INFO - Params: {'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-16 12:29:39,200 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-16 12:29:39,200 - INFO - Params: {'municipal_districts_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-16 12:29:39,327 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-16 12:29:39,327 - INFO - Params: {'house_address_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРѕРµ С€РѕСЃСЃРµ, Рґ. 53, РєРѕСЂРї. 1', 'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-16 12:29:39,579 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-16 12:29:39,579 - INFO - Params: {'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-16 12:29:40,409 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-16 12:29:40,409 - INFO - Params: {'house_address_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРѕРµ С€РѕСЃСЃРµ, Рґ. 53, РєРѕСЂРї. 1', 'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-16 12:29:42,251 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 55072
                    
2025-02-16 12:29:42,252 - INFO - Params: {'apart_id': 55072}
>>>>>>> demo-dev
2025-02-17 09:41:07,638 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-17 09:41:07,638 - INFO - Params: {}
2025-02-17 09:41:32,131 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-17 09:41:32,131 - INFO - Params: {}
2025-02-17 09:41:33,324 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-17 09:41:33,324 - INFO - Params: {}
2025-02-17 09:41:34,295 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-17 09:41:34,295 - INFO - Params: {'district_0': 'Р—Р°РїР°РґРЅС‹Р№ РђРћ'}
2025-02-17 09:41:34,863 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-17 09:41:34,863 - INFO - Params: {'municipal_districts_0': 'Р’РЅСѓРєРѕРІРѕ'}
2025-02-17 09:41:34,865 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-17 09:41:34,865 - INFO - Params: {'municipal_0': 'Р’РЅСѓРєРѕРІРѕ'}
2025-02-17 09:41:35,276 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-17 09:41:35,276 - INFO - Params: {'house_address_0': 'РћСЃРёРїРµРЅРєРѕ СѓР». (РїРѕСЃ.РўРѕР»СЃС‚РѕРїР°Р»СЊС†РµРІРѕ), Рґ.8 СЃС‚СЂ. 3', 'municipal_0': 'Р’РЅСѓРєРѕРІРѕ'}
2025-02-17 09:41:36,864 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 978857         
                    
2025-02-17 09:41:36,864 - INFO - Params: {'apart_id': 978857}
2025-02-17 09:41:38,769 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-17 09:41:38,770 - INFO - Params: {}
2025-02-17 09:41:40,170 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-17 09:41:40,170 - INFO - Params: {'district_0': 'РЎРµРІРµСЂРЅС‹Р№ РђРћ'}
2025-02-17 09:41:40,646 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-17 09:41:40,646 - INFO - Params: {'district_0': 'РЎР’РђРћ'}
2025-02-17 09:41:41,589 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-17 09:41:41,589 - INFO - Params: {'municipal_districts_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 09:41:41,591 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 09:41:41,592 - INFO - Params: {'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 09:41:41,984 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 09:41:41,984 - INFO - Params: {'house_address_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРѕРµ С€РѕСЃСЃРµ, Рґ. 53, РєРѕСЂРї. 1', 'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 09:41:42,800 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 55070
                    
2025-02-17 09:41:42,800 - INFO - Params: {'apart_id': 55070}
2025-02-17 09:48:06,631 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-17 09:48:06,631 - INFO - Params: {'district_0': 'Р”Р–Рџ Рё Р–Р¤ (Р“Р°Р·РµС‚РЅС‹Р№ РїРµСЂ.,1/12)'}
2025-02-17 09:48:07,030 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-17 09:48:07,030 - INFO - Params: {'municipal_districts_0': '#6101'}
2025-02-17 09:48:07,032 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-17 09:48:07,032 - INFO - Params: {'municipal_0': '#6101'}
2025-02-17 09:48:07,417 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-17 09:48:07,417 - INFO - Params: {'house_address_0': 'Р›РµСЂРјРѕРЅС‚РѕРІСЃРєРёР№ РїСЂРѕСЃРї., Рґ.161', 'municipal_0': '#6101'}
2025-02-17 09:48:08,432 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 960267         
                    
2025-02-17 09:48:08,432 - INFO - Params: {'apart_id': 960267}
2025-02-17 09:48:09,786 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-17 09:48:09,786 - INFO - Params: {}
2025-02-17 09:48:10,243 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-17 09:48:10,243 - INFO - Params: {'district_0': 'Р’РѕСЃС‚РѕС‡РЅС‹Р№ РђРћ'}
2025-02-17 09:48:10,689 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-17 09:48:10,689 - INFO - Params: {'municipal_districts_0': 'Р’РѕСЃС‚РѕС‡РЅС‹Р№'}
2025-02-17 09:48:10,690 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 09:48:10,690 - INFO - Params: {'municipal_0': 'Р’РѕСЃС‚РѕС‡РЅС‹Р№'}
2025-02-17 09:48:11,118 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 09:48:11,118 - INFO - Params: {'house_address_0': 'Р”РµРІСЏС‚РѕРіРѕ РњР°СЏ СѓР»., Рґ.28 РєРѕСЂ.1', 'municipal_0': 'Р’РѕСЃС‚РѕС‡РЅС‹Р№'}
2025-02-17 09:48:11,724 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 8953370
                    
2025-02-17 09:48:11,724 - INFO - Params: {'apart_id': 8953370}
2025-02-17 09:48:13,923 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-17 09:48:13,924 - INFO - Params: {'district_0': 'РЎР’РђРћ'}
2025-02-17 09:48:15,056 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-17 09:48:15,056 - INFO - Params: {'municipal_districts_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 09:48:15,057 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 09:48:15,058 - INFO - Params: {'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 09:48:15,620 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 09:48:15,620 - INFO - Params: {'house_address_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРѕРµ С€РѕСЃСЃРµ, Рґ. 53, РєРѕСЂРї. 1', 'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 09:48:16,369 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 55073
                    
2025-02-17 09:48:16,369 - INFO - Params: {'apart_id': 55073}
2025-02-17 09:48:18,181 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-17 09:48:18,182 - INFO - Params: {}
2025-02-17 09:48:18,655 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-17 09:48:18,655 - INFO - Params: {'district_0': 'РЎР’РђРћ'}
2025-02-17 09:48:19,223 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-17 09:48:19,223 - INFO - Params: {'municipal_districts_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 09:48:19,224 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-17 09:48:19,224 - INFO - Params: {'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 09:48:19,698 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-17 09:48:19,698 - INFO - Params: {'house_address_0': 'РРЅР¶РµРЅРµСЂРЅР°СЏ СѓР»., РґРѕРј 10, РєРѕСЂРї. 1', 'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 09:48:20,498 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 85624707         
                    
2025-02-17 09:48:20,498 - INFO - Params: {'apart_id': 85624707}
2025-02-17 09:48:57,932 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 09:48:57,932 - INFO - Params: None
2025-02-17 09:48:57,937 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 09:48:57,937 - INFO - Params: None
2025-02-17 09:48:57,947 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedTableError'>: РѕС‚РЅРѕС€РµРЅРёРµ "family_apartment_needs" РЅРµ СЃСѓС‰РµСЃС‚РІСѓРµС‚
[SQL: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-17 09:48:57,948 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: СЃС‚РѕР»Р±РµС† "new_apart_id" РЅРµ СЃСѓС‰РµСЃС‚РІСѓРµС‚
HINT:  Р’РѕР·РјРѕР¶РЅРѕ, РїСЂРµРґРїРѕР»Р°РіР°Р»Р°СЃСЊ СЃСЃС‹Р»РєР° РЅР° СЃС‚РѕР»Р±РµС† "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-17 09:49:58,003 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 09:49:58,003 - INFO - Params: None
2025-02-17 09:49:58,004 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 09:49:58,004 - INFO - Params: None
2025-02-17 09:49:58,017 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedTableError'>: РѕС‚РЅРѕС€РµРЅРёРµ "family_apartment_needs" РЅРµ СЃСѓС‰РµСЃС‚РІСѓРµС‚
[SQL: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-17 09:49:58,017 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: СЃС‚РѕР»Р±РµС† "new_apart_id" РЅРµ СЃСѓС‰РµСЃС‚РІСѓРµС‚
HINT:  Р’РѕР·РјРѕР¶РЅРѕ, РїСЂРµРґРїРѕР»Р°РіР°Р»Р°СЃСЊ СЃСЃС‹Р»РєР° РЅР° СЃС‚РѕР»Р±РµС† "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-17 09:49:58,178 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 09:49:58,178 - INFO - Params: None
2025-02-17 09:49:58,179 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 09:49:58,179 - INFO - Params: None
2025-02-17 09:49:58,190 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedTableError'>: РѕС‚РЅРѕС€РµРЅРёРµ "family_apartment_needs" РЅРµ СЃСѓС‰РµСЃС‚РІСѓРµС‚
[SQL: WITH needs_with_row AS (
    SELECT 
        family_apartment_needs_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY family_apartment_needs.family_apartment_needs_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM family_apartment_needs
    JOIN offer USING (family_apartment_needs_id)
),
clear_data AS (
    SELECT family_apartment_needs_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM family_apartment_needs 
    JOIN family_structure USING (affair_id)
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.family_apartment_needs_id = family_apartment_needs.family_apartment_needs_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-17 09:49:58,191 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: СЃС‚РѕР»Р±РµС† "new_apart_id" РЅРµ СЃСѓС‰РµСЃС‚РІСѓРµС‚
HINT:  Р’РѕР·РјРѕР¶РЅРѕ, РїСЂРµРґРїРѕР»Р°РіР°Р»Р°СЃСЊ СЃСЃС‹Р»РєР° РЅР° СЃС‚РѕР»Р±РµС† "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-17 09:59:55,615 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        affair_id,
        offer.status_id,
        ROW_NUMBER() OVER (
            PARTITION BY old_apart.affair_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM old_apart
    JOIN offer USING (affair_id)
),
clear_data AS (
    SELECT affair_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM old_apart 
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.affair_id = old_apart.affair_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 09:59:55,615 - INFO - Params: None
2025-02-17 09:59:55,628 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 09:59:55,629 - INFO - Params: None
2025-02-17 09:59:55,763 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: СЃС‚РѕР»Р±РµС† "new_apart_id" РЅРµ СЃСѓС‰РµСЃС‚РІСѓРµС‚
HINT:  Р’РѕР·РјРѕР¶РЅРѕ, РїСЂРµРґРїРѕР»Р°РіР°Р»Р°СЃСЊ СЃСЃС‹Р»РєР° РЅР° СЃС‚РѕР»Р±РµС† "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-17 10:00:33,161 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        affair_id,
        offer.status_id,
        ROW_NUMBER() OVER (
            PARTITION BY old_apart.affair_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM old_apart
    JOIN offer USING (affair_id)
),
clear_data AS (
    SELECT affair_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM old_apart 
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.affair_id = old_apart.affair_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 10:00:33,161 - INFO - Params: None
2025-02-17 10:00:33,170 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 10:00:33,171 - INFO - Params: None
2025-02-17 10:00:33,183 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: СЃС‚РѕР»Р±РµС† "new_apart_id" РЅРµ СЃСѓС‰РµСЃС‚РІСѓРµС‚
HINT:  Р’РѕР·РјРѕР¶РЅРѕ, РїСЂРµРґРїРѕР»Р°РіР°Р»Р°СЃСЊ СЃСЃС‹Р»РєР° РЅР° СЃС‚РѕР»Р±РµС† "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-17 10:00:39,642 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-17 10:00:39,643 - INFO - Params: {}
2025-02-17 10:10:26,846 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        affair_id,
        offer.status_id,
        ROW_NUMBER() OVER (
            PARTITION BY old_apart.affair_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM old_apart
    JOIN offer USING (affair_id)
),
clear_data AS (
    SELECT affair_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM old_apart 
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.affair_id = old_apart.affair_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 10:10:26,847 - INFO - Params: None
2025-02-17 10:10:26,849 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 10:10:26,850 - INFO - Params: None
2025-02-17 10:10:26,861 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: СЃС‚РѕР»Р±РµС† "new_apart_id" РЅРµ СЃСѓС‰РµСЃС‚РІСѓРµС‚
HINT:  Р’РѕР·РјРѕР¶РЅРѕ, РїСЂРµРґРїРѕР»Р°РіР°Р»Р°СЃСЊ СЃСЃС‹Р»РєР° РЅР° СЃС‚РѕР»Р±РµС† "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-17 10:30:26,065 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        affair_id,
        offer.status_id,
        ROW_NUMBER() OVER (
            PARTITION BY old_apart.affair_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM old_apart
    JOIN offer USING (affair_id)
),
clear_data AS (
    SELECT affair_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM old_apart 
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.affair_id = old_apart.affair_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 10:30:26,066 - INFO - Params: None
2025-02-17 10:30:26,073 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 10:30:26,073 - INFO - Params: None
2025-02-17 10:30:26,209 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: СЃС‚РѕР»Р±РµС† "new_apart_id" РЅРµ СЃСѓС‰РµСЃС‚РІСѓРµС‚
HINT:  Р’РѕР·РјРѕР¶РЅРѕ, РїСЂРµРґРїРѕР»Р°РіР°Р»Р°СЃСЊ СЃСЃС‹Р»РєР° РЅР° СЃС‚РѕР»Р±РµС† "offer.new_aparts".
[SQL: WITH needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-02-17 10:30:59,374 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        affair_id,
        offer.status_id,
        ROW_NUMBER() OVER (
            PARTITION BY old_apart.affair_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM old_apart
    JOIN offer USING (affair_id)
),
clear_data AS (
    SELECT affair_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM old_apart 
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.affair_id = old_apart.affair_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 10:30:59,375 - INFO - Params: None
2025-02-17 10:30:59,380 - INFO - Executing query: WITH unnst AS (
	SELECT 
	(key)::integer as new_apart_id, 
	(value->'status_id')::integer as status_id,
	sentence_date, 
	answer_date
	FROM offer, jsonb_each(new_aparts)
),
needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM unnst as offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 10:30:59,380 - INFO - Params: None
2025-02-17 10:31:07,351 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        affair_id,
        offer.status_id,
        ROW_NUMBER() OVER (
            PARTITION BY old_apart.affair_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM old_apart
    JOIN offer USING (affair_id)
),
clear_data AS (
    SELECT affair_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM old_apart 
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.affair_id = old_apart.affair_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 10:31:07,351 - INFO - Params: None
2025-02-17 10:31:07,353 - INFO - Executing query: WITH unnst AS (
	SELECT 
	(key)::integer as new_apart_id, 
	(value->'status_id')::integer as status_id,
	sentence_date, 
	answer_date
	FROM offer, jsonb_each(new_aparts)
),
needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM unnst as offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 10:31:07,353 - INFO - Params: None
=======
>>>>>>> f30caea (big query changes)
2025-02-17 10:52:14,361 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        affair_id,
        offer.status_id,
        ROW_NUMBER() OVER (
            PARTITION BY old_apart.affair_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM old_apart
    JOIN offer USING (affair_id)
),
clear_data AS (
    SELECT affair_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM old_apart 
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.affair_id = old_apart.affair_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 10:52:14,363 - INFO - Params: None
2025-02-17 10:52:14,368 - INFO - Executing query: WITH unnst AS (
	SELECT 
	(key)::integer as new_apart_id, 
	(value->'status_id')::integer as status_id,
	sentence_date, 
	answer_date
	FROM offer, jsonb_each(new_aparts)
),
needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM unnst as offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-17 10:52:14,369 - INFO - Params: None
2025-02-17 10:52:20,417 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-17 10:52:20,417 - INFO - Params: {}
2025-02-17 10:52:21,252 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-17 10:52:21,252 - INFO - Params: {'district_0': 'РЎР’РђРћ'}
2025-02-17 10:52:21,783 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-17 10:52:21,783 - INFO - Params: {'municipal_districts_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 10:52:21,786 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-17 10:52:21,786 - INFO - Params: {'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 10:52:22,135 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-17 10:52:22,135 - INFO - Params: {'house_address_0': 'РРЅР¶РµРЅРµСЂРЅР°СЏ СѓР»., РґРѕРј 10, РєРѕСЂРї. 1', 'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 10:52:22,826 - INFO - Executing query: 
                        WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    affair_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', na.house_address,
                            'apart_number', na.apart_number,
                            'district', na.district,
                            'municipal_district', na.municipal_district,
                            'full_living_area', na.full_living_area,
                            'total_living_area', na.total_living_area,
                            'living_area', na.living_area,
                            'room_count', na.room_count,
                            'type_of_settlement', na.type_of_settlement,
                            'notes', na.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS new_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    new_apart na ON o.new_apart_id = na.new_apart_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.affair_id
                )
            SELECT old_apart.affair_id, 
                    old_apart.house_address,
                    old_apart.apart_number,
                    old_apart.district,
                    old_apart.municipal_district,
                    old_apart.full_living_area,
                    old_apart.total_living_area,
                    old_apart.living_area,
                    old_apart.room_count,
                    old_apart.type_of_settlement,
                    joined_aparts.new_apartments
                    from old_apart  
                    left join 
                    joined_aparts using (affair_id) 
                    WHERE affair_id = 85624707         
                    
2025-02-17 10:52:22,826 - INFO - Params: {'apart_id': 85624707}
2025-02-17 10:52:24,088 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-17 10:52:24,089 - INFO - Params: {}
2025-02-17 10:52:24,514 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-17 10:52:24,514 - INFO - Params: {'district_0': 'РЎР’РђРћ'}
2025-02-17 10:52:24,981 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-17 10:52:24,981 - INFO - Params: {'district_0': 'РЎРµРІРµСЂРЅС‹Р№ РђРћ'}
2025-02-17 10:52:25,560 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-17 10:52:25,561 - INFO - Params: {'municipal_districts_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 10:52:25,564 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 10:52:25,564 - INFO - Params: {'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 10:52:25,949 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 10:52:25,949 - INFO - Params: {'house_address_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРѕРµ С€РѕСЃСЃРµ, Рґ. 53, РєРѕСЂРї. 1', 'municipal_0': 'РђР»С‚СѓС„СЊРµРІСЃРєРёР№'}
2025-02-17 10:52:26,752 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 55071
                    
2025-02-17 10:52:26,752 - INFO - Params: {'apart_id': 55071}
2025-02-17 10:54:01,414 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 55076
                    
2025-02-17 10:54:01,414 - INFO - Params: {'apart_id': 55076}
2025-02-17 10:54:02,668 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-17 10:54:02,668 - INFO - Params: {'district_0': 'РЎРµРІРµСЂРѕ-Р—Р°РїР°РґРЅС‹Р№ РђРћ'}
2025-02-17 10:54:03,430 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-17 10:54:03,430 - INFO - Params: {'municipal_districts_0': 'РњРёС‚РёРЅРѕ'}
2025-02-17 10:54:03,432 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 10:54:03,432 - INFO - Params: {'municipal_0': 'РњРёС‚РёРЅРѕ'}
2025-02-17 10:54:03,923 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-17 10:54:03,923 - INFO - Params: {'municipal_districts_0': 'РњРёС‚РёРЅРѕ'}
2025-02-17 10:54:03,925 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 10:54:03,925 - INFO - Params: {'municipal_0': 'РњРёС‚РёРЅРѕ'}
2025-02-17 10:54:04,761 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 8358548
                    
2025-02-17 10:54:04,761 - INFO - Params: {'apart_id': 8358548}
2025-02-17 10:54:05,839 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 8358541
                    
2025-02-17 10:54:05,839 - INFO - Params: {'apart_id': 8358541}
2025-02-17 10:54:06,138 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 7943021
                    
2025-02-17 10:54:06,138 - INFO - Params: {'apart_id': 7943021}
