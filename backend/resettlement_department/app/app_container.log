2025-02-17 11:42:00,291 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 11:42:00,291 - INFO - Params: {'house_address_0': '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —É–ª., –¥.21 –∫–æ—Ä.1', 'municipal_0': '–ê–ª—Ç—É—Ñ—å–µ–≤—Å–∫–∏–π'}
2025-02-17 11:42:00,967 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 11:42:00,967 - INFO - Params: {'house_address_0': '–ê–ª—Ç—É—Ñ—å–µ–≤—Å–∫–æ–µ —à–æ—Å—Å–µ, –¥. 53, –∫–æ—Ä–ø. 2', 'municipal_0': '–ê–ª—Ç—É—Ñ—å–µ–≤—Å–∫–∏–π'}
2025-02-17 11:42:01,885 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 53740
                    
2025-02-17 11:42:01,885 - INFO - Params: {'apart_id': 53740}
2025-02-17 11:42:03,145 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-17 11:42:03,145 - INFO - Params: {'district_0': '–ù–æ–≤–æ–º–æ—Å–∫–æ–≤—Å–∫–∏–π –ê–û'}
2025-02-17 11:42:03,885 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-17 11:42:03,885 - INFO - Params: {'municipal_districts_0': '–í–Ω—É–∫–æ–≤—Å–∫–æ–µ —Å–µ–ª—å—Å–∫–æ–µ –ø–æ—Å–µ–ª–µ–Ω–∏–µ'}
2025-02-17 11:42:03,887 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 11:42:03,887 - INFO - Params: {'municipal_0': '–í–Ω—É–∫–æ–≤—Å–∫–æ–µ —Å–µ–ª—å—Å–∫–æ–µ –ø–æ—Å–µ–ª–µ–Ω–∏–µ'}
2025-02-17 11:42:04,347 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 11:42:04,347 - INFO - Params: {'house_address_0': '–ê–Ω–Ω—ã –ê—Ö–º–∞—Ç–æ–≤–æ–π —É–ª. (–ø.–í–Ω—É–∫–æ–≤—Å–∫–æ–µ), –¥.10', 'municipal_0': '–í–Ω—É–∫–æ–≤—Å–∫–æ–µ —Å–µ–ª—å—Å–∫–æ–µ –ø–æ—Å–µ–ª–µ–Ω–∏–µ'}
2025-02-17 11:42:04,775 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 8006871
                    
2025-02-17 11:42:04,775 - INFO - Params: {'apart_id': 8006871}
2025-02-17 12:01:37,588 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-17 12:01:37,588 - INFO - Params: {}
2025-02-18 12:51:58,598 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-18 12:51:58,603 - INFO - Params: {}
2025-02-18 12:52:19,118 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-18 12:52:19,118 - INFO - Params: {}
2025-02-18 12:52:19,892 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-18 12:52:19,892 - INFO - Params: {}
2025-02-18 12:52:42,594 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-18 12:52:42,594 - INFO - Params: {}
2025-02-18 12:52:42,987 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-18 12:52:42,987 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-18 12:52:46,510 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-18 12:52:46,510 - INFO - Params: {'district_0': '—¬¿Œ'}
2025-02-18 12:52:46,918 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-18 12:52:46,918 - INFO - Params: {'municipal_districts_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-18 12:52:46,925 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-18 12:52:46,925 - INFO - Params: {'municipal_0': '¿ÎÚÛÙ¸Â‚ÒÍËÈ'}
2025-02-18 12:52:49,525 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 53738
                    
2025-02-18 12:52:49,525 - INFO - Params: {'apart_id': 53738}
2025-02-18 12:52:54,133 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 53806
                    
2025-02-18 12:52:54,133 - INFO - Params: {'apart_id': 53806}
2025-02-18 12:52:57,250 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        affair_id,
        offer.status_id,
        ROW_NUMBER() OVER (
            PARTITION BY old_apart.affair_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM old_apart
    JOIN offer USING (affair_id)
),
clear_data AS (
    SELECT affair_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM old_apart 
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.affair_id = old_apart.affair_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-18 12:52:57,250 - INFO - Params: None
2025-02-18 12:52:57,292 - INFO - Executing query: WITH unnst AS (
	SELECT 
	(key)::integer as new_apart_id, 
	(value->'status_id')::integer as status_id,
	sentence_date, 
	answer_date
	FROM offer, jsonb_each(new_aparts)
),
needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM unnst as offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-18 12:52:57,292 - INFO - Params: None
2025-02-18 12:59:30,279 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        affair_id,
        offer.status_id,
        ROW_NUMBER() OVER (
            PARTITION BY old_apart.affair_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM old_apart
    JOIN offer USING (affair_id)
),
clear_data AS (
    SELECT affair_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM old_apart 
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.affair_id = old_apart.affair_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-18 12:59:30,279 - INFO - Params: None
2025-02-18 12:59:30,280 - INFO - Executing query: WITH unnst AS (
	SELECT 
	(key)::integer as new_apart_id, 
	(value->'status_id')::integer as status_id,
	sentence_date, 
	answer_date
	FROM offer, jsonb_each(new_aparts)
),
needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM unnst as offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-18 12:59:30,280 - INFO - Params: None
2025-02-18 12:59:31,455 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        affair_id,
        offer.status_id,
        ROW_NUMBER() OVER (
            PARTITION BY old_apart.affair_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM old_apart
    JOIN offer USING (affair_id)
),
clear_data AS (
    SELECT affair_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM old_apart 
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.affair_id = old_apart.affair_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-18 12:59:31,456 - INFO - Params: None
2025-02-18 12:59:31,457 - INFO - Executing query: WITH unnst AS (
	SELECT 
	(key)::integer as new_apart_id, 
	(value->'status_id')::integer as status_id,
	sentence_date, 
	answer_date
	FROM offer, jsonb_each(new_aparts)
),
needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM unnst as offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-18 12:59:31,457 - INFO - Params: None
2025-02-18 12:59:45,458 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-18 12:59:45,458 - INFO - Params: {}
2025-02-18 14:38:42,410 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-18 14:38:42,410 - INFO - Params: {}
2025-02-18 14:38:43,785 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-18 14:38:43,785 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-18 14:38:44,115 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-18 14:38:44,115 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-18 14:38:44,119 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-18 14:38:44,119 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-18 14:39:10,610 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-18 14:39:10,610 - INFO - Params: {}
2025-02-18 14:39:26,239 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-18 14:39:26,239 - INFO - Params: {'district_0': '¬ÓÒÚÓ˜Ì˚È ¿Œ'}
2025-02-18 14:39:26,597 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-18 14:39:26,597 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-18 14:39:26,674 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-18 14:39:26,675 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-18 14:39:27,215 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-18 14:39:27,215 - INFO - Params: {'house_address_0': ' ÛÁÌÂˆÓ‚ÒÍ‡ˇ ÛÎ., ‰.7', 'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-02-18 14:41:29,882 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-18 14:41:29,882 - INFO - Params: {}
2025-03-19 19:34:13,585 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 19:34:13,587 - INFO - Params: {}
2025-03-19 19:34:25,338 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 19:34:25,338 - INFO - Params: {}
2025-03-19 19:34:34,638 - ERROR - Error executing query: [Errno 10060] Connect call failed ('10.9.96.160', 5432)
2025-03-19 19:34:46,389 - ERROR - Error executing query: [Errno 10060] Connect call failed ('10.9.96.160', 5432)
2025-03-19 19:35:21,918 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 19:35:21,918 - INFO - Params: {}
2025-03-19 19:35:42,292 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-03-19 19:35:42,292 - INFO - Params: {'district_0': '¬¿Œ'}
2025-03-19 19:35:42,591 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-03-19 19:35:42,591 - INFO - Params: {'municipal_districts_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-03-19 19:35:42,658 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-03-19 19:35:42,658 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-03-19 19:54:40,667 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 19:54:41,929 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-03-19 19:54:41,929 - INFO - Params: {'district_0': '¬¿Œ'}
2025-03-19 19:54:42,749 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_0)
            ORDER BY house_address
        
2025-03-19 19:54:42,749 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-03-19 19:54:42,754 - INFO - Executing query: WITH ranked_apartments AS (
    SELECT
        offer_id,
        house_address,
        apart_number,
        district,
        municipal_district,
        floor,
        fio,
        full_living_area,
        total_living_area,
        living_area,
        room_count,
        type_of_settlement,
        status.status,
        oa.notes,
        affair_id,
        is_queue,
        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC, o.created_at DESC) AS rn,
        COUNT(o.affair_id) OVER (PARTITION BY oa.affair_id) AS selection_count
    FROM
        old_apart oa
    LEFT JOIN
        offer o USING (affair_id)
    LEFT JOIN
        status ON o.status_id = status.status_id
)
SELECT *
FROM ranked_apartments WHERE rn = 1 AND municipal_district IN (:municipal_0)
2025-03-19 19:54:42,754 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-03-19 19:54:45,305 - INFO - Executing query: WITH unnested_offer AS (
    SELECT 
        offer_id,
        affair_id,
        (KEY)::integer AS new_apart_id,
        (VALUE->'status_id')::integer AS status_id,
        sentence_date, 
        answer_date, 
        created_at, 
        updated_at,
        declined_reason_id
    FROM offer, 
    jsonb_each(new_aparts)
),
joined_aparts AS (
    SELECT 
        o.offer_id,
        o.affair_id,
        JSON_OBJECT_AGG(
            o.new_apart_id::text,
            JSON_BUILD_OBJECT(
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', s.status,
                'sentence_date', o.sentence_date::DATE,
                'answer_date', o.answer_date::DATE,
                'decline_reason_notes', dr.notes
            )::jsonb
        )::jsonb AS new_apartments
    FROM 
        unnested_offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    LEFT JOIN 
        decline_reason dr ON o.declined_reason_id = dr.declined_reason_id
    WHERE 
        o.new_apart_id IS NOT NULL  
    GROUP BY 
        o.offer_id,
        o.affair_id
)
SELECT 
    old_apart.affair_id, 
    old_apart.house_address,
    old_apart.apart_number,
    old_apart.district,
    old_apart.municipal_district,
    old_apart.fio,
    old_apart.full_living_area,
    old_apart.total_living_area,
    old_apart.living_area,
    old_apart.room_count,
    old_apart.type_of_settlement,
    old_apart.is_queue,
    JSON_OBJECT_AGG(
        joined_aparts.offer_id::text,
        joined_aparts.new_apartments
        ORDER BY joined_aparts.offer_id
    ) FILTER (WHERE joined_aparts.offer_id IS NOT NULL)::jsonb AS offers
FROM 
    old_apart  
LEFT JOIN 
    joined_aparts ON old_apart.affair_id = joined_aparts.affair_id
WHERE old_apart.affair_id = :apart_id
GROUP BY 
    old_apart.affair_id, 
    old_apart.house_address,
    old_apart.apart_number,
    old_apart.district,
    old_apart.municipal_district,
    old_apart.fio,
    old_apart.full_living_area,
    old_apart.total_living_area,
    old_apart.living_area,
    old_apart.room_count,
    old_apart.type_of_settlement,
    old_apart.is_queue;

2025-03-19 19:55:05,011 - INFO - Executing query: WITH unnested_offer AS (
    SELECT 
        offer_id,
        affair_id,
        (KEY)::integer AS new_apart_id,
        (VALUE->'status_id')::integer AS status_id,
        sentence_date, 
        answer_date, 
        created_at, 
        updated_at,
        declined_reason_id
    FROM offer, 
    jsonb_each(new_aparts)
),
joined_aparts AS (
    SELECT 
        o.offer_id,
        o.affair_id,
        JSON_OBJECT_AGG(
            o.new_apart_id::text,
            JSON_BUILD_OBJECT(
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', s.status,
                'sentence_date', o.sentence_date::DATE,
                'answer_date', o.answer_date::DATE,
                'decline_reason_notes', dr.notes
            )::jsonb
        )::jsonb AS new_apartments
    FROM 
        unnested_offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    LEFT JOIN 
        decline_reason dr ON o.declined_reason_id = dr.declined_reason_id
    WHERE 
        o.new_apart_id IS NOT NULL  
    GROUP BY 
        o.offer_id,
        o.affair_id
)
SELECT 
    old_apart.affair_id, 
    old_apart.house_address,
    old_apart.apart_number,
    old_apart.district,
    old_apart.municipal_district,
    old_apart.fio,
    old_apart.full_living_area,
    old_apart.total_living_area,
    old_apart.living_area,
    old_apart.room_count,
    old_apart.type_of_settlement,
    old_apart.is_queue,
    JSON_OBJECT_AGG(
        joined_aparts.offer_id::text,
        joined_aparts.new_apartments
        ORDER BY joined_aparts.offer_id
    ) FILTER (WHERE joined_aparts.offer_id IS NOT NULL)::jsonb AS offers
FROM 
    old_apart  
LEFT JOIN 
    joined_aparts ON old_apart.affair_id = joined_aparts.affair_id
WHERE old_apart.affair_id = :apart_id
GROUP BY 
    old_apart.affair_id, 
    old_apart.house_address,
    old_apart.apart_number,
    old_apart.district,
    old_apart.municipal_district,
    old_apart.fio,
    old_apart.full_living_area,
    old_apart.total_living_area,
    old_apart.living_area,
    old_apart.room_count,
    old_apart.type_of_settlement,
    old_apart.is_queue;

2025-03-19 20:16:09,195 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 20:16:28,352 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.Error) <class 'asyncpg.exceptions.ConnectionDoesNotExistError'>: connection was closed in the middle of operation
[SQL: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        ]
(Background on this error at: https://sqlalche.me/e/20/dbapi)
2025-03-19 20:16:32,860 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 20:16:49,194 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 20:17:12,226 - INFO - Executing query: WITH ranked_apartments AS (
    SELECT
        offer_id,
        house_address,
        apart_number,
        district,
        municipal_district,
        floor,
        fio,
        full_living_area,
        total_living_area,
        living_area,
        room_count,
        type_of_settlement,
        status.status,
        oa.notes,
        affair_id,
        is_queue,
        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC, o.created_at DESC) AS rn,
        COUNT(o.affair_id) OVER (PARTITION BY oa.affair_id) AS selection_count
    FROM
        old_apart oa
    LEFT JOIN
        offer o USING (affair_id)
    LEFT JOIN
        status ON o.status_id = status.status_id
)
SELECT *
FROM ranked_apartments WHERE rn = 1
2025-03-19 20:17:12,226 - INFO - Params: {}
2025-03-19 20:17:12,526 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 20:17:59,421 - INFO - Executing query: WITH clr_dt AS (
    SELECT 
        offer_id,
        affair_id, 
        (KEY)::int AS new_apart_id, 
        sentence_date, 
        answer_date, 
		created_at,
		updated_at,
        (VALUE->'status_id')::int AS status_id 
    FROM 
        offer, 
        jsonb_each(new_aparts)
),
ranked_apartments AS (
    SELECT 
        o.offer_id,
        na.house_address, 
        na.apart_number, 
        na.district, 
        na.municipal_district,
        na.floor,
        na.full_living_area,
        na.total_living_area, 
        na.living_area, 
        na.room_count, 
        na.type_of_settlement, 
        na.notes, 
        na.new_apart_id,
        s.status AS status,
        is_private,
        ROW_NUMBER() OVER (
            PARTITION BY na.new_apart_id 
            ORDER BY o.sentence_date DESC, o.answer_date DESC, o.created_at DESC
        ) AS rn,
        COUNT(o.affair_id) OVER (PARTITION BY na.new_apart_id) AS selection_count, 
        na.notes
    FROM 
        new_apart na
    LEFT JOIN 
        clr_dt as o on o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
)
SELECT *
FROM ranked_apartments
 WHERE rn = 1
2025-03-19 20:17:59,421 - INFO - Params: {}
2025-03-19 20:17:59,421 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-03-19 20:18:04,384 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 20:18:04,385 - INFO - Executing query: WITH ranked_apartments AS (
    SELECT
        offer_id,
        house_address,
        apart_number,
        district,
        municipal_district,
        floor,
        fio,
        full_living_area,
        total_living_area,
        living_area,
        room_count,
        type_of_settlement,
        status.status,
        oa.notes,
        affair_id,
        is_queue,
        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC, o.created_at DESC) AS rn,
        COUNT(o.affair_id) OVER (PARTITION BY oa.affair_id) AS selection_count
    FROM
        old_apart oa
    LEFT JOIN
        offer o USING (affair_id)
    LEFT JOIN
        status ON o.status_id = status.status_id
)
SELECT *
FROM ranked_apartments WHERE rn = 1
2025-03-19 20:18:04,386 - INFO - Params: {}
2025-03-19 20:19:36,773 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 20:19:36,773 - INFO - Executing query: WITH ranked_apartments AS (
    SELECT
        offer_id,
        house_address,
        apart_number,
        district,
        municipal_district,
        floor,
        fio,
        full_living_area,
        total_living_area,
        living_area,
        room_count,
        type_of_settlement,
        status.status,
        oa.notes,
        affair_id,
        is_queue,
        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC, o.created_at DESC) AS rn,
        COUNT(o.affair_id) OVER (PARTITION BY oa.affair_id) AS selection_count
    FROM
        old_apart oa
    LEFT JOIN
        offer o USING (affair_id)
    LEFT JOIN
        status ON o.status_id = status.status_id
)
SELECT *
FROM ranked_apartments WHERE rn = 1
2025-03-19 20:19:36,773 - INFO - Params: {}
2025-03-19 20:19:48,375 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-03-19 20:19:48,375 - INFO - Params: {'district_0': '¬¿Œ'}
2025-03-19 20:19:48,852 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_0)
            ORDER BY house_address
        
2025-03-19 20:19:48,852 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-03-19 20:19:48,922 - INFO - Executing query: WITH ranked_apartments AS (
    SELECT
        offer_id,
        house_address,
        apart_number,
        district,
        municipal_district,
        floor,
        fio,
        full_living_area,
        total_living_area,
        living_area,
        room_count,
        type_of_settlement,
        status.status,
        oa.notes,
        affair_id,
        is_queue,
        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC, o.created_at DESC) AS rn,
        COUNT(o.affair_id) OVER (PARTITION BY oa.affair_id) AS selection_count
    FROM
        old_apart oa
    LEFT JOIN
        offer o USING (affair_id)
    LEFT JOIN
        status ON o.status_id = status.status_id
)
SELECT *
FROM ranked_apartments WHERE rn = 1 AND municipal_district IN (:municipal_0)
2025-03-19 20:19:48,922 - INFO - Params: {'municipal_0': '¡Ó„ÓÓ‰ÒÍÓÂ'}
2025-03-19 20:21:32,970 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 20:21:32,971 - INFO - Executing query: WITH ranked_apartments AS (
    SELECT
        offer_id,
        house_address,
        apart_number,
        district,
        municipal_district,
        floor,
        fio,
        full_living_area,
        total_living_area,
        living_area,
        room_count,
        type_of_settlement,
        status.status,
        oa.notes,
        affair_id,
        is_queue,
        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC, o.created_at DESC) AS rn,
        COUNT(o.affair_id) OVER (PARTITION BY oa.affair_id) AS selection_count
    FROM
        old_apart oa
    LEFT JOIN
        offer o USING (affair_id)
    LEFT JOIN
        status ON o.status_id = status.status_id
)
SELECT *
FROM ranked_apartments WHERE rn = 1
2025-03-19 20:21:32,971 - INFO - Params: {}
2025-03-19 20:21:34,299 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 20:21:34,304 - INFO - Executing query: WITH ranked_apartments AS (
    SELECT
        offer_id,
        house_address,
        apart_number,
        district,
        municipal_district,
        floor,
        fio,
        full_living_area,
        total_living_area,
        living_area,
        room_count,
        type_of_settlement,
        status.status,
        oa.notes,
        affair_id,
        is_queue,
        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC, o.created_at DESC) AS rn,
        COUNT(o.affair_id) OVER (PARTITION BY oa.affair_id) AS selection_count
    FROM
        old_apart oa
    LEFT JOIN
        offer o USING (affair_id)
    LEFT JOIN
        status ON o.status_id = status.status_id
)
SELECT *
FROM ranked_apartments WHERE rn = 1
2025-03-19 20:21:34,304 - INFO - Params: {}
2025-03-19 20:23:03,660 - INFO - Executing query: WITH ranked_apartments AS (
    SELECT
        offer_id,
        house_address,
        apart_number,
        district,
        municipal_district,
        floor,
        fio,
        full_living_area,
        total_living_area,
        living_area,
        room_count,
        type_of_settlement,
        status.status,
        oa.notes,
        affair_id,
        is_queue,
        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC, o.created_at DESC) AS rn,
        COUNT(o.affair_id) OVER (PARTITION BY oa.affair_id) AS selection_count
    FROM
        old_apart oa
    LEFT JOIN
        offer o USING (affair_id)
    LEFT JOIN
        status ON o.status_id = status.status_id
)
SELECT *
FROM ranked_apartments WHERE rn = 1
2025-03-19 20:23:03,660 - INFO - Params: {}
2025-03-19 20:23:03,661 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 20:31:51,371 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 20:31:51,371 - INFO - Executing query: WITH ranked_apartments AS (
    SELECT
        offer_id,
        house_address,
        apart_number,
        district,
        municipal_district,
        floor,
        fio,
        full_living_area,
        total_living_area,
        living_area,
        room_count,
        type_of_settlement,
        status.status,
        oa.notes,
        affair_id,
        is_queue,
        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC, o.created_at DESC) AS rn,
        COUNT(o.affair_id) OVER (PARTITION BY oa.affair_id) AS selection_count
    FROM
        old_apart oa
    LEFT JOIN
        offer o USING (affair_id)
    LEFT JOIN
        status ON o.status_id = status.status_id
)
SELECT *
FROM ranked_apartments WHERE rn = 1
2025-03-19 20:31:51,371 - INFO - Params: {}
2025-03-19 20:35:27,214 - INFO - Executing query: WITH ranked_apartments AS (
    SELECT
        offer_id,
        house_address,
        apart_number,
        district,
        municipal_district,
        floor,
        fio,
        full_living_area,
        total_living_area,
        living_area,
        room_count,
        type_of_settlement,
        status.status,
        oa.notes,
        affair_id,
        is_queue,
        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC, o.created_at DESC) AS rn,
        COUNT(o.affair_id) OVER (PARTITION BY oa.affair_id) AS selection_count
    FROM
        old_apart oa
    LEFT JOIN
        offer o USING (affair_id)
    LEFT JOIN
        status ON o.status_id = status.status_id
)
SELECT *
FROM ranked_apartments WHERE rn = 1
2025-03-19 20:35:27,214 - INFO - Params: {}
2025-03-19 20:35:27,215 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 20:39:09,790 - INFO - Executing query: WITH ranked_apartments AS (
    SELECT
        offer_id,
        house_address,
        apart_number,
        district,
        municipal_district,
        floor,
        fio,
        full_living_area,
        total_living_area,
        living_area,
        room_count,
        type_of_settlement,
        status.status,
        oa.notes,
        affair_id,
        is_queue,
        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC, o.created_at DESC) AS rn,
        COUNT(o.affair_id) OVER (PARTITION BY oa.affair_id) AS selection_count
    FROM
        old_apart oa
    LEFT JOIN
        offer o USING (affair_id)
    LEFT JOIN
        status ON o.status_id = status.status_id
)
SELECT *
FROM ranked_apartments WHERE rn = 1
2025-03-19 20:39:09,790 - INFO - Params: {}
2025-03-19 20:39:09,791 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
