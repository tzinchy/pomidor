2025-02-17 11:42:00,291 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 11:42:00,291 - INFO - Params: {'house_address_0': 'Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð°Ñ ÑƒÐ»., Ð´.21 ÐºÐ¾Ñ€.1', 'municipal_0': 'ÐÐ»Ñ‚ÑƒÑ„ÑŒÐµÐ²ÑÐºÐ¸Ð¹'}
2025-02-17 11:42:00,967 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 11:42:00,967 - INFO - Params: {'house_address_0': 'ÐÐ»Ñ‚ÑƒÑ„ÑŒÐµÐ²ÑÐºÐ¾Ðµ ÑˆÐ¾ÑÑÐµ, Ð´. 53, ÐºÐ¾Ñ€Ð¿. 2', 'municipal_0': 'ÐÐ»Ñ‚ÑƒÑ„ÑŒÐµÐ²ÑÐºÐ¸Ð¹'}
2025-02-17 11:42:01,885 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 53740
                    
2025-02-17 11:42:01,885 - INFO - Params: {'apart_id': 53740}
2025-02-17 11:42:03,145 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-17 11:42:03,145 - INFO - Params: {'district_0': 'ÐÐ¾Ð²Ð¾Ð¼Ð¾ÑÐºÐ¾Ð²ÑÐºÐ¸Ð¹ ÐÐž'}
2025-02-17 11:42:03,885 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-17 11:42:03,885 - INFO - Params: {'municipal_districts_0': 'Ð’Ð½ÑƒÐºÐ¾Ð²ÑÐºÐ¾Ðµ ÑÐµÐ»ÑŒÑÐºÐ¾Ðµ Ð¿Ð¾ÑÐµÐ»ÐµÐ½Ð¸Ðµ'}
2025-02-17 11:42:03,887 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 11:42:03,887 - INFO - Params: {'municipal_0': 'Ð’Ð½ÑƒÐºÐ¾Ð²ÑÐºÐ¾Ðµ ÑÐµÐ»ÑŒÑÐºÐ¾Ðµ Ð¿Ð¾ÑÐµÐ»ÐµÐ½Ð¸Ðµ'}
2025-02-17 11:42:04,347 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-17 11:42:04,347 - INFO - Params: {'house_address_0': 'ÐÐ½Ð½Ñ‹ ÐÑ…Ð¼Ð°Ñ‚Ð¾Ð²Ð¾Ð¹ ÑƒÐ». (Ð¿.Ð’Ð½ÑƒÐºÐ¾Ð²ÑÐºÐ¾Ðµ), Ð´.10', 'municipal_0': 'Ð’Ð½ÑƒÐºÐ¾Ð²ÑÐºÐ¾Ðµ ÑÐµÐ»ÑŒÑÐºÐ¾Ðµ Ð¿Ð¾ÑÐµÐ»ÐµÐ½Ð¸Ðµ'}
2025-02-17 11:42:04,775 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 8006871
                    
2025-02-17 11:42:04,775 - INFO - Params: {'apart_id': 8006871}
2025-02-17 12:01:37,588 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-17 12:01:37,588 - INFO - Params: {}
2025-02-18 12:51:58,598 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-18 12:51:58,603 - INFO - Params: {}
2025-02-18 12:52:19,118 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-18 12:52:19,118 - INFO - Params: {}
2025-02-18 12:52:19,892 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-18 12:52:19,892 - INFO - Params: {}
2025-02-18 12:52:42,594 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM new_apart
            ORDER BY district
        
2025-02-18 12:52:42,594 - INFO - Params: {}
2025-02-18 12:52:42,987 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-18 12:52:42,987 - INFO - Params: {'district_0': 'Âîñòî÷íûé ÀÎ'}
2025-02-18 12:52:46,510 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM new_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-18 12:52:46,510 - INFO - Params: {'district_0': 'ÑÂÀÎ'}
2025-02-18 12:52:46,918 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM new_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-18 12:52:46,918 - INFO - Params: {'municipal_districts_0': 'Àëòóôüåâñêèé'}
2025-02-18 12:52:46,925 - INFO - Executing query: 
				WITH clr_dt AS (SELECT 
                        affair_id, 
                        (KEY)::int AS new_apart_id, 
                        sentence_date, 
                        answer_date, 
                        (VALUE->'status_id')::int AS status_id 
                    FROM 
                        offer, 
                        jsonb_each(new_aparts)),
		 ranked_apartments AS (
                SELECT 
                    na.house_address, 
                    na.apart_number, 
                    na.district, 
                    na.municipal_district,
                    na.floor,
                    na.full_living_area,
                    na.total_living_area, 
                    na.living_area, 
                    na.room_count, 
                    na.type_of_settlement, 
                    na.notes, 
                    na.new_apart_id,
                    s.status AS status,
                    ROW_NUMBER() OVER (
                        PARTITION BY na.new_apart_id 
                        ORDER BY o.sentence_date DESC, o.answer_date DESC 
                    ) AS rn
                FROM 
                    new_apart na
                LEFT JOIN 
					clr_dt as o on o.new_apart_id = na.new_apart_id
                LEFT JOIN 
                    status s ON o.status_id = s.status_id
            )
            SELECT *
            FROM ranked_apartments
            WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
            ORDER BY status;
            
2025-02-18 12:52:46,925 - INFO - Params: {'municipal_0': 'Àëòóôüåâñêèé'}
2025-02-18 12:52:49,525 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 53738
                    
2025-02-18 12:52:49,525 - INFO - Params: {'apart_id': 53738}
2025-02-18 12:52:54,133 - INFO - Executing query: WITH unnset_offer AS (
                SELECT 
                    affair_id,
                    (KEY)::integer as new_apart_id,
                    (VALUE->'status_id')::integer AS status_id,
                    sentence_date, 
                    answer_date
                    FROM offer, 
                    jsonb_each(new_aparts)
            ),
                joined_aparts AS (
                    SELECT 
                    o.new_apart_id,
                    JSON_AGG(
                        JSON_BUILD_OBJECT(
                            'house_address', old_apart.house_address,
                            'apart_number', old_apart.apart_number,
                            'district', old_apart.district,
                            'municipal_district', old_apart.municipal_district,
                            'full_living_area', old_apart.full_living_area,
                            'total_living_area', old_apart.total_living_area,
                            'living_area', old_apart.living_area,
                            'room_count', old_apart.room_count,
                            'type_of_settlement', old_apart.type_of_settlement,
                            'notes', old_apart.notes,
                            'status', s.status,
                            'sentence_date', o.sentence_date :: DATE,
                            'answer_date', o.answer_date :: DATE
                        ) ORDER BY sentence_date DESC, answer_date DESC
                        ) AS old_apartments
                                FROM 
                                    unnset_offer o
                                LEFT JOIN 
                                    old_apart ON old_apart.affair_id = o.affair_id
                                LEFT JOIN 
                                    status s ON o.status_id = s.status_id
                                GROUP BY 
                                    o.new_apart_id
                )
            SELECT new_apart.new_apart_id, 
                    new_apart.house_address,
                    new_apart.apart_number,
                    new_apart.district,
                    new_apart.municipal_district,
                    new_apart.full_living_area,
                    new_apart.total_living_area,
                    new_apart.living_area,
                    new_apart.room_count,
                    new_apart.type_of_settlement,
                    joined_aparts.old_apartments
                    from new_apart  
                    left join 
                    joined_aparts using (new_apart_id) 
					where new_apart_id = 53806
                    
2025-02-18 12:52:54,133 - INFO - Params: {'apart_id': 53806}
2025-02-18 12:52:57,250 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        affair_id,
        offer.status_id,
        ROW_NUMBER() OVER (
            PARTITION BY old_apart.affair_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM old_apart
    JOIN offer USING (affair_id)
),
clear_data AS (
    SELECT affair_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM old_apart 
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.affair_id = old_apart.affair_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-18 12:52:57,250 - INFO - Params: None
2025-02-18 12:52:57,292 - INFO - Executing query: WITH unnst AS (
	SELECT 
	(key)::integer as new_apart_id, 
	(value->'status_id')::integer as status_id,
	sentence_date, 
	answer_date
	FROM offer, jsonb_each(new_aparts)
),
needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM unnst as offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-18 12:52:57,292 - INFO - Params: None
2025-02-18 12:59:30,279 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        affair_id,
        offer.status_id,
        ROW_NUMBER() OVER (
            PARTITION BY old_apart.affair_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM old_apart
    JOIN offer USING (affair_id)
),
clear_data AS (
    SELECT affair_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM old_apart 
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.affair_id = old_apart.affair_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-18 12:59:30,279 - INFO - Params: None
2025-02-18 12:59:30,280 - INFO - Executing query: WITH unnst AS (
	SELECT 
	(key)::integer as new_apart_id, 
	(value->'status_id')::integer as status_id,
	sentence_date, 
	answer_date
	FROM offer, jsonb_each(new_aparts)
),
needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM unnst as offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-18 12:59:30,280 - INFO - Params: None
2025-02-18 12:59:31,455 - INFO - Executing query: WITH needs_with_row AS (
    SELECT 
        affair_id,
        offer.status_id,
        ROW_NUMBER() OVER (
            PARTITION BY old_apart.affair_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM old_apart
    JOIN offer USING (affair_id)
),
clear_data AS (
    SELECT affair_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(room_count) AS count
    FROM old_apart 
    WHERE NOT EXISTS (
        SELECT 1
        FROM clear_data
        WHERE clear_data.affair_id = old_apart.affair_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-18 12:59:31,456 - INFO - Params: None
2025-02-18 12:59:31,457 - INFO - Executing query: WITH unnst AS (
	SELECT 
	(key)::integer as new_apart_id, 
	(value->'status_id')::integer as status_id,
	sentence_date, 
	answer_date
	FROM offer, jsonb_each(new_aparts)
),
needs_with_row AS (
    SELECT 
        new_apart_id,
        status_id,
        ROW_NUMBER() OVER (
            PARTITION BY new_apart_id 
            ORDER BY offer.sentence_date DESC, offer.answer_date DESC
        ) AS rn
    FROM unnst as offer
),
clear_data AS (
    SELECT new_apart_id 
    FROM needs_with_row 
    WHERE rn = 1 AND status_id != 2
)
SELECT 
    house_address, 
    jsonb_object_agg(room_count, count) AS rooms
FROM (
    SELECT 
        house_address, 
        room_count, 
        COUNT(*) AS count
    FROM new_apart 
    WHERE NOT EXISTS (
        SELECT 1 
        FROM clear_data 
        WHERE clear_data.new_apart_id = new_apart.new_apart_id
    )
    GROUP BY house_address, room_count
    ORDER BY room_count
) AS subquery
GROUP BY house_address
ORDER BY house_address;
2025-02-18 12:59:31,457 - INFO - Params: None
2025-02-18 12:59:45,458 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-18 12:59:45,458 - INFO - Params: {}
2025-02-18 14:38:42,410 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-18 14:38:42,410 - INFO - Params: {}
2025-02-18 14:38:43,785 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-18 14:38:43,785 - INFO - Params: {'district_0': 'Âîñòî÷íûé ÀÎ'}
2025-02-18 14:38:44,115 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-18 14:38:44,115 - INFO - Params: {'municipal_districts_0': 'Áîãîðîäñêîå'}
2025-02-18 14:38:44,119 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-18 14:38:44,119 - INFO - Params: {'municipal_0': 'Áîãîðîäñêîå'}
2025-02-18 14:39:10,610 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-18 14:39:10,610 - INFO - Params: {}
2025-02-18 14:39:26,239 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-02-18 14:39:26,239 - INFO - Params: {'district_0': 'Âîñòî÷íûé ÀÎ'}
2025-02-18 14:39:26,597 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-02-18 14:39:26,597 - INFO - Params: {'municipal_districts_0': 'Áîãîðîäñêîå'}
2025-02-18 14:39:26,674 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-18 14:39:26,675 - INFO - Params: {'municipal_0': 'Áîãîðîäñêîå'}
2025-02-18 14:39:27,215 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and house_address IN (:house_address_0) AND municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-02-18 14:39:27,215 - INFO - Params: {'house_address_0': 'Êóçíåöîâñêàÿ óë., ä.7', 'municipal_0': 'Áîãîðîäñêîå'}
2025-02-18 14:41:29,882 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-02-18 14:41:29,882 - INFO - Params: {}
2025-03-19 19:34:13,585 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 19:34:13,587 - INFO - Params: {}
2025-03-19 19:34:25,338 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 19:34:25,338 - INFO - Params: {}
2025-03-19 19:34:34,638 - ERROR - Error executing query: [Errno 10060] Connect call failed ('10.9.96.160', 5432)
2025-03-19 19:34:46,389 - ERROR - Error executing query: [Errno 10060] Connect call failed ('10.9.96.160', 5432)
2025-03-19 19:35:21,918 - INFO - Executing query: 
            SELECT DISTINCT district 
            FROM old_apart
            ORDER BY district
        
2025-03-19 19:35:21,918 - INFO - Params: {}
2025-03-19 19:35:42,292 - INFO - Executing query: 
            SELECT DISTINCT municipal_district
            FROM old_apart
            WHERE district IN (:district_0)
            ORDER BY municipal_district
        
2025-03-19 19:35:42,292 - INFO - Params: {'district_0': 'ÂÀÎ'}
2025-03-19 19:35:42,591 - INFO - Executing query: 
            SELECT DISTINCT house_address
            FROM old_apart
            WHERE municipal_district IN (:municipal_districts_0)
            ORDER BY house_address
        
2025-03-19 19:35:42,591 - INFO - Params: {'municipal_districts_0': 'Áîãîðîäñêîå'}
2025-03-19 19:35:42,658 - INFO - Executing query: 
                WITH ranked_apartments AS (
                    SELECT
                        house_address,
                        apart_number,
                        district,
                        municipal_district,
                        floor,
                        fio,
                        full_living_area,
                        total_living_area,
                        living_area,
                        room_count,
                        type_of_settlement,
                        status.status,
                        o.notes,
                        affair_id,
                        ROW_NUMBER() OVER (PARTITION BY oa.affair_id ORDER BY o.sentence_date DESC, o.answer_date DESC) AS rn
                    FROM
                        old_apart oa
                    LEFT JOIN
                        offer o USING (affair_id)
                    LEFT JOIN
                        status ON o.status_id = status.status_id
                )
                SELECT *
                FROM ranked_apartments
                WHERE 1=1 and municipal_district IN (:municipal_0) AND rn = 1
                ORDER BY full_living_area
            
2025-03-19 19:35:42,658 - INFO - Params: {'municipal_0': 'Áîãîðîäñêîå'}
2025-03-20 11:10:40,326 - INFO - Executing query: WITH unnested_offer AS (
    SELECT 
        offer_id,
        affair_id,
        (KEY)::integer AS new_apart_id,
        (VALUE->'status_id')::integer AS status_id,
        sentence_date, 
        answer_date, 
        created_at, 
        updated_at,
        (VALUE->'decline_reason_id')::integer AS decline_reason_id
    FROM offer, 
    jsonb_each(new_aparts)
),
joined_aparts AS (
    SELECT 
        o.offer_id,
        o.affair_id,
        JSON_OBJECT_AGG(
            o.new_apart_id::text,
            JSON_BUILD_OBJECT(
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', s.status,
                'sentence_date', o.sentence_date::DATE,
                'answer_date', o.answer_date::DATE,
                'decline_reason_id', jsonb_build_object('min_floor', dr.min_floor, 'max_floor', dr.max_floor, 'unom', dr.unom, 'entrance', dr.entrance, 'apartment_layout', dr.apartment_layout, 'notes', dr.notes)
            )::jsonb
        )::jsonb AS new_apartments
    FROM 
        unnested_offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    LEFT JOIN 
        decline_reason dr ON o.declined_reason_id = dr.declined_reason_id
    WHERE 
        o.new_apart_id IS NOT NULL  
    GROUP BY 
        o.offer_id,
        o.affair_id
)
SELECT 
    old_apart.affair_id, 
    old_apart.house_address,
    old_apart.apart_number,
    old_apart.district,
    old_apart.municipal_district,
    old_apart.fio,
    old_apart.full_living_area,
    old_apart.total_living_area,
    old_apart.living_area,
    old_apart.room_count,
    old_apart.type_of_settlement,
    old_apart.is_queue,
    JSON_OBJECT_AGG(
        joined_aparts.offer_id::text,
        joined_aparts.new_apartments
        ORDER BY joined_aparts.offer_id
    ) FILTER (WHERE joined_aparts.offer_id IS NOT NULL)::jsonb AS offers
FROM 
    old_apart  
LEFT JOIN 
    joined_aparts ON old_apart.affair_id = joined_aparts.affair_id
WHERE old_apart.affair_id = :apart_id
GROUP BY 
    old_apart.affair_id, 
    old_apart.house_address,
    old_apart.apart_number,
    old_apart.district,
    old_apart.municipal_district,
    old_apart.fio,
    old_apart.full_living_area,
    old_apart.total_living_area,
    old_apart.living_area,
    old_apart.room_count,
    old_apart.type_of_settlement,
    old_apart.is_queue;

2025-03-20 11:10:41,083 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: ÑÑ‚Ð¾Ð»Ð±ÐµÑ† o.declined_reason_id Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
HINT:  Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ð»Ð°Ð³Ð°Ð»Ð°ÑÑŒ ÑÑÑ‹Ð»ÐºÐ° Ð½Ð° ÑÑ‚Ð¾Ð»Ð±ÐµÑ† "o.decline_reason_id".
[SQL: WITH unnested_offer AS (
    SELECT 
        offer_id,
        affair_id,
        (KEY)::integer AS new_apart_id,
        (VALUE->'status_id')::integer AS status_id,
        sentence_date, 
        answer_date, 
        created_at, 
        updated_at,
        (VALUE->'decline_reason_id')::integer AS decline_reason_id
    FROM offer, 
    jsonb_each(new_aparts)
),
joined_aparts AS (
    SELECT 
        o.offer_id,
        o.affair_id,
        JSON_OBJECT_AGG(
            o.new_apart_id::text,
            JSON_BUILD_OBJECT(
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', s.status,
                'sentence_date', o.sentence_date::DATE,
                'answer_date', o.answer_date::DATE,
                'decline_reason_id', jsonb_build_object('min_floor', dr.min_floor, 'max_floor', dr.max_floor, 'unom', dr.unom, 'entrance', dr.entrance, 'apartment_layout', dr.apartment_layout, 'notes', dr.notes)
            )::jsonb
        )::jsonb AS new_apartments
    FROM 
        unnested_offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    LEFT JOIN 
        decline_reason dr ON o.declined_reason_id = dr.declined_reason_id
    WHERE 
        o.new_apart_id IS NOT NULL  
    GROUP BY 
        o.offer_id,
        o.affair_id
)
SELECT 
    old_apart.affair_id, 
    old_apart.house_address,
    old_apart.apart_number,
    old_apart.district,
    old_apart.municipal_district,
    old_apart.fio,
    old_apart.full_living_area,
    old_apart.total_living_area,
    old_apart.living_area,
    old_apart.room_count,
    old_apart.type_of_settlement,
    old_apart.is_queue,
    JSON_OBJECT_AGG(
        joined_aparts.offer_id::text,
        joined_aparts.new_apartments
        ORDER BY joined_aparts.offer_id
    ) FILTER (WHERE joined_aparts.offer_id IS NOT NULL)::jsonb AS offers
FROM 
    old_apart  
LEFT JOIN 
    joined_aparts ON old_apart.affair_id = joined_aparts.affair_id
WHERE old_apart.affair_id = $1
GROUP BY 
    old_apart.affair_id, 
    old_apart.house_address,
    old_apart.apart_number,
    old_apart.district,
    old_apart.municipal_district,
    old_apart.fio,
    old_apart.full_living_area,
    old_apart.total_living_area,
    old_apart.living_area,
    old_apart.room_count,
    old_apart.type_of_settlement,
    old_apart.is_queue;
]
[parameters: (727312,)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-03-20 11:12:41,730 - INFO - Executing query: WITH unnested_offer AS (
    SELECT 
        offer_id,
        affair_id,
        (KEY)::integer AS new_apart_id,
        (VALUE->'status_id')::integer AS status_id,
        sentence_date, 
        answer_date, 
        created_at, 
        updated_at,
        (key->'decline_reason_id')::integer AS decline_reason_id
    FROM offer, 
    jsonb_each(new_aparts)
),
joined_aparts AS (
    SELECT 
        o.offer_id,
        o.affair_id,
        JSON_OBJECT_AGG(
            o.new_apart_id::text,
            JSON_BUILD_OBJECT(
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', s.status,
                'sentence_date', o.sentence_date::DATE,
                'answer_date', o.answer_date::DATE,
                'decline_reason_id', jsonb_build_object('min_floor', dr.min_floor, 'max_floor', dr.max_floor, 'unom', dr.unom, 'entrance', dr.entrance, 'apartment_layout', dr.apartment_layout, 'notes', dr.notes)
            )::jsonb
        )::jsonb AS new_apartments
    FROM 
        unnested_offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    LEFT JOIN 
        decline_reason dr ON o.declined_reason_id = dr.declined_reason_id
    WHERE 
        o.new_apart_id IS NOT NULL  
    GROUP BY 
        o.offer_id,
        o.affair_id
)
SELECT 
    old_apart.affair_id, 
    old_apart.house_address,
    old_apart.apart_number,
    old_apart.district,
    old_apart.municipal_district,
    old_apart.fio,
    old_apart.full_living_area,
    old_apart.total_living_area,
    old_apart.living_area,
    old_apart.room_count,
    old_apart.type_of_settlement,
    old_apart.is_queue,
    JSON_OBJECT_AGG(
        joined_aparts.offer_id::text,
        joined_aparts.new_apartments
        ORDER BY joined_aparts.offer_id
    ) FILTER (WHERE joined_aparts.offer_id IS NOT NULL)::jsonb AS offers
FROM 
    old_apart  
LEFT JOIN 
    joined_aparts ON old_apart.affair_id = joined_aparts.affair_id
WHERE old_apart.affair_id = :apart_id
GROUP BY 
    old_apart.affair_id, 
    old_apart.house_address,
    old_apart.apart_number,
    old_apart.district,
    old_apart.municipal_district,
    old_apart.fio,
    old_apart.full_living_area,
    old_apart.total_living_area,
    old_apart.living_area,
    old_apart.room_count,
    old_apart.type_of_settlement,
    old_apart.is_queue;

2025-03-20 11:12:42,058 - ERROR - Error executing query: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚: text -> unknown
HINT:  ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ Ñ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¸Ð¼ÐµÐ½ÐµÐ¼ Ð¸ Ñ‚Ð¸Ð¿Ð°Ð¼Ð¸ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, Ð²Ð°Ð¼ ÑÐ»ÐµÐ´ÑƒÐµÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ²Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ð²ÐµÐ´ÐµÐ½Ð¸Ñ Ñ‚Ð¸Ð¿Ð¾Ð².
[SQL: WITH unnested_offer AS (
    SELECT 
        offer_id,
        affair_id,
        (KEY)::integer AS new_apart_id,
        (VALUE->'status_id')::integer AS status_id,
        sentence_date, 
        answer_date, 
        created_at, 
        updated_at,
        (key->'decline_reason_id')::integer AS decline_reason_id
    FROM offer, 
    jsonb_each(new_aparts)
),
joined_aparts AS (
    SELECT 
        o.offer_id,
        o.affair_id,
        JSON_OBJECT_AGG(
            o.new_apart_id::text,
            JSON_BUILD_OBJECT(
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', s.status,
                'sentence_date', o.sentence_date::DATE,
                'answer_date', o.answer_date::DATE,
                'decline_reason_id', jsonb_build_object('min_floor', dr.min_floor, 'max_floor', dr.max_floor, 'unom', dr.unom, 'entrance', dr.entrance, 'apartment_layout', dr.apartment_layout, 'notes', dr.notes)
            )::jsonb
        )::jsonb AS new_apartments
    FROM 
        unnested_offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    LEFT JOIN 
        decline_reason dr ON o.declined_reason_id = dr.declined_reason_id
    WHERE 
        o.new_apart_id IS NOT NULL  
    GROUP BY 
        o.offer_id,
        o.affair_id
)
SELECT 
    old_apart.affair_id, 
    old_apart.house_address,
    old_apart.apart_number,
    old_apart.district,
    old_apart.municipal_district,
    old_apart.fio,
    old_apart.full_living_area,
    old_apart.total_living_area,
    old_apart.living_area,
    old_apart.room_count,
    old_apart.type_of_settlement,
    old_apart.is_queue,
    JSON_OBJECT_AGG(
        joined_aparts.offer_id::text,
        joined_aparts.new_apartments
        ORDER BY joined_aparts.offer_id
    ) FILTER (WHERE joined_aparts.offer_id IS NOT NULL)::jsonb AS offers
FROM 
    old_apart  
LEFT JOIN 
    joined_aparts ON old_apart.affair_id = joined_aparts.affair_id
WHERE old_apart.affair_id = $1
GROUP BY 
    old_apart.affair_id, 
    old_apart.house_address,
    old_apart.apart_number,
    old_apart.district,
    old_apart.municipal_district,
    old_apart.fio,
    old_apart.full_living_area,
    old_apart.total_living_area,
    old_apart.living_area,
    old_apart.room_count,
    old_apart.type_of_settlement,
    old_apart.is_queue;
]
[parameters: (727312,)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-03-20 12:36:55,398 - INFO - Executing query: WITH unnested_offer AS (
    SELECT 
        offer_id,
        affair_id,
        (key)::integer AS new_apart_id,
        (value->'status_id')::integer AS status_id,
        sentence_date, 
        answer_date, 
        created_at, 
        updated_at,
        (value->>'decline_reason_id')::integer AS decline_reason_id  -- Fixed: Extract from value
    FROM offer, 
    jsonb_each(new_aparts) AS each(key, value)
),
joined_aparts AS (
    SELECT 
        o.offer_id,
        o.affair_id,
        JSONB_OBJECT_AGG(  -- Use JSONB_OBJECT_AGG for efficiency
            o.new_apart_id::text,
            JSONB_BUILD_OBJECT(  -- Use JSONB_BUILD_OBJECT to avoid casting
                'house_address', na.house_address,
                'apart_number', na.apart_number,
                'district', na.district,
                'municipal_district', na.municipal_district,
                'full_living_area', na.full_living_area,
                'total_living_area', na.total_living_area,
                'living_area', na.living_area,
                'room_count', na.room_count,
                'type_of_settlement', na.type_of_settlement,
                'notes', na.notes,
                'status', s.status,
                'sentence_date', o.sentence_date::DATE,
                'answer_date', o.answer_date::DATE,
                'decline_reason_id', JSONB_BUILD_OBJECT(
                    'min_floor', dr.min_floor, 
                    'max_floor', dr.max_floor, 
                    'unom', dr.unom, 
                    'entrance', dr.entrance, 
                    'apartment_layout', dr.apartment_layout, 
                    'notes', dr.notes
                )
            )
        ) AS new_apartments
    FROM 
        unnested_offer o
    LEFT JOIN 
        new_apart na ON o.new_apart_id = na.new_apart_id
    LEFT JOIN 
        status s ON o.status_id = s.status_id
    LEFT JOIN 
        decline_reason dr ON o.decline_reason_id = dr.declined_reason_id  -- Fixed join condition
    WHERE 
        o.new_apart_id IS NOT NULL  
    GROUP BY 
        o.offer_id,
        o.affair_id
)
SELECT 
    old_apart.affair_id, 
    old_apart.house_address,
    old_apart.apart_number,
    old_apart.district,
    old_apart.municipal_district,
    old_apart.fio,
    old_apart.full_living_area,
    old_apart.total_living_area,
    old_apart.living_area,
    old_apart.room_count,
    old_apart.type_of_settlement,
    old_apart.is_queue,
    JSONB_OBJECT_AGG(
        joined_aparts.offer_id::text,
        joined_aparts.new_apartments
        ORDER BY joined_aparts.offer_id
    ) FILTER (WHERE joined_aparts.offer_id IS NOT NULL) AS offers
FROM 
    old_apart  
LEFT JOIN 
    joined_aparts ON old_apart.affair_id = joined_aparts.affair_id
WHERE old_apart.affair_id = :apart_id
GROUP BY 
    old_apart.affair_id, 
    old_apart.house_address,
    old_apart.apart_number,
    old_apart.district,
    old_apart.municipal_district,
    old_apart.fio,
    old_apart.full_living_area,
    old_apart.total_living_area,
    old_apart.living_area,
    old_apart.room_count,
    old_apart.type_of_settlement,
    old_apart.is_queue;
